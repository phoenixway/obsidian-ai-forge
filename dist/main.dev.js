"use strict";

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

function _possibleConstructorReturn(self, call) { if (call && (_typeof(call) === "object" || typeof call === "function")) { return call; } return _assertThisInitialized(self); }

function _getPrototypeOf(o) { _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) { return o.__proto__ || Object.getPrototypeOf(o); }; return _getPrototypeOf(o); }

function _assertThisInitialized(self) { if (self === void 0) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function"); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } }); if (superClass) _setPrototypeOf(subClass, superClass); }

function _setPrototypeOf(o, p) { _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) { o.__proto__ = p; return o; }; return _setPrototypeOf(o, p); }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(source, true).forEach(function (key) { _defineProperty(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(source).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }

function _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;

var __export = function __export(target, all) {
  for (var name in all) {
    __defProp(target, name, {
      get: all[name],
      enumerable: true
    });
  }
};

var __copyProps = function __copyProps(to, from, except, desc) {
  if (from && _typeof(from) === "object" || typeof from === "function") {
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      var _loop = function _loop() {
        var key = _step.value;
        if (!__hasOwnProp.call(to, key) && key !== except) __defProp(to, key, {
          get: function get() {
            return from[key];
          },
          enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable
        });
      };

      for (var _iterator = __getOwnPropNames(from)[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        _loop();
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator["return"] != null) {
          _iterator["return"]();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }
  }

  return to;
};

var __toESM = function __toESM(mod, isNodeMode, target) {
  return target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps( // If the importer is in node compatibility mode or this is not an ESM
  // file that has been converted to a CommonJS file using a Babel-
  // compatible transform (i.e. "__esModule" has not been set), then set
  // "default" to the CommonJS "module.exports" for node compatibility.
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", {
    value: mod,
    enumerable: true
  }) : target, mod);
};

var __toCommonJS = function __toCommonJS(mod) {
  return __copyProps(__defProp({}, "__esModule", {
    value: true
  }), mod);
}; // main.ts


var main_exports = {};

__export(main_exports, {
  "default": function _default() {
    return OllamaPlugin;
  }
});

module.exports = __toCommonJS(main_exports);

var import_obsidian5 = require("obsidian"); // ollamaView.ts


var import_obsidian2 = require("obsidian"); // messageService.ts


var import_obsidian = require("obsidian");

var MessageService =
/*#__PURE__*/
function () {
  function MessageService(plugin) {
    _classCallCheck(this, MessageService);

    this.view = null;
    this.messages = [];
    this.isProcessing = false;
    this.messagesPairCount = 0;
    this.plugin = plugin;
  } // Set the view reference


  _createClass(MessageService, [{
    key: "setView",
    value: function setView(view) {
      this.view = view;
    } // Load message history from storage

  }, {
    key: "loadMessageHistory",
    value: function loadMessageHistory() {
      var history, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, msg, message;

      return regeneratorRuntime.async(function loadMessageHistory$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              if (this.view) {
                _context.next = 2;
                break;
              }

              return _context.abrupt("return");

            case 2:
              _context.prev = 2;
              _context.next = 5;
              return regeneratorRuntime.awrap(this.plugin.loadMessageHistory());

            case 5:
              history = _context.sent;

              if (!(Array.isArray(history) && history.length > 0)) {
                _context.next = 32;
                break;
              }

              this.messages = [];
              this.view.clearChatContainer();
              _iteratorNormalCompletion2 = true;
              _didIteratorError2 = false;
              _iteratorError2 = undefined;
              _context.prev = 12;

              for (_iterator2 = history[Symbol.iterator](); !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
                msg = _step2.value;
                message = _objectSpread({}, msg, {
                  timestamp: new Date(msg.timestamp)
                });
                this.messages.push(message);
                this.renderMessage(message);
              }

              _context.next = 20;
              break;

            case 16:
              _context.prev = 16;
              _context.t0 = _context["catch"](12);
              _didIteratorError2 = true;
              _iteratorError2 = _context.t0;

            case 20:
              _context.prev = 20;
              _context.prev = 21;

              if (!_iteratorNormalCompletion2 && _iterator2["return"] != null) {
                _iterator2["return"]();
              }

            case 23:
              _context.prev = 23;

              if (!_didIteratorError2) {
                _context.next = 26;
                break;
              }

              throw _iteratorError2;

            case 26:
              return _context.finish(23);

            case 27:
              return _context.finish(20);

            case 28:
              this.view.scrollToBottom();
              this.initializeThinkingBlocks();
              _context.next = 33;
              break;

            case 32:
              this.view.showEmptyState();

            case 33:
              _context.next = 39;
              break;

            case 35:
              _context.prev = 35;
              _context.t1 = _context["catch"](2);
              console.error("Error loading message history:", _context.t1);
              this.view.showEmptyState();

            case 39:
            case "end":
              return _context.stop();
          }
        }
      }, null, this, [[2, 35], [12, 16, 20, 28], [21,, 23, 27]]);
    } // Save message history to storage

  }, {
    key: "saveMessageHistory",
    value: function saveMessageHistory() {
      var serializedMessages;
      return regeneratorRuntime.async(function saveMessageHistory$(_context2) {
        while (1) {
          switch (_context2.prev = _context2.next) {
            case 0:
              if (!(this.messages.length === 0)) {
                _context2.next = 2;
                break;
              }

              return _context2.abrupt("return");

            case 2:
              _context2.prev = 2;
              serializedMessages = this.messages.map(function (msg) {
                return {
                  role: msg.role,
                  content: msg.content,
                  timestamp: msg.timestamp.toISOString()
                };
              });
              _context2.next = 6;
              return regeneratorRuntime.awrap(this.plugin.saveMessageHistory(JSON.stringify(serializedMessages)));

            case 6:
              _context2.next = 11;
              break;

            case 8:
              _context2.prev = 8;
              _context2.t0 = _context2["catch"](2);
              console.error("Error saving message history:", _context2.t0);

            case 11:
            case "end":
              return _context2.stop();
          }
        }
      }, null, this, [[2, 8]]);
    } // Send a message from the user to Ollama

  }, {
    key: "sendMessage",
    value: function sendMessage(content) {
      return regeneratorRuntime.async(function sendMessage$(_context3) {
        while (1) {
          switch (_context3.prev = _context3.next) {
            case 0:
              if (!(this.isProcessing || !content.trim() || !this.view)) {
                _context3.next = 2;
                break;
              }

              return _context3.abrupt("return");

            case 2:
              this.view.hideEmptyState();
              this.addMessage("user"
              /* USER */
              , content);
              this.view.clearInputField();
              _context3.next = 7;
              return regeneratorRuntime.awrap(this.processWithOllama(content));

            case 7:
            case "end":
              return _context3.stop();
          }
        }
      }, null, this);
    } // Add a message to the chat and render it

  }, {
    key: "addMessage",
    value: function addMessage(role, content) {
      var _this = this;

      var message = {
        role: role,
        content: content,
        timestamp: new Date()
      };
      this.messages.push(message);
      this.renderMessage(message);

      if (role === "assistant"
      /* ASSISTANT */
      && this.messages.length >= 2) {
        if (this.messages[this.messages.length - 2].role === "user"
        /* USER */
        ) {
            this.messagesPairCount++;
          }
      }

      this.saveMessageHistory();
      setTimeout(function () {
        if (_this.view) {
          _this.view.scrollToBottom();
        }
      }, 100);
    } // Reset the chat history

  }, {
    key: "clearChatMessages",
    value: function clearChatMessages() {
      this.messages = [];

      if (this.view) {
        this.view.clearChatContainer();
        this.view.showEmptyState();
      }
    } // Render a message in the chat container

  }, {
    key: "renderMessage",
    value: function renderMessage(message) {
      if (!this.view) return;
      var isUser = message.role === "user"
      /* USER */
      ;
      var isError = message.role === "error"
      /* ERROR */
      ;
      var isSystem = message.role === "system"
      /* SYSTEM */
      ;
      var isFirstInGroup = this.isFirstMessageInGroup(message);
      var isLastInGroup = this.isLastMessageInGroup(message);
      var messageGroup;
      var lastGroup = this.view.getChatContainer().lastElementChild;

      if (isFirstInGroup) {
        var groupClass = "message-group ";

        if (isUser) {
          groupClass += "user-message-group";
        } else if (isAssistant(message.role)) {
          groupClass += "ollama-message-group";
        } else if (isError) {
          groupClass += "error-message-group";
        } else if (isSystem) {
          groupClass += "system-message-group";
        }

        messageGroup = this.view.createGroupElement(groupClass);
      } else {
        messageGroup = lastGroup;
      }

      var messageClass = "message ";

      if (isUser) {
        messageClass += "user-message bubble user-bubble";
      } else if (isAssistant(message.role)) {
        messageClass += "ollama-message bubble ollama-bubble";
      } else if (isError) {
        messageClass += "error-message bubble error-bubble";
      } else if (isSystem) {
        messageClass += "system-message bubble system-bubble";
      }

      if (isLastInGroup) {
        if (isUser) {
          messageClass += " user-message-tail";
        } else if (isAssistant(message.role)) {
          messageClass += " ollama-message-tail";
        } else if (isError) {
          messageClass += " error-message-tail";
        } else if (isSystem) {
          messageClass += " system-message-tail";
        }
      }

      var messageEl = this.view.createMessageElement(messageGroup, messageClass);
      var contentContainer = this.view.createContentContainer(messageEl);
      var contentEl = this.view.createContentElement(contentContainer);

      if (isAssistant(message.role)) {
        var decodedContent = this.decodeHtmlEntities(message.content);
        var hasThinkingTags = message.content.includes("<think>") || decodedContent.includes("<think>");

        if (hasThinkingTags) {
          var contentToProcess = hasThinkingTags && !message.content.includes("<thing>") ? decodedContent : message.content;
          var processedContent = this.processThinkingTags(contentToProcess);
          contentEl.innerHTML = processedContent;
          this.addThinkingToggleListeners(contentEl);
        } else {
          this.renderMarkdown(message.content, contentEl);
        }
      } else if (isError) {
        var errorIconSpan = contentEl.createSpan({
          cls: "error-icon"
        });
        (0, import_obsidian.setIcon)(errorIconSpan, "alert-triangle");
        var messageSpan = contentEl.createSpan({
          cls: "error-message-text",
          text: message.content
        });
      } else if (isSystem) {
        var infoIconSpan = contentEl.createSpan({
          cls: "system-icon"
        });
        (0, import_obsidian.setIcon)(infoIconSpan, "info");

        var _messageSpan = contentEl.createSpan({
          cls: "system-message-text",
          text: message.content
        });
      } else {
        message.content.split("\n").forEach(function (line, index, array) {
          contentEl.createSpan({
            text: line
          });

          if (index < array.length - 1) {
            contentEl.createEl("br");
          }
        });
      }

      if (!isSystem) {
        var copyButton = this.createCopyButton(contentContainer, message);
      }

      if (isLastInGroup) {
        messageEl.createDiv({
          cls: "message-timestamp",
          text: this.formatTime(message.timestamp)
        });
      }
    } // Create a copy button for the message

  }, {
    key: "createCopyButton",
    value: function createCopyButton(container, message) {
      var copyButton = container.createEl("button", {
        cls: "copy-button",
        attr: {
          title: "Copy message"
        }
      });
      (0, import_obsidian.setIcon)(copyButton, "copy");
      copyButton.addEventListener("click", function () {
        var textToCopy = message.content;

        if (isAssistant(message.role) && textToCopy.includes("<think>")) {
          textToCopy = textToCopy.replace(/<think>[\s\S]*?<\/think>/g, "");
        }

        navigator.clipboard.writeText(textToCopy);
        copyButton.setText("Copied!");
        setTimeout(function () {
          copyButton.empty();
          (0, import_obsidian.setIcon)(copyButton, "copy");
        }, 2e3);
      });
      return copyButton;
    } // Process request with Ollama

  }, {
    key: "processWithOllama",
    value: function processWithOllama(content) {
      var _this2 = this;

      var loadingMessageEl;
      return regeneratorRuntime.async(function processWithOllama$(_context5) {
        while (1) {
          switch (_context5.prev = _context5.next) {
            case 0:
              if (this.view) {
                _context5.next = 2;
                break;
              }

              return _context5.abrupt("return");

            case 2:
              this.isProcessing = true;
              loadingMessageEl = this.view.addLoadingMessage();
              setTimeout(function _callee() {
                var isNewConversation, systemPromptInterval, useSystemPrompt, formattedPrompt, requestBody, systemPrompt, data, errorMessage;
                return regeneratorRuntime.async(function _callee$(_context4) {
                  while (1) {
                    switch (_context4.prev = _context4.next) {
                      case 0:
                        _context4.prev = 0;
                        isNewConversation = _this2.messages.length <= 1;
                        systemPromptInterval = _this2.plugin.settings.systemPromptInterval || 0;
                        useSystemPrompt = false;

                        if (systemPromptInterval === 0) {
                          useSystemPrompt = true;
                        } else if (systemPromptInterval > 0) {
                          useSystemPrompt = _this2.messagesPairCount % systemPromptInterval === 0;
                        }

                        _context4.next = 7;
                        return regeneratorRuntime.awrap(_this2.plugin.promptService.prepareFullPrompt(content, isNewConversation));

                      case 7:
                        formattedPrompt = _context4.sent;
                        requestBody = {
                          model: _this2.plugin.settings.modelName,
                          prompt: formattedPrompt,
                          stream: false,
                          temperature: _this2.plugin.settings.temperature || 0.2,
                          options: {
                            num_ctx: _this2.plugin.settings.contextWindow || 8192
                          }
                        };

                        if (useSystemPrompt) {
                          systemPrompt = _this2.plugin.promptService.getSystemPrompt();

                          if (systemPrompt) {
                            requestBody.system = systemPrompt;
                          }
                        }

                        _context4.next = 12;
                        return regeneratorRuntime.awrap(_this2.plugin.apiService.generateResponse(requestBody));

                      case 12:
                        data = _context4.sent;

                        _this2.removeLoadingMessage(loadingMessageEl);

                        _this2.addMessage("assistant"
                        /* ASSISTANT */
                        , data.response);

                        _this2.initializeThinkingBlocks();

                        _context4.next = 24;
                        break;

                      case 18:
                        _context4.prev = 18;
                        _context4.t0 = _context4["catch"](0);
                        console.error("Error processing request with Ollama:", _context4.t0);

                        _this2.removeLoadingMessage(loadingMessageEl);

                        errorMessage = _context4.t0 instanceof Error ? _context4.t0.message : "Unknown error occurred";

                        _this2.addMessage("error"
                        /* ERROR */
                        , "Connection error with Ollama: ".concat(errorMessage, ". Please check the settings and ensure the server is running."));

                      case 24:
                        _context4.prev = 24;
                        _this2.isProcessing = false;
                        return _context4.finish(24);

                      case 27:
                      case "end":
                        return _context4.stop();
                    }
                  }
                }, null, null, [[0, 18, 24, 27]]);
              }, 0);

            case 5:
            case "end":
              return _context5.stop();
          }
        }
      }, null, this);
    } // Add a system notification message

  }, {
    key: "addSystemMessage",
    value: function addSystemMessage(content) {
      this.addMessage("system"
      /* SYSTEM */
      , content);
    } // Helper methods

  }, {
    key: "removeLoadingMessage",
    value: function removeLoadingMessage(loadingMessageEl) {
      if (loadingMessageEl && loadingMessageEl.parentNode) {
        loadingMessageEl.parentNode.removeChild(loadingMessageEl);
      }
    }
  }, {
    key: "isFirstMessageInGroup",
    value: function isFirstMessageInGroup(message) {
      var index = this.messages.indexOf(message);
      if (index === 0) return true;
      var prevMessage = this.messages[index - 1];
      return prevMessage.role !== message.role;
    }
  }, {
    key: "isLastMessageInGroup",
    value: function isLastMessageInGroup(message) {
      var index = this.messages.indexOf(message);
      if (index === this.messages.length - 1) return true;
      var nextMessage = this.messages[index + 1];
      return nextMessage.role !== message.role;
    }
  }, {
    key: "formatTime",
    value: function formatTime(date) {
      return date.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      });
    }
  }, {
    key: "decodeHtmlEntities",
    value: function decodeHtmlEntities(text) {
      var textArea = document.createElement("textarea");
      textArea.innerHTML = text;
      return textArea.value;
    }
  }, {
    key: "renderMarkdown",
    value: function renderMarkdown(content, element) {
      if (!this.view) return;
      import_obsidian.MarkdownRenderer.renderMarkdown(content, element, "", this.view);
    }
  }, {
    key: "processThinkingTags",
    value: function processThinkingTags(content) {
      if (!content.includes("<think>")) {
        return content;
      }

      var parts = [];
      var currentPosition = 0;
      var thinkingRegex = /<think>([\s\S]*?)<\/think>/g;
      var match;

      while ((match = thinkingRegex.exec(content)) !== null) {
        if (match.index > currentPosition) {
          var textBefore = content.substring(currentPosition, match.index);
          parts.push(this.markdownToHtml(textBefore));
        }

        var thinkingContent = match[1];
        var foldableHtml = "\n          <div class=\"thinking-block\">\n            <div class=\"thinking-header\" data-fold-state=\"expanded\">\n              <div class=\"thinking-toggle\">\u25BC</div>\n              <div class=\"thinking-title\">Thinking</div>\n            </div>\n            <div class=\"thinking-content\">".concat(this.markdownToHtml(thinkingContent), "</div>\n          </div>\n        ");
        parts.push(foldableHtml);
        currentPosition = match.index + match[0].length;
      }

      if (currentPosition < content.length) {
        var textAfter = content.substring(currentPosition);
        parts.push(this.markdownToHtml(textAfter));
      }

      return parts.join("");
    }
  }, {
    key: "markdownToHtml",
    value: function markdownToHtml(markdown) {
      if (!markdown || markdown.trim() === "" || !this.view) return "";
      var tempDiv = document.createElement("div");
      import_obsidian.MarkdownRenderer.renderMarkdown(markdown, tempDiv, "", this.view);
      return tempDiv.innerHTML;
    }
  }, {
    key: "addThinkingToggleListeners",
    value: function addThinkingToggleListeners(contentEl) {
      var thinkingHeaders = contentEl.querySelectorAll(".thinking-header");
      thinkingHeaders.forEach(function (header) {
        header.addEventListener("click", function () {
          var content = header.nextElementSibling;
          var toggleIcon = header.querySelector(".thinking-toggle");
          if (!content || !toggleIcon) return;
          var isFolded = header.getAttribute("data-fold-state") === "folded";

          if (isFolded) {
            content.style.display = "block";
            toggleIcon.textContent = "\u25BC";
            header.setAttribute("data-fold-state", "expanded");
          } else {
            content.style.display = "none";
            toggleIcon.textContent = "\u25BA";
            header.setAttribute("data-fold-state", "folded");
          }
        });
      });
    }
  }, {
    key: "initializeThinkingBlocks",
    value: function initializeThinkingBlocks() {
      var _this3 = this;

      if (!this.view) return;
      setTimeout(function () {
        if (!_this3.view) return;

        var thinkingHeaders = _this3.view.getChatContainer().querySelectorAll(".thinking-header");

        thinkingHeaders.forEach(function (header) {
          var content = header.nextElementSibling;
          var toggleIcon = header.querySelector(".thinking-toggle");
          if (!content || !toggleIcon) return;
          content.style.display = "none";
          toggleIcon.textContent = "\u25BA";
          header.setAttribute("data-fold-state", "folded");
        });
      }, 100);
    }
  }]);

  return MessageService;
}();

function isAssistant(role) {
  return role === "assistant"
  /* ASSISTANT */
  ;
} // ollamaView.ts


var VIEW_TYPE_OLLAMA = "ollama-chat-view";

var _OllamaView =
/*#__PURE__*/
function (_import_obsidian2$Ite) {
  _inherits(_OllamaView, _import_obsidian2$Ite);

  function _OllamaView(leaf, plugin) {
    var _this4;

    _classCallCheck(this, _OllamaView);

    _this4 = _possibleConstructorReturn(this, _getPrototypeOf(_OllamaView).call(this, leaf));
    _this4.messages = [];
    _this4.isProcessing = false;
    _this4.historyLoaded = false;
    _this4.scrollTimeout = null;
    _this4.mediaRecorder = null;
    _this4.systemMessageInterval = 0;
    _this4.messagesPairCount = 0;
    _this4.emptyStateEl = null;
    _this4.plugin = plugin;

    if (_OllamaView.instance) {
      return _possibleConstructorReturn(_this4, _OllamaView.instance);
    }

    _OllamaView.instance = _assertThisInitialized(_this4);

    if (_this4.plugin.apiService) {
      _this4.plugin.apiService.setOllamaView(_assertThisInitialized(_this4));
    }

    _this4.mediaRecorder = null;

    try {
      var workerCode = "\nonmessage = async (event) => {\n    try {\n      const { apiKey, audioBlob, languageCode = 'uk-UA' } = event.data;\n      console.log(\"Worker received audioBlob:\", audioBlob);\n      \n      if (!apiKey || apiKey.trim() === '') {\n        postMessage({ error: true, message: 'Google API Key is not configured. Please add it in plugin settings.' });\n        return;\n      }\n\n      const url = \"https://speech.googleapis.com/v1/speech:recognize?key=\" + apiKey;\n      \n      const arrayBuffer = await audioBlob.arrayBuffer();\n      const base64Audio = btoa(\n        new Uint8Array(arrayBuffer).reduce(\n          (data, byte) => data + String.fromCharCode(byte), ''\n        )\n      );\n      \n      console.log(\"Audio converted to Base64\");\n  \n      const response = await fetch(url, {\n        method: 'POST',\n        body: JSON.stringify({\n          config: {\n            encoding: 'WEBM_OPUS',\n            sampleRateHertz: 48000,\n            languageCode: languageCode,\n            model: 'latest_long',\n            enableAutomaticPunctuation: true,\n          },\n          audio: {\n            content: base64Audio\n          },\n        }),\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n  \n      if (!response.ok) {\n        const errorData = await response.json();\n        console.error(\"API error details:\", errorData);\n        postMessage({ \n          error: true, \n          message: \"Error from Google Speech API: \" + (errorData.error?.message || response.status)\n        });\n        return;\n      }\n  \n      const data = await response.json();\n      console.log(\"Speech recognition data:\", data);\n      \n      if (data.results && data.results.length > 0) {\n        const transcript = data.results\n          .map(result => result.alternatives[0].transcript)\n          .join(' ')\n          .trim();\n        \n        postMessage(transcript);\n      } else {\n        postMessage({ error: true, message: 'No speech detected' });\n      }\n    } catch (error) {\n      console.error('Error in speech recognition:', error);\n      postMessage({ \n        error: true, \n        message: 'Error processing speech recognition: ' + error.message \n      });\n    }\n};\n  \nonerror = (event) => {\n  console.error('Worker error:', event);\n};\n";
      var workerBlob = new Blob([workerCode], {
        type: "application/javascript"
      });
      var workerUrl = URL.createObjectURL(workerBlob);
      _this4.speechWorker = new Worker(workerUrl);
    } catch (error) {
      console.error("Failed to initialize worker:", error);
    }

    _this4.speechWorker.onmessage = function (event) {
      var transcript = event.data;
      console.log("Received transcript from worker:", transcript);
      var cursorPosition = _this4.inputEl.selectionStart || 0;
      var currentValue = _this4.inputEl.value;
      var insertText = transcript;

      if (cursorPosition > 0 && currentValue.charAt(cursorPosition - 1) !== " " && insertText.charAt(0) !== " ") {
        insertText = " " + insertText;
      }

      var newValue = currentValue.substring(0, cursorPosition) + insertText + currentValue.substring(cursorPosition);
      _this4.inputEl.value = newValue;
      var newCursorPosition = cursorPosition + insertText.length;

      _this4.inputEl.setSelectionRange(newCursorPosition, newCursorPosition);

      _this4.inputEl.focus();
    };

    _this4.speechWorker.onerror = function (error) {
      console.error("Worker error:", error);
    };

    _this4.messageService = new MessageService(plugin);

    _this4.messageService.setView(_assertThisInitialized(_this4));

    return _this4;
  } // New methods to support MessageService


  _createClass(_OllamaView, [{
    key: "getChatContainer",
    value: function getChatContainer() {
      return this.chatContainer;
    }
  }, {
    key: "clearChatContainer",
    value: function clearChatContainer() {
      this.chatContainer.empty();
    }
  }, {
    key: "scrollToBottom",
    value: function scrollToBottom() {
      this.guaranteedScrollToBottom();
    }
  }, {
    key: "clearInputField",
    value: function clearInputField() {
      this.inputEl.value = "";
    }
  }, {
    key: "createGroupElement",
    value: function createGroupElement(className) {
      return this.chatContainer.createDiv({
        cls: className
      });
    }
  }, {
    key: "createMessageElement",
    value: function createMessageElement(parent, className) {
      return parent.createDiv({
        cls: className
      });
    }
  }, {
    key: "createContentContainer",
    value: function createContentContainer(parent) {
      return parent.createDiv({
        cls: "message-content-container"
      });
    }
  }, {
    key: "createContentElement",
    value: function createContentElement(parent) {
      return parent.createDiv({
        cls: "message-content"
      });
    }
  }, {
    key: "addLoadingMessage1",
    value: function addLoadingMessage1() {
      var messageGroup = this.chatContainer.createDiv({
        cls: "message-group ollama-message-group"
      });
      var messageEl = messageGroup.createDiv({
        cls: "message ollama-message ollama-message-tail"
      });
      var dotsContainer = messageEl.createDiv({
        cls: "thinking-dots"
      });

      for (var i = 0; i < 3; i++) {
        dotsContainer.createDiv({
          cls: "thinking-dot"
        });
      }

      this.guaranteedScrollToBottom();
      return messageGroup;
    }
  }, {
    key: "getViewType",
    value: function getViewType() {
      return VIEW_TYPE_OLLAMA;
    }
  }, {
    key: "getDisplayText",
    value: function getDisplayText() {
      return "Ollama Chat";
    }
  }, {
    key: "getIcon",
    value: function getIcon() {
      return "message-square";
    }
  }, {
    key: "onOpen",
    value: function onOpen() {
      var _this5 = this;

      var inputContainer, sendButton, voiceButton, menuButton, menuDropdown, resetOption, resetIcon, settingsOption, settingsIcon, closeMenu, removeListener;
      return regeneratorRuntime.async(function onOpen$(_context7) {
        while (1) {
          switch (_context7.prev = _context7.next) {
            case 0:
              this.chatContainerEl = this.contentEl.createDiv({
                cls: "ollama-container"
              });
              this.chatContainer = this.chatContainerEl.createDiv({
                cls: "ollama-chat-container"
              });
              inputContainer = this.chatContainerEl.createDiv({
                cls: "chat-input-container"
              });
              this.inputEl = inputContainer.createEl("textarea", {
                attr: {
                  placeholder: "Text to ".concat(this.plugin.settings.modelName, "...")
                }
              });
              sendButton = inputContainer.createEl("button", {
                cls: "send-button"
              });
              (0, import_obsidian2.setIcon)(sendButton, "send");
              voiceButton = inputContainer.createEl("button", {
                cls: "voice-button"
              });
              (0, import_obsidian2.setIcon)(voiceButton, "microphone");
              this.inputEl.addEventListener("keydown", function (e) {
                if (e.key === "Enter" && !e.shiftKey) {
                  e.preventDefault();

                  _this5.sendMessage();
                }
              });
              sendButton.addEventListener("click", function () {
                _this5.sendMessage();
              });
              voiceButton.addEventListener("click", function () {
                _this5.startVoiceRecognition();
              });
              menuButton = inputContainer.createEl("button", {
                cls: "menu-button"
              });
              (0, import_obsidian2.setIcon)(menuButton, "more-vertical");
              menuDropdown = inputContainer.createEl("div", {
                cls: "menu-dropdown"
              });
              menuDropdown.style.display = "none";
              resetOption = menuDropdown.createEl("div", {
                cls: "menu-option reset-option"
              });
              resetIcon = resetOption.createEl("span", {
                cls: "menu-option-icon"
              });
              (0, import_obsidian2.setIcon)(resetIcon, "refresh-ccw");
              resetOption.createEl("span", {
                cls: "menu-option-text",
                text: "Reset Conversation"
              });
              settingsOption = menuDropdown.createEl("div", {
                cls: "menu-option settings-option"
              });
              settingsIcon = settingsOption.createEl("span", {
                cls: "menu-option-icon"
              });
              (0, import_obsidian2.setIcon)(settingsIcon, "settings");
              settingsOption.createEl("span", {
                cls: "menu-option-text",
                text: "Settings"
              });
              menuButton.addEventListener("click", function (e) {
                e.stopPropagation();

                if (menuDropdown.style.display === "none") {
                  menuDropdown.style.display = "block";
                  setTimeout(function () {
                    document.addEventListener("click", closeMenu);
                  }, 0);
                } else {
                  closeMenu();
                }
              });

              closeMenu = function closeMenu() {
                menuDropdown.style.display = "none";
                document.removeEventListener("click", closeMenu);
              };

              resetOption.addEventListener("click", function () {
                _this5.plugin.apiService.resetState();

                _this5.clearChatMessages();

                setTimeout(function () {
                  _this5.inputEl.focus();
                }, 100);
                closeMenu();
              });
              settingsOption.addEventListener("click", function _callee2() {
                var setting;
                return regeneratorRuntime.async(function _callee2$(_context6) {
                  while (1) {
                    switch (_context6.prev = _context6.next) {
                      case 0:
                        setting = _this5.app.setting;
                        _context6.next = 3;
                        return regeneratorRuntime.awrap(setting.open());

                      case 3:
                        setting.openTabById("obsidian-ollama-duet");
                        closeMenu();

                      case 5:
                      case "end":
                        return _context6.stop();
                    }
                  }
                });
              });
              this.showEmptyState();
              removeListener = this.plugin.on("model-changed", function (modelName) {
                _this5.updateInputPlaceholder(modelName);

                _this5.plugin.messageService.addSystemMessage("Model changed to: ".concat(modelName));
              });
              this.register(function () {
                return removeListener();
              });

            case 30:
            case "end":
              return _context7.stop();
          }
        }
      }, null, this);
    }
  }, {
    key: "updateInputPlaceholder",
    value: function updateInputPlaceholder(modelName) {
      if (this.inputEl) {
        this.inputEl.placeholder = "Text to ".concat(modelName, "...");
      }
    }
  }, {
    key: "showEmptyState",
    value: function showEmptyState() {
      if (this.messages.length === 0 && !this.emptyStateEl) {
        this.emptyStateEl = this.chatContainer.createDiv({
          cls: "ollama-empty-state"
        });
        var messageEl = this.emptyStateEl.createDiv({
          cls: "empty-state-message",
          text: "No messages yet"
        });
        var tipEl = this.emptyStateEl.createDiv({
          cls: "empty-state-tip",
          text: "Type a message to start chatting with ".concat(this.plugin.settings.modelName)
        });
      }
    }
  }, {
    key: "hideEmptyState",
    value: function hideEmptyState() {
      if (this.emptyStateEl && this.emptyStateEl.parentNode) {
        this.emptyStateEl.remove();
        this.emptyStateEl = null;
      }
    }
  }, {
    key: "loadMessageHistory",
    value: function loadMessageHistory() {
      return regeneratorRuntime.async(function loadMessageHistory$(_context8) {
        while (1) {
          switch (_context8.prev = _context8.next) {
            case 0:
              this.messageService.loadMessageHistory();

            case 1:
            case "end":
              return _context8.stop();
          }
        }
      }, null, this);
    }
  }, {
    key: "saveMessageHistory",
    value: function saveMessageHistory() {
      var serializedMessages;
      return regeneratorRuntime.async(function saveMessageHistory$(_context9) {
        while (1) {
          switch (_context9.prev = _context9.next) {
            case 0:
              if (!(this.messages.length === 0)) {
                _context9.next = 2;
                break;
              }

              return _context9.abrupt("return");

            case 2:
              _context9.prev = 2;
              serializedMessages = this.messages.map(function (msg) {
                return {
                  role: msg.role,
                  content: msg.content,
                  timestamp: msg.timestamp.toISOString()
                };
              });
              _context9.next = 6;
              return regeneratorRuntime.awrap(this.plugin.saveMessageHistory(JSON.stringify(serializedMessages)));

            case 6:
              _context9.next = 11;
              break;

            case 8:
              _context9.prev = 8;
              _context9.t0 = _context9["catch"](2);
              console.error("Error saving message history:", _context9.t0);

            case 11:
            case "end":
              return _context9.stop();
          }
        }
      }, null, this, [[2, 8]]);
    }
  }, {
    key: "guaranteedScrollToBottom",
    value: function guaranteedScrollToBottom() {
      var _this6 = this;

      if (this.scrollTimeout) {
        clearTimeout(this.scrollTimeout);
      }

      requestAnimationFrame(function () {
        if (!_this6.chatContainer) return;
        _this6.chatContainer.scrollTop = _this6.chatContainer.scrollHeight;
      });
    }
  }, {
    key: "sendMessage",
    value: function sendMessage() {
      var content;
      return regeneratorRuntime.async(function sendMessage$(_context10) {
        while (1) {
          switch (_context10.prev = _context10.next) {
            case 0:
              content = this.inputEl.value.trim();

              if (content) {
                _context10.next = 3;
                break;
              }

              return _context10.abrupt("return");

            case 3:
              this.messageService.sendMessage(content);

            case 4:
            case "end":
              return _context10.stop();
          }
        }
      }, null, this);
    }
  }, {
    key: "addMessage",
    value: function addMessage(role, content) {
      var _this7 = this;

      var message = {
        role: role,
        content: content,
        timestamp: new Date()
      };
      this.messages.push(message);
      this.renderMessage(message);

      if (role === "assistant" && this.messages.length >= 2) {
        if (this.messages[this.messages.length - 2].role === "user") {
          this.messagesPairCount++;
        }
      }

      this.saveMessageHistory();
      setTimeout(function () {
        _this7.guaranteedScrollToBottom();
      }, 100);
    }
  }, {
    key: "processThinkingTags",
    value: function processThinkingTags(content) {
      if (!content.includes("<think>")) {
        return content;
      }

      var parts = [];
      var currentPosition = 0;
      var thinkingRegex = /<think>([\s\S]*?)<\/think>/g;
      var match;

      while ((match = thinkingRegex.exec(content)) !== null) {
        if (match.index > currentPosition) {
          var textBefore = content.substring(currentPosition, match.index);
          parts.push(this.markdownToHtml(textBefore));
        }

        var thinkingContent = match[1];
        var foldableHtml = "\n        <div class=\"thinking-block\">\n          <div class=\"thinking-header\" data-fold-state=\"expanded\">\n            <div class=\"thinking-toggle\">\u25BC</div>\n            <div class=\"thinking-title\">Thinking</div>\n          </div>\n          <div class=\"thinking-content\">".concat(this.markdownToHtml(thinkingContent), "</div>\n        </div>\n      ");
        parts.push(foldableHtml);
        currentPosition = match.index + match[0].length;
      }

      if (currentPosition < content.length) {
        var textAfter = content.substring(currentPosition);
        parts.push(this.markdownToHtml(textAfter));
      }

      return parts.join("");
    }
  }, {
    key: "markdownToHtml",
    value: function markdownToHtml(markdown) {
      if (!markdown || markdown.trim() === "") return "";
      var tempDiv = document.createElement("div");
      import_obsidian2.MarkdownRenderer.renderMarkdown(markdown, tempDiv, "", this);
      return tempDiv.innerHTML;
    }
  }, {
    key: "escapeHtml",
    value: function escapeHtml(unsafe) {
      return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
  }, {
    key: "addThinkingToggleListeners",
    value: function addThinkingToggleListeners(contentEl) {
      var thinkingHeaders = contentEl.querySelectorAll(".thinking-header");
      thinkingHeaders.forEach(function (header) {
        header.addEventListener("click", function () {
          var content = header.nextElementSibling;
          var toggleIcon = header.querySelector(".thinking-toggle");
          if (!content || !toggleIcon) return;
          var isFolded = header.getAttribute("data-fold-state") === "folded";

          if (isFolded) {
            content.style.display = "block";
            toggleIcon.textContent = "\u25BC";
            header.setAttribute("data-fold-state", "expanded");
          } else {
            content.style.display = "none";
            toggleIcon.textContent = "\u25BA";
            header.setAttribute("data-fold-state", "folded");
          }
        });
      });
    }
  }, {
    key: "hasThinkingTags",
    value: function hasThinkingTags(content) {
      var formats = ["<think>", "&lt;think&gt;", "<think ", "\\<think\\>", "%3Cthink%3E"];
      return formats.some(function (format) {
        return content.includes(format);
      });
    }
  }, {
    key: "addToggleAllButton",
    value: function addToggleAllButton(contentContainer, contentEl) {
      var toggleAllButton = contentContainer.createEl("button", {
        cls: "toggle-all-thinking-button",
        attr: {
          title: "\u0417\u0433\u043E\u0440\u043D\u0443\u0442\u0438/\u0440\u043E\u0437\u0433\u043E\u0440\u043D\u0443\u0442\u0438 \u0432\u0441\u0456 \u0431\u043B\u043E\u043A\u0438 thinking"
        }
      });
      toggleAllButton.textContent = "Toggle All Thinking";
      toggleAllButton.addEventListener("click", function () {
        var thinkingContents = contentEl.querySelectorAll(".thinking-content");
        var thinkingToggles = contentEl.querySelectorAll(".thinking-toggle");
        var allHidden = true;
        thinkingContents.forEach(function (content) {
          if (content.style.display !== "none") {
            allHidden = false;
          }
        });
        thinkingContents.forEach(function (content, index) {
          content.style.display = allHidden ? "block" : "none";
          thinkingToggles[index].textContent = allHidden ? "\u25BC" : "\u25BA";
        });
      });
    }
  }, {
    key: "renderMessage",
    value: function renderMessage(message) {
      var isUser = message.role === "user";
      var isFirstInGroup = this.isFirstMessageInGroup(message);
      var isLastInGroup = this.isLastMessageInGroup(message);
      var messageGroup;
      var lastGroup = this.chatContainer.lastElementChild;

      if (isFirstInGroup) {
        messageGroup = this.chatContainer.createDiv({
          cls: "message-group ".concat(isUser ? "user-message-group" : "ollama-message-group")
        });
      } else {
        messageGroup = lastGroup;
      }

      var messageEl = messageGroup.createDiv({
        cls: "message ".concat(isUser ? "user-message bubble user-bubble" : "ollama-message bubble ollama-bubble", " ").concat(isLastInGroup ? isUser ? "user-message-tail" : "ollama-message-tail" : "")
      });
      var contentContainer = messageEl.createDiv({
        cls: "message-content-container"
      });
      var contentEl = contentContainer.createDiv({
        cls: "message-content"
      });

      if (message.role === "assistant") {
        var decodedContent = this.decodeHtmlEntities(message.content);
        var hasThinkingTags = message.content.includes("<think>") || decodedContent.includes("<think>");

        if (hasThinkingTags) {
          var contentToProcess = hasThinkingTags && !message.content.includes("<thing>") ? decodedContent : message.content;
          var processedContent = this.processThinkingTags(contentToProcess);
          contentEl.innerHTML = processedContent;
          this.addThinkingToggleListeners(contentEl);
        } else {
          import_obsidian2.MarkdownRenderer.renderMarkdown(message.content, contentEl, "", this);
        }
      } else {
        message.content.split("\n").forEach(function (line, index, array) {
          contentEl.createSpan({
            text: line
          });

          if (index < array.length - 1) {
            contentEl.createEl("br");
          }
        });
      }

      var copyButton = contentContainer.createEl("button", {
        cls: "copy-button",
        attr: {
          title: "\u0421\u043A\u043E\u043F\u0456\u044E\u0432\u0430\u0442\u0438"
        }
      });
      (0, import_obsidian2.setIcon)(copyButton, "copy");
      copyButton.addEventListener("click", function () {
        var textToCopy = message.content;

        if (message.role === "assistant" && textToCopy.includes("<think>")) {
          textToCopy = textToCopy.replace(/<think>[\s\S]*?<\/think>/g, "");
        }

        navigator.clipboard.writeText(textToCopy);
        copyButton.setText("Copied!");
        setTimeout(function () {
          copyButton.empty();
          (0, import_obsidian2.setIcon)(copyButton, "copy");
        }, 2e3);
      });

      if (isLastInGroup) {
        messageEl.createDiv({
          cls: "message-timestamp",
          text: this.formatTime(message.timestamp)
        });
      }
    }
  }, {
    key: "isFirstMessageInGroup",
    value: function isFirstMessageInGroup(message) {
      var index = this.messages.indexOf(message);
      if (index === 0) return true;
      var prevMessage = this.messages[index - 1];
      return prevMessage.role !== message.role;
    }
  }, {
    key: "isLastMessageInGroup",
    value: function isLastMessageInGroup(message) {
      var index = this.messages.indexOf(message);
      if (index === this.messages.length - 1) return true;
      var nextMessage = this.messages[index + 1];
      return nextMessage.role !== message.role;
    }
  }, {
    key: "formatTime",
    value: function formatTime(date) {
      return date.toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      });
    }
  }, {
    key: "decodeHtmlEntities",
    value: function decodeHtmlEntities(text) {
      var textArea = document.createElement("textarea");
      textArea.innerHTML = text;
      return textArea.value;
    }
  }, {
    key: "detectThinkingTags",
    value: function detectThinkingTags(content) {
      var formats = [{
        name: "standard",
        regex: /<think>[\s\S]*?<\/think>/g
      }, {
        name: "escaped",
        regex: /&lt;think&gt;[\s\S]*?&lt;\/think&gt;/g
      }, {
        name: "backslash-escaped",
        regex: /\\<think\\>[\s\S]*?\\<\/think\\>/g
      }, {
        name: "url-encoded",
        regex: /%3Cthink%3E[\s\S]*?%3C\/think%3E/g
      }];

      for (var _i = 0, _formats = formats; _i < _formats.length; _i++) {
        var format = _formats[_i];

        if (format.regex.test(content)) {
          return {
            hasThinkingTags: true,
            format: format.name
          };
        }
      }

      return {
        hasThinkingTags: false,
        format: "none"
      };
    }
  }, {
    key: "processWithOllama",
    value: function processWithOllama(content) {
      var _this8 = this;

      var loadingMessageEl;
      return regeneratorRuntime.async(function processWithOllama$(_context12) {
        while (1) {
          switch (_context12.prev = _context12.next) {
            case 0:
              this.isProcessing = true;
              loadingMessageEl = this.addLoadingMessage();
              setTimeout(function _callee3() {
                var isNewConversation, systemPromptInterval, useSystemPrompt, formattedPrompt, requestBody, systemPrompt, data;
                return regeneratorRuntime.async(function _callee3$(_context11) {
                  while (1) {
                    switch (_context11.prev = _context11.next) {
                      case 0:
                        _context11.prev = 0;
                        isNewConversation = _this8.messages.length <= 1;
                        systemPromptInterval = _this8.plugin.settings.systemPromptInterval || 0;
                        useSystemPrompt = false;

                        if (systemPromptInterval === 0) {
                          useSystemPrompt = true;
                        } else if (systemPromptInterval > 0) {
                          useSystemPrompt = _this8.messagesPairCount % systemPromptInterval === 0;
                        }

                        _context11.next = 7;
                        return regeneratorRuntime.awrap(_this8.plugin.promptService.prepareFullPrompt(content, isNewConversation));

                      case 7:
                        formattedPrompt = _context11.sent;
                        requestBody = {
                          model: _this8.plugin.settings.modelName,
                          prompt: formattedPrompt,
                          stream: false,
                          temperature: _this8.plugin.settings.temperature || 0.2,
                          options: {
                            num_ctx: _this8.plugin.settings.contextWindow || 8192
                          }
                        };

                        if (useSystemPrompt) {
                          systemPrompt = _this8.plugin.promptService.getSystemPrompt();

                          if (systemPrompt) {
                            requestBody.system = systemPrompt;
                          }
                        }

                        _context11.next = 12;
                        return regeneratorRuntime.awrap(_this8.plugin.apiService.generateResponse(requestBody));

                      case 12:
                        data = _context11.sent;

                        if (loadingMessageEl && loadingMessageEl.parentNode) {
                          loadingMessageEl.parentNode.removeChild(loadingMessageEl);
                        }

                        _this8.addMessage("assistant", data.response);

                        _this8.initializeThinkingBlocks();

                        _context11.next = 23;
                        break;

                      case 18:
                        _context11.prev = 18;
                        _context11.t0 = _context11["catch"](0);
                        console.error("Error processing request with Ollama:", _context11.t0);

                        if (loadingMessageEl && loadingMessageEl.parentNode) {
                          loadingMessageEl.parentNode.removeChild(loadingMessageEl);
                        }

                        _this8.addMessage("assistant", "Connection error with Ollama. Please check the settings and ensure the server is running.");

                      case 23:
                        _context11.prev = 23;
                        _this8.isProcessing = false;
                        return _context11.finish(23);

                      case 26:
                      case "end":
                        return _context11.stop();
                    }
                  }
                }, null, null, [[0, 18, 23, 26]]);
              }, 0);

            case 3:
            case "end":
              return _context12.stop();
          }
        }
      }, null, this);
    }
  }, {
    key: "initializeThinkingBlocks",
    value: function initializeThinkingBlocks() {
      var _this9 = this;

      setTimeout(function () {
        var thinkingHeaders = _this9.chatContainer.querySelectorAll(".thinking-header");

        thinkingHeaders.forEach(function (header) {
          var content = header.nextElementSibling;
          var toggleIcon = header.querySelector(".thinking-toggle");
          if (!content || !toggleIcon) return;
          content.style.display = "none";
          toggleIcon.textContent = "\u25BA";
          header.setAttribute("data-fold-state", "folded");
        });
      }, 100);
    }
  }, {
    key: "addLoadingMessage",
    value: function addLoadingMessage() {
      var messageGroup = this.chatContainer.createDiv({
        cls: "message-group ollama-message-group"
      });
      var messageEl = messageGroup.createDiv({
        cls: "message ollama-message ollama-message-tail"
      });
      var dotsContainer = messageEl.createDiv({
        cls: "thinking-dots"
      });

      for (var i = 0; i < 3; i++) {
        dotsContainer.createDiv({
          cls: "thinking-dot"
        });
      }

      this.guaranteedScrollToBottom();
      return messageGroup;
    }
  }, {
    key: "clearChatMessages",
    value: function clearChatMessages() {
      return regeneratorRuntime.async(function clearChatMessages$(_context13) {
        while (1) {
          switch (_context13.prev = _context13.next) {
            case 0:
              this.messageService.clearChatMessages();

            case 1:
            case "end":
              return _context13.stop();
          }
        }
      }, null, this);
    }
  }, {
    key: "startVoiceRecognition",
    value: function startVoiceRecognition() {
      var _this10 = this;

      var voiceButton, stream, mediaRecorder, audioChunks;
      return regeneratorRuntime.async(function startVoiceRecognition$(_context14) {
        while (1) {
          switch (_context14.prev = _context14.next) {
            case 0:
              voiceButton = this.contentEl.querySelector(".voice-button");

              if (!(voiceButton == null ? void 0 : voiceButton.classList.contains("recording"))) {
                _context14.next = 4;
                break;
              }

              if (this.mediaRecorder && this.mediaRecorder.state === "recording") {
                this.mediaRecorder.stop();
              }

              return _context14.abrupt("return");

            case 4:
              _context14.prev = 4;
              _context14.next = 7;
              return regeneratorRuntime.awrap(navigator.mediaDevices.getUserMedia({
                audio: true
              }));

            case 7:
              stream = _context14.sent;
              mediaRecorder = new MediaRecorder(stream);
              this.mediaRecorder = mediaRecorder;
              audioChunks = [];
              voiceButton == null ? void 0 : voiceButton.classList.add("recording");

              mediaRecorder.ondataavailable = function (event) {
                if (event.data.size > 0) {
                  audioChunks.push(event.data);
                }
              };

              mediaRecorder.onstop = function () {
                console.log("Recording stopped, chunks:", audioChunks.length);
                voiceButton == null ? void 0 : voiceButton.classList.remove("recording");
                stream.getTracks().forEach(function (track) {
                  return track.stop();
                });

                _this10.updateInputPlaceholder(_this10.plugin.settings.modelName);

                if (audioChunks.length > 0) {
                  var audioBlob = new Blob(audioChunks, {
                    type: mediaRecorder.mimeType
                  });
                  console.log("Audio blob created, type:", mediaRecorder.mimeType, "size:", audioBlob.size);

                  if (_this10.speechWorker) {
                    _this10.speechWorker.postMessage({
                      apiKey: _this10.plugin.settings.googleApiKey,
                      audioBlob: audioBlob
                    });
                  }
                } else {
                  console.error("No audio data recorded");
                }
              };

              mediaRecorder.start(100);
              console.log("Recording started with mime type:", mediaRecorder.mimeType);
              this.inputEl.placeholder = "Record...";
              setTimeout(function () {
                if (mediaRecorder.state === "recording") {
                  mediaRecorder.stop();
                  console.log("Recording stopped after timeout");
                }
              }, 15e3);
              _context14.next = 24;
              break;

            case 20:
              _context14.prev = 20;
              _context14.t0 = _context14["catch"](4);
              console.error("Error accessing microphone:", _context14.t0);
              voiceButton == null ? void 0 : voiceButton.classList.remove("recording");

            case 24:
            case "end":
              return _context14.stop();
          }
        }
      }, null, this, [[4, 20]]);
    }
  }, {
    key: "setSystemMessageInterval",
    value: function setSystemMessageInterval(interval) {
      this.systemMessageInterval = interval;
    }
  }, {
    key: "onModelChanged",
    value: function onModelChanged(modelName) {
      this.updateInputPlaceholder(modelName);
    }
  }]);

  return _OllamaView;
}(import_obsidian2.ItemView);

var OllamaView = _OllamaView;
OllamaView.instance = null; // settings.ts

var import_obsidian3 = require("obsidian");

var DEFAULT_SETTINGS = {
  modelName: "mistral",
  ollamaServerUrl: "http://localhost:11434",
  logFileSizeLimit: 1024,
  saveMessageHistory: true,
  ragEnabled: false,
  ragFolderPath: "data",
  contextWindowSize: 5,
  googleApiKey: "",
  speechLanguage: "uk-UA",
  maxRecordingTime: 15,
  silenceDetection: true,
  followRole: true,
  useDefaultRoleDefinition: true,
  customRoleFilePath: "",
  systemPromptInterval: 0,
  temperature: 0.1,
  contextWindow: 8192
};

var OllamaSettingTab =
/*#__PURE__*/
function (_import_obsidian3$Plu) {
  _inherits(OllamaSettingTab, _import_obsidian3$Plu);

  function OllamaSettingTab(app, plugin) {
    var _this11;

    _classCallCheck(this, OllamaSettingTab);

    _this11 = _possibleConstructorReturn(this, _getPrototypeOf(OllamaSettingTab).call(this, app, plugin));
    _this11.plugin = plugin;
    return _this11;
  }

  _createClass(OllamaSettingTab, [{
    key: "getDisplayText",
    value: function getDisplayText() {
      return "Ollama";
    }
  }, {
    key: "getId",
    value: function getId() {
      return "ollama-plugin";
    }
  }, {
    key: "display",
    value: function display() {
      var _this12 = this;

      var containerEl, availableModels, selectedModel, modelSetting, dropdown;
      return regeneratorRuntime.async(function display$(_context34) {
        while (1) {
          switch (_context34.prev = _context34.next) {
            case 0:
              containerEl = this.containerEl;
              containerEl.empty();
              new import_obsidian3.Setting(containerEl).setName("Ollama Server URL").setDesc("IP address and port where Ollama is running (e.g. http://192.168.1.10:11434)").addText(function (text) {
                return text.setPlaceholder("http://localhost:11434").setValue(_this12.plugin.settings.ollamaServerUrl).onChange(function _callee4(value) {
                  return regeneratorRuntime.async(function _callee4$(_context15) {
                    while (1) {
                      switch (_context15.prev = _context15.next) {
                        case 0:
                          _this12.plugin.settings.ollamaServerUrl = value;
                          _context15.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context15.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("Server Connection").setDesc("Reconnect to local model server and refresh available models").addButton(function (button) {
                return button.setButtonText("Reconnect").setIcon("refresh-cw").onClick(function _callee5() {
                  var response;
                  return regeneratorRuntime.async(function _callee5$(_context16) {
                    while (1) {
                      switch (_context16.prev = _context16.next) {
                        case 0:
                          _context16.prev = 0;
                          new import_obsidian3.Notice("Connecting to Ollama server...");
                          _context16.next = 4;
                          return regeneratorRuntime.awrap(fetch("".concat(_this12.plugin.settings.ollamaServerUrl, "/api/tags"), {
                            method: "GET",
                            headers: {
                              "Content-Type": "application/json"
                            }
                          }));

                        case 4:
                          response = _context16.sent;

                          if (response.ok) {
                            new import_obsidian3.Notice("Successfully connected to Ollama server!");
                            containerEl.empty();

                            _this12.display();
                          } else {
                            new import_obsidian3.Notice("Failed to connect to Ollama server. Check the URL and ensure the server is running.");

                            _this12.plugin.apiService.emit("connection-error");
                          }

                          _context16.next = 12;
                          break;

                        case 8:
                          _context16.prev = 8;
                          _context16.t0 = _context16["catch"](0);
                          new import_obsidian3.Notice("Connection error. Please check the server URL and your network connection.");

                          _this12.plugin.apiService.emit("connection-error");

                        case 12:
                        case "end":
                          return _context16.stop();
                      }
                    }
                  }, null, null, [[0, 8]]);
                });
              });
              availableModels = [];
              _context34.prev = 5;
              _context34.next = 8;
              return regeneratorRuntime.awrap(this.plugin.apiService.getModels());

            case 8:
              availableModels = _context34.sent;
              _context34.next = 15;
              break;

            case 11:
              _context34.prev = 11;
              _context34.t0 = _context34["catch"](5);
              console.error("Error fetching available models:", _context34.t0);
              this.plugin.apiService.emit("connection-error");

            case 15:
              selectedModel = availableModels.includes(this.plugin.settings.modelName) ? this.plugin.settings.modelName : availableModels.length > 0 ? availableModels[0] : "";
              modelSetting = new import_obsidian3.Setting(containerEl).setName("Model Name").setDesc("Select the language model to use");
              dropdown = modelSetting.addDropdown(function (dropdown2) {
                var selectEl = dropdown2.selectEl;

                while (selectEl.firstChild) {
                  selectEl.removeChild(selectEl.firstChild);
                }

                availableModels.forEach(function (model) {
                  dropdown2.addOption(model, model);
                });

                if (availableModels.length === 0) {
                  dropdown2.addOption("", "No models available");
                }

                dropdown2.setValue(selectedModel);
                dropdown2.onChange(function _callee6(value) {
                  return regeneratorRuntime.async(function _callee6$(_context17) {
                    while (1) {
                      switch (_context17.prev = _context17.next) {
                        case 0:
                          _this12.plugin.settings.modelName = value;

                          _this12.plugin.emit("model-changed", value);

                          _context17.next = 4;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 4:
                        case "end":
                          return _context17.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("Save Message History").setDesc("Save chat message history between sessions").addToggle(function (toggle) {
                return toggle.setValue(_this12.plugin.settings.saveMessageHistory).onChange(function _callee7(value) {
                  return regeneratorRuntime.async(function _callee7$(_context18) {
                    while (1) {
                      switch (_context18.prev = _context18.next) {
                        case 0:
                          _this12.plugin.settings.saveMessageHistory = value;
                          _context18.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context18.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("Log File Size Limit").setDesc("Maximum size of message history log file in KB (1024 KB = 1 MB)").addSlider(function (slider) {
                return slider.setLimits(256, 10240, 256).setValue(_this12.plugin.settings.logFileSizeLimit).setDynamicTooltip().onChange(function _callee8(value) {
                  return regeneratorRuntime.async(function _callee8$(_context19) {
                    while (1) {
                      switch (_context19.prev = _context19.next) {
                        case 0:
                          _this12.plugin.settings.logFileSizeLimit = value;
                          _context19.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context19.stop();
                      }
                    }
                  });
                });
              }).addExtraButton(function (button) {
                return button.setIcon("reset").setTooltip("Reset to default (1024 KB)").onClick(function _callee9() {
                  return regeneratorRuntime.async(function _callee9$(_context20) {
                    while (1) {
                      switch (_context20.prev = _context20.next) {
                        case 0:
                          _this12.plugin.settings.logFileSizeLimit = DEFAULT_SETTINGS.logFileSizeLimit;
                          _context20.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                          _this12.display();

                        case 4:
                        case "end":
                          return _context20.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("Clear History").setDesc("Delete all chat history").addButton(function (button) {
                return button.setButtonText("Clear").onClick(function _callee10() {
                  return regeneratorRuntime.async(function _callee10$(_context21) {
                    while (1) {
                      switch (_context21.prev = _context21.next) {
                        case 0:
                          _context21.next = 2;
                          return regeneratorRuntime.awrap(_this12.plugin.clearMessageHistory());

                        case 2:
                          new import_obsidian3.Notice("Chat history cleared.");

                        case 3:
                        case "end":
                          return _context21.stop();
                      }
                    }
                  });
                });
              });
              containerEl.createEl("h3", {
                text: "Role Configuration"
              });
              new import_obsidian3.Setting(containerEl).setName("Enable Role Definition").setDesc("Make Ollama follow a defined role from a file").addToggle(function (toggle) {
                return toggle.setValue(_this12.plugin.settings.followRole).onChange(function _callee11(value) {
                  return regeneratorRuntime.async(function _callee11$(_context22) {
                    while (1) {
                      switch (_context22.prev = _context22.next) {
                        case 0:
                          _this12.plugin.settings.followRole = value;
                          _context22.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context22.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("Use Default Role Definition").setDesc("Use the default role definition file from the plugin folder").addToggle(function (toggle) {
                return toggle.setValue(_this12.plugin.settings.useDefaultRoleDefinition).onChange(function _callee12(value) {
                  return regeneratorRuntime.async(function _callee12$(_context23) {
                    while (1) {
                      switch (_context23.prev = _context23.next) {
                        case 0:
                          _this12.plugin.settings.useDefaultRoleDefinition = value;
                          _context23.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context23.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("Custom Role Definition Path").setDesc("Path to a custom role definition file (relative to vault root)").addText(function (text) {
                return text.setPlaceholder("folder/role.md").setValue(_this12.plugin.settings.customRoleFilePath).onChange(function _callee13(value) {
                  return regeneratorRuntime.async(function _callee13$(_context24) {
                    while (1) {
                      switch (_context24.prev = _context24.next) {
                        case 0:
                          _this12.plugin.settings.customRoleFilePath = value;
                          _context24.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context24.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("System Prompt Interval").setDesc("Number of message pairs between system prompt resends. 0 - with every request, negative - never send").addText(function (text) {
                return text.setValue(String(_this12.plugin.settings.systemPromptInterval || 0)).onChange(function _callee14(value) {
                  return regeneratorRuntime.async(function _callee14$(_context25) {
                    while (1) {
                      switch (_context25.prev = _context25.next) {
                        case 0:
                          _this12.plugin.settings.systemPromptInterval = parseInt(value) || 0;
                          _context25.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context25.stop();
                      }
                    }
                  });
                });
              });
              containerEl.createEl("h3", {
                text: "RAG Configuration"
              });
              new import_obsidian3.Setting(containerEl).setName("Enable RAG").setDesc("Use Retrieval Augmented Generation with your notes").addToggle(function (toggle) {
                return toggle.setValue(_this12.plugin.settings.ragEnabled).onChange(function _callee15(value) {
                  return regeneratorRuntime.async(function _callee15$(_context26) {
                    while (1) {
                      switch (_context26.prev = _context26.next) {
                        case 0:
                          _this12.plugin.settings.ragEnabled = value;
                          _context26.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context26.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("AI Assistant Path").setDesc("Path to the folder containing assistant settings. RAG documents will be loaded from 'data' subfolder (relative to vault root)").addText(function (text) {
                return text.setPlaceholder("").setValue(_this12.plugin.settings.ragFolderPath).onChange(function _callee16(value) {
                  return regeneratorRuntime.async(function _callee16$(_context27) {
                    while (1) {
                      switch (_context27.prev = _context27.next) {
                        case 0:
                          _this12.plugin.settings.ragFolderPath = value;
                          _context27.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context27.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("Context Window Size").setDesc("Number of relevant documents to include in context").addSlider(function (slider) {
                return slider.setLimits(1, 10, 1).setValue(_this12.plugin.settings.contextWindowSize).setDynamicTooltip().onChange(function _callee17(value) {
                  return regeneratorRuntime.async(function _callee17$(_context28) {
                    while (1) {
                      switch (_context28.prev = _context28.next) {
                        case 0:
                          _this12.plugin.settings.contextWindowSize = value;
                          _context28.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context28.stop();
                      }
                    }
                  });
                });
              });
              containerEl.createEl("h3", {
                text: "Speech Recognition"
              });
              new import_obsidian3.Setting(containerEl).setName("Google API Key").setDesc("API key for Google Speech-to-Text service").addText(function (text) {
                return text.setPlaceholder("Enter your Google API key").setValue(_this12.plugin.settings.googleApiKey).onChange(function _callee18(value) {
                  return regeneratorRuntime.async(function _callee18$(_context29) {
                    while (1) {
                      switch (_context29.prev = _context29.next) {
                        case 0:
                          _this12.plugin.settings.googleApiKey = value;
                          _context29.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context29.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("Speech Recognition Language").setDesc("Language code for Google Speech-to-Text (e.g., uk-UA, en-US, ru-RU)").addText(function (text) {
                return text.setPlaceholder("uk-UA").setValue(_this12.plugin.settings.speechLanguage).onChange(function _callee19(value) {
                  return regeneratorRuntime.async(function _callee19$(_context30) {
                    while (1) {
                      switch (_context30.prev = _context30.next) {
                        case 0:
                          _this12.plugin.settings.speechLanguage = value;
                          _context30.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context30.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("Maximum Recording Time").setDesc("Maximum time (in seconds) to record before automatically stopping").addSlider(function (slider) {
                return slider.setLimits(5, 60, 5).setValue(_this12.plugin.settings.maxRecordingTime).setDynamicTooltip().onChange(function _callee20(value) {
                  return regeneratorRuntime.async(function _callee20$(_context31) {
                    while (1) {
                      switch (_context31.prev = _context31.next) {
                        case 0:
                          _this12.plugin.settings.maxRecordingTime = value;
                          _context31.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context31.stop();
                      }
                    }
                  });
                });
              });
              containerEl.createEl("h3", {
                text: "Advanced Configuration"
              });
              new import_obsidian3.Setting(containerEl).setName("AI context window").setDesc("Model context window size (recommended > 8192)").addText(function (text) {
                return text.setValue(String(_this12.plugin.settings.contextWindow || 8192)).onChange(function _callee21(value) {
                  return regeneratorRuntime.async(function _callee21$(_context32) {
                    while (1) {
                      switch (_context32.prev = _context32.next) {
                        case 0:
                          _this12.plugin.settings.contextWindow = parseInt(value) || 8192;
                          _context32.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context32.stop();
                      }
                    }
                  });
                });
              });
              new import_obsidian3.Setting(containerEl).setName("Temperature").setDesc("Controls randomness in model responses (0.0-1.0)").addSlider(function (slider) {
                return slider.setLimits(0, 1, 0.1).setValue(_this12.plugin.settings.temperature).setDynamicTooltip().onChange(function _callee22(value) {
                  return regeneratorRuntime.async(function _callee22$(_context33) {
                    while (1) {
                      switch (_context33.prev = _context33.next) {
                        case 0:
                          _this12.plugin.settings.temperature = value;
                          _context33.next = 3;
                          return regeneratorRuntime.awrap(_this12.plugin.saveSettings());

                        case 3:
                        case "end":
                          return _context33.stop();
                      }
                    }
                  });
                });
              });

            case 37:
            case "end":
              return _context34.stop();
          }
        }
      }, null, this, [[5, 11]]);
    }
  }]);

  return OllamaSettingTab;
}(import_obsidian3.PluginSettingTab); // ragService.ts


var RagService =
/*#__PURE__*/
function () {
  function RagService(plugin) {
    _classCallCheck(this, RagService);

    this.documents = [];
    this.isIndexing = false;
    this.plugin = plugin;
  }
  /**
   * Index all markdown files in the specified folder path
   */


  _createClass(RagService, [{
    key: "indexDocuments",
    value: function indexDocuments() {
      var _a, _b, folderPath, vault, allFiles, files, _iteratorNormalCompletion3, _didIteratorError3, _iteratorError3, _iterator3, _step3, file, content;

      return regeneratorRuntime.async(function indexDocuments$(_context35) {
        while (1) {
          switch (_context35.prev = _context35.next) {
            case 0:
              if (!this.isIndexing) {
                _context35.next = 2;
                break;
              }

              return _context35.abrupt("return");

            case 2:
              this.isIndexing = true;
              _context35.prev = 3;
              folderPath = this.plugin.settings.ragFolderPath;
              vault = this.plugin.app.vault;
              console.log("AI Assistant path: \"".concat(folderPath, "\" (RAG documents will be loaded from 'data' subfolder)"));
              allFiles = vault.getFiles();
              console.log("Total files in vault: ".concat(allFiles.length));
              _context35.next = 11;
              return regeneratorRuntime.awrap(this.getMarkdownFiles(vault, folderPath));

            case 11:
              files = _context35.sent;
              console.log("Found ".concat(files.length, " markdown files from \"").concat(folderPath, "\""));
              console.log("Indexing ".concat(files.length, " markdown files from ").concat(folderPath));
              this.documents = [];
              _iteratorNormalCompletion3 = true;
              _didIteratorError3 = false;
              _iteratorError3 = undefined;
              _context35.prev = 18;
              _iterator3 = files[Symbol.iterator]();

            case 20:
              if (_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done) {
                _context35.next = 35;
                break;
              }

              file = _step3.value;
              _context35.prev = 22;
              _context35.next = 25;
              return regeneratorRuntime.awrap(vault.read(file));

            case 25:
              content = _context35.sent;
              this.documents.push({
                path: file.path,
                content: content,
                metadata: {
                  filename: file.name,
                  created: (_a = file.stat) == null ? void 0 : _a.ctime,
                  modified: (_b = file.stat) == null ? void 0 : _b.mtime
                }
              });
              _context35.next = 32;
              break;

            case 29:
              _context35.prev = 29;
              _context35.t0 = _context35["catch"](22);
              console.error("Error reading file ".concat(file.path, ":"), _context35.t0);

            case 32:
              _iteratorNormalCompletion3 = true;
              _context35.next = 20;
              break;

            case 35:
              _context35.next = 41;
              break;

            case 37:
              _context35.prev = 37;
              _context35.t1 = _context35["catch"](18);
              _didIteratorError3 = true;
              _iteratorError3 = _context35.t1;

            case 41:
              _context35.prev = 41;
              _context35.prev = 42;

              if (!_iteratorNormalCompletion3 && _iterator3["return"] != null) {
                _iterator3["return"]();
              }

            case 44:
              _context35.prev = 44;

              if (!_didIteratorError3) {
                _context35.next = 47;
                break;
              }

              throw _iteratorError3;

            case 47:
              return _context35.finish(44);

            case 48:
              return _context35.finish(41);

            case 49:
              console.log("Indexed ".concat(this.documents.length, " documents for RAG"));
              _context35.next = 55;
              break;

            case 52:
              _context35.prev = 52;
              _context35.t2 = _context35["catch"](3);
              console.error("Error indexing documents:", _context35.t2);

            case 55:
              _context35.prev = 55;
              this.isIndexing = false;
              return _context35.finish(55);

            case 58:
            case "end":
              return _context35.stop();
          }
        }
      }, null, this, [[3, 52, 55, 58], [18, 37, 41, 49], [22, 29], [42,, 44, 48]]);
    }
    /**
     * Get all markdown files in the specified folder path
     */

  }, {
    key: "getMarkdownFiles",
    value: function getMarkdownFiles(vault, folderPath) {
      var files, normalizedFolderPath, dataFolderPath, allFiles, _iteratorNormalCompletion4, _didIteratorError4, _iteratorError4, _iterator4, _step4, file;

      return regeneratorRuntime.async(function getMarkdownFiles$(_context36) {
        while (1) {
          switch (_context36.prev = _context36.next) {
            case 0:
              files = [];

              if (folderPath) {
                _context36.next = 3;
                break;
              }

              return _context36.abrupt("return", files);

            case 3:
              normalizedFolderPath = folderPath;

              if (!normalizedFolderPath.endsWith("/")) {
                normalizedFolderPath += "/";
              }

              dataFolderPath = normalizedFolderPath + "data/";
              console.log("Looking for markdown files in: \"".concat(dataFolderPath, "\""));
              allFiles = vault.getFiles();
              _iteratorNormalCompletion4 = true;
              _didIteratorError4 = false;
              _iteratorError4 = undefined;
              _context36.prev = 11;

              for (_iterator4 = allFiles[Symbol.iterator](); !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
                file = _step4.value;

                if (file.extension === "md" && file.path.startsWith(dataFolderPath)) {
                  console.log("Adding file: ".concat(file.path));
                  files.push(file);
                }
              }

              _context36.next = 19;
              break;

            case 15:
              _context36.prev = 15;
              _context36.t0 = _context36["catch"](11);
              _didIteratorError4 = true;
              _iteratorError4 = _context36.t0;

            case 19:
              _context36.prev = 19;
              _context36.prev = 20;

              if (!_iteratorNormalCompletion4 && _iterator4["return"] != null) {
                _iterator4["return"]();
              }

            case 22:
              _context36.prev = 22;

              if (!_didIteratorError4) {
                _context36.next = 25;
                break;
              }

              throw _iteratorError4;

            case 25:
              return _context36.finish(22);

            case 26:
              return _context36.finish(19);

            case 27:
              return _context36.abrupt("return", files);

            case 28:
            case "end":
              return _context36.stop();
          }
        }
      }, null, null, [[11, 15, 19, 27], [20,, 22, 26]]);
    }
    /**
     * Simple search implementation to find relevant documents for a query
     * Later this could be replaced with a more sophisticated vector search
     */

  }, {
    key: "findRelevantDocuments",
    value: function findRelevantDocuments(query) {
      var limit = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 5;

      if (!this.documents.length) {
        return [];
      }

      var scoredDocs = this.documents.map(function (doc) {
        var lowerContent = doc.content.toLowerCase();
        var lowerQuery = query.toLowerCase();
        var terms = lowerQuery.split(/\s+/);
        var score = 0;
        var _iteratorNormalCompletion5 = true;
        var _didIteratorError5 = false;
        var _iteratorError5 = undefined;

        try {
          for (var _iterator5 = terms[Symbol.iterator](), _step5; !(_iteratorNormalCompletion5 = (_step5 = _iterator5.next()).done); _iteratorNormalCompletion5 = true) {
            var term = _step5.value;

            if (term.length > 2) {
              var regex = new RegExp(term, "gi");
              var matches = lowerContent.match(regex);

              if (matches) {
                score += matches.length;
              }
            }
          }
        } catch (err) {
          _didIteratorError5 = true;
          _iteratorError5 = err;
        } finally {
          try {
            if (!_iteratorNormalCompletion5 && _iterator5["return"] != null) {
              _iterator5["return"]();
            }
          } finally {
            if (_didIteratorError5) {
              throw _iteratorError5;
            }
          }
        }

        return {
          doc: doc,
          score: score
        };
      });
      return scoredDocs.sort(function (a, b) {
        return b.score - a.score;
      }).slice(0, limit).map(function (item) {
        return item.doc;
      });
    }
    /**
     * Prepare context from relevant documents
     */

  }, {
    key: "prepareContext",
    value: function prepareContext(query) {
      if (!this.plugin.settings.ragEnabled || this.documents.length === 0) {
        return "";
      }

      var limit = this.plugin.settings.contextWindowSize;
      var relevantDocs = this.findRelevantDocuments(query, limit);

      if (relevantDocs.length === 0) {
        return "";
      }

      var context = "### Context:\n\n";
      relevantDocs.forEach(function (doc, index) {
        var _a;

        context += "Document ".concat(index + 1, " (").concat((_a = doc.metadata) == null ? void 0 : _a.filename, "):\n");
        var maxChars = 1500;
        var content = doc.content.length > maxChars ? doc.content.substring(0, maxChars) + "..." : doc.content;
        context += content + "\n\n";
      });
      context += "### End of context\n\n";
      return context;
    }
  }]);

  return RagService;
}(); // stateManager.ts


var StateManager =
/*#__PURE__*/
function () {
  function StateManager() {
    _classCallCheck(this, StateManager);

    this.state = {
      currentPhase: "next goal choosing",
      currentGoal: "Identify if there are any urgent tasks",
      userActivity: "talking with AI",
      hasUrgentTasks: "unknown",
      urgentTasksList: [],
      currentUrgentTask: null,
      planExists: "unknown",
      lastUpdateTime: new Date()
    };
  } // Singleton     


  _createClass(StateManager, [{
    key: "getState",
    //   
    value: function getState() {
      this.state.lastUpdateTime = new Date();
      return _objectSpread({}, this.state);
    } //  

  }, {
    key: "updateState",
    value: function updateState(newState) {
      this.state = _objectSpread({}, this.state, {}, newState, {
        lastUpdateTime: new Date()
      });
    } //      

  }, {
    key: "addUrgentTask",
    value: function addUrgentTask(task) {
      if (!this.state.urgentTasksList.includes(task)) {
        this.state.urgentTasksList.push(task);

        if (!this.state.currentUrgentTask && this.state.urgentTasksList.length > 0) {
          this.state.currentUrgentTask = this.state.urgentTasksList[0];
        }

        this.state.hasUrgentTasks = true;
      }
    } //        

  }, {
    key: "completeUrgentTask",
    value: function completeUrgentTask(task) {
      var index = this.state.urgentTasksList.indexOf(task);

      if (index !== -1) {
        this.state.urgentTasksList.splice(index, 1);

        if (this.state.urgentTasksList.length > 0) {
          this.state.currentUrgentTask = this.state.urgentTasksList[0];
        } else {
          this.state.currentUrgentTask = null;
          this.state.hasUrgentTasks = false;
        }
      }
    } //        

  }, {
    key: "getStateFormatted",
    value: function getStateFormatted() {
      var currentTime = new Date().toLocaleTimeString([], {
        hour: "2-digit",
        minute: "2-digit"
      });
      return "- **[day phase]** ".concat(this.state.currentPhase, "\n  - **[next goal]** ").concat(this.state.currentGoal, "\n  - **[user activity]** ").concat(this.state.userActivity, "\n  - **[AI time]** ").concat(currentTime);
    } //      

  }, {
    key: "processUserMessage",
    value: function processUserMessage(message) {} //     

  }, {
    key: "saveStateToStorage",
    value: function saveStateToStorage() {
      localStorage.setItem("assistantState", JSON.stringify(this.state));
    } //     

  }, {
    key: "loadStateFromStorage",
    value: function loadStateFromStorage() {
      var savedState = localStorage.getItem("assistantState");

      if (savedState) {
        try {
          var parsedState = JSON.parse(savedState);
          parsedState.lastUpdateTime = new Date(parsedState.lastUpdateTime);
          this.state = parsedState;
          return true;
        } catch (e) {
          console.error("Error parsing saved state:", e);
        }
      }

      return false;
    }
  }], [{
    key: "getInstance",
    value: function getInstance() {
      if (!StateManager.instance) {
        StateManager.instance = new StateManager();
      }

      return StateManager.instance;
    }
  }]);

  return StateManager;
}(); // promptService.ts


var import_obsidian4 = require("obsidian");

var path = __toESM(require("path"));

var PromptService =
/*#__PURE__*/
function () {
  // Reference to the plugin for accessing services
  function PromptService(plugin) {
    _classCallCheck(this, PromptService);

    this.systemPrompt = null;
    this.stateManager = StateManager.getInstance();
    this.plugin = plugin;
  }
  /**
   * Set plugin reference for accessing services
   */


  _createClass(PromptService, [{
    key: "setPlugin",
    value: function setPlugin(plugin) {
      this.plugin = plugin;
    }
    /**
     * Set system prompt to be used with each request
     */

  }, {
    key: "setSystemPrompt",
    value: function setSystemPrompt(prompt) {
      this.systemPrompt = prompt;
    }
    /**
     * Get system prompt if set
     */

  }, {
    key: "getSystemPrompt",
    value: function getSystemPrompt() {
      return this.systemPrompt;
    }
    /**
     * Format user prompt with necessary context and state information
     */

  }, {
    key: "formatPrompt",
    value: function formatPrompt(userInput) {
      var isNewConversation = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;
      this.stateManager.processUserMessage(userInput);

      if (isNewConversation) {
        return userInput;
      }

      return userInput;
    }
    /**
     * Enhance prompt with RAG context if available
     */

  }, {
    key: "enhanceWithRagContext",
    value: function enhanceWithRagContext(prompt, ragContext) {
      if (!ragContext) {
        return prompt;
      }

      return "Context information:\n".concat(ragContext, "\n\nUser message: ").concat(prompt);
    }
    /**
     * Prepare request body for model API call
     */

  }, {
    key: "prepareRequestBody",
    value: function prepareRequestBody(modelName, prompt) {
      var temperature = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 0.2;
      var requestBody = {
        model: modelName,
        prompt: prompt,
        stream: false,
        temperature: temperature
      };

      if (this.systemPrompt) {
        requestBody.system = this.systemPrompt;
      }

      return requestBody;
    }
    /**
     * Process response from language model
     */

  }, {
    key: "processModelResponse",
    value: function processModelResponse(response) {
      var textArea = document.createElement("textarea");
      textArea.innerHTML = response;
      var decodedResponse = textArea.value;
      return decodedResponse.includes("<think>") ? decodedResponse : response;
    }
    /**
     * Get default role definition from plugin folder
     */

  }, {
    key: "getDefaultRoleDefinition",
    value: function getDefaultRoleDefinition() {
      var pluginFolder, rolePath, fullPath, content, defaultContent, exists, currentTime;
      return regeneratorRuntime.async(function getDefaultRoleDefinition$(_context37) {
        while (1) {
          switch (_context37.prev = _context37.next) {
            case 0:
              if (this.plugin) {
                _context37.next = 2;
                break;
              }

              return _context37.abrupt("return", null);

            case 2:
              _context37.prev = 2;
              pluginFolder = this.plugin.manifest.dir;
              rolePath = "default-role.md";
              fullPath = path.join(pluginFolder, rolePath);
              _context37.prev = 6;
              _context37.next = 9;
              return regeneratorRuntime.awrap(this.plugin.app.vault.adapter.read(fullPath));

            case 9:
              content = _context37.sent;
              _context37.next = 34;
              break;

            case 12:
              _context37.prev = 12;
              _context37.t0 = _context37["catch"](6);
              console.log("Couldn't read file, attempting to create it");
              _context37.prev = 15;
              defaultContent = "# Default AI Role\n\nYou are a helpful assistant.";
              _context37.next = 19;
              return regeneratorRuntime.awrap(this.plugin.app.vault.adapter.exists(fullPath));

            case 19:
              exists = _context37.sent;

              if (exists) {
                _context37.next = 26;
                break;
              }

              _context37.next = 23;
              return regeneratorRuntime.awrap(this.plugin.app.vault.adapter.write(fullPath, defaultContent));

            case 23:
              content = defaultContent;
              _context37.next = 28;
              break;

            case 26:
              console.error("File exists but couldn't be read:", fullPath);
              return _context37.abrupt("return", null);

            case 28:
              _context37.next = 34;
              break;

            case 30:
              _context37.prev = 30;
              _context37.t1 = _context37["catch"](15);
              console.error("Error creating default role file:", _context37.t1);
              return _context37.abrupt("return", null);

            case 34:
              if (!content) {
                _context37.next = 38;
                break;
              }

              currentTime = new Date().toLocaleTimeString();
              content += "\nAI time is ".concat(currentTime, " now");
              return _context37.abrupt("return", content);

            case 38:
              return _context37.abrupt("return", null);

            case 41:
              _context37.prev = 41;
              _context37.t2 = _context37["catch"](2);
              console.error("Error handling default role definition:", _context37.t2);
              return _context37.abrupt("return", null);

            case 45:
            case "end":
              return _context37.stop();
          }
        }
      }, null, this, [[2, 41], [6, 12], [15, 30]]);
    }
    /**
     * Get custom role definition from specified path
     */

  }, {
    key: "getCustomRoleDefinition",
    value: function getCustomRoleDefinition() {
      var customPath, file, content, currentTime;
      return regeneratorRuntime.async(function getCustomRoleDefinition$(_context38) {
        while (1) {
          switch (_context38.prev = _context38.next) {
            case 0:
              if (!(!this.plugin || !this.plugin.settings.customRoleFilePath)) {
                _context38.next = 2;
                break;
              }

              return _context38.abrupt("return", null);

            case 2:
              _context38.prev = 2;
              customPath = this.plugin.settings.customRoleFilePath;
              file = this.plugin.app.vault.getAbstractFileByPath(customPath);

              if (!(file instanceof import_obsidian4.TFile)) {
                _context38.next = 12;
                break;
              }

              _context38.next = 8;
              return regeneratorRuntime.awrap(this.plugin.app.vault.read(file));

            case 8:
              content = _context38.sent;
              currentTime = new Date().toLocaleTimeString();
              content += "\nAI time is ".concat(currentTime, " now");
              return _context38.abrupt("return", content);

            case 12:
              return _context38.abrupt("return", null);

            case 15:
              _context38.prev = 15;
              _context38.t0 = _context38["catch"](2);
              console.error("Error reading custom role definition:", _context38.t0);
              return _context38.abrupt("return", null);

            case 19:
            case "end":
              return _context38.stop();
          }
        }
      }, null, this, [[2, 15]]);
    }
    /**
     * Get role definition based on settings
     */

  }, {
    key: "getRoleDefinition",
    value: function getRoleDefinition() {
      return regeneratorRuntime.async(function getRoleDefinition$(_context39) {
        while (1) {
          switch (_context39.prev = _context39.next) {
            case 0:
              if (!(!this.plugin || !this.plugin.settings.followRole)) {
                _context39.next = 2;
                break;
              }

              return _context39.abrupt("return", null);

            case 2:
              _context39.prev = 2;

              if (!this.plugin.settings.useDefaultRoleDefinition) {
                _context39.next = 9;
                break;
              }

              _context39.next = 6;
              return regeneratorRuntime.awrap(this.getDefaultRoleDefinition());

            case 6:
              return _context39.abrupt("return", _context39.sent);

            case 9:
              if (!this.plugin.settings.customRoleFilePath) {
                _context39.next = 13;
                break;
              }

              _context39.next = 12;
              return regeneratorRuntime.awrap(this.getCustomRoleDefinition());

            case 12:
              return _context39.abrupt("return", _context39.sent);

            case 13:
              return _context39.abrupt("return", null);

            case 16:
              _context39.prev = 16;
              _context39.t0 = _context39["catch"](2);
              console.error("Error reading role definition:", _context39.t0);
              return _context39.abrupt("return", null);

            case 20:
            case "end":
              return _context39.stop();
          }
        }
      }, null, this, [[2, 16]]);
    }
    /**
     * Prepare a complete prompt with all enhancements (RAG, role definition, etc.)
     */

  }, {
    key: "prepareFullPrompt",
    value: function prepareFullPrompt(content) {
      var isNewConversation,
          roleDefinition,
          formattedPrompt,
          ragContext,
          _args40 = arguments;
      return regeneratorRuntime.async(function prepareFullPrompt$(_context40) {
        while (1) {
          switch (_context40.prev = _context40.next) {
            case 0:
              isNewConversation = _args40.length > 1 && _args40[1] !== undefined ? _args40[1] : false;

              if (this.plugin) {
                _context40.next = 3;
                break;
              }

              return _context40.abrupt("return", this.formatPrompt(content, isNewConversation));

            case 3:
              _context40.prev = 3;
              _context40.next = 6;
              return regeneratorRuntime.awrap(this.getRoleDefinition());

            case 6:
              roleDefinition = _context40.sent;

              if (roleDefinition) {
                this.setSystemPrompt(roleDefinition);
              }

              _context40.next = 13;
              break;

            case 10:
              _context40.prev = 10;
              _context40.t0 = _context40["catch"](3);
              console.error("Error getting role definition:", _context40.t0);

            case 13:
              formattedPrompt = this.formatPrompt(content, isNewConversation);

              if (!(this.plugin.settings.ragEnabled && this.plugin.ragService)) {
                _context40.next = 26;
                break;
              }

              _context40.prev = 15;

              if (!(this.plugin.ragService.findRelevantDocuments("test").length === 0)) {
                _context40.next = 19;
                break;
              }

              _context40.next = 19;
              return regeneratorRuntime.awrap(this.plugin.ragService.indexDocuments());

            case 19:
              ragContext = this.plugin.ragService.prepareContext(content);

              if (ragContext) {
                formattedPrompt = this.enhanceWithRagContext(formattedPrompt, ragContext);
              }

              _context40.next = 26;
              break;

            case 23:
              _context40.prev = 23;
              _context40.t1 = _context40["catch"](15);
              console.error("Error processing RAG:", _context40.t1);

            case 26:
              return _context40.abrupt("return", formattedPrompt);

            case 27:
            case "end":
              return _context40.stop();
          }
        }
      }, null, this, [[3, 10], [15, 23]]);
    }
  }]);

  return PromptService;
}(); // apiServices.ts


var ApiService =
/*#__PURE__*/
function () {
  function ApiService(baseUrl, plugin) {
    _classCallCheck(this, ApiService);

    this.ollamaView = null;
    this.eventHandlers = {};
    this.baseUrl = baseUrl;
    this.stateManager = StateManager.getInstance();
    this.promptService = new PromptService(plugin);
    this.stateManager.loadStateFromStorage();
  }

  _createClass(ApiService, [{
    key: "on",
    value: function on(event, callback) {
      var _this13 = this;

      if (!this.eventHandlers[event]) {
        this.eventHandlers[event] = [];
      }

      this.eventHandlers[event].push(callback);
      return function () {
        _this13.eventHandlers[event] = _this13.eventHandlers[event].filter(function (handler) {
          return handler !== callback;
        });
      };
    }
  }, {
    key: "emit",
    value: function emit(event, data) {
      var handlers = this.eventHandlers[event];

      if (handlers) {
        handlers.forEach(function (handler) {
          return handler(data);
        });
      }
    }
  }, {
    key: "getPromptService",
    value: function getPromptService() {
      return this.promptService;
    }
  }, {
    key: "setOllamaView",
    value: function setOllamaView(view) {
      this.ollamaView = view;
    }
    /**
     * Set system prompt to be used with each request
     */

  }, {
    key: "setSystemPrompt",
    value: function setSystemPrompt(prompt) {
      this.promptService.setSystemPrompt(prompt);
    }
    /**
     * Set base URL for the API
     */

  }, {
    key: "setBaseUrl",
    value: function setBaseUrl(url) {
      this.baseUrl = url;
    }
    /**
     * Set plugin reference for prompt service
     */

  }, {
    key: "setPlugin",
    value: function setPlugin(plugin) {
      this.promptService.setPlugin(plugin);
    }
    /**
     * Generate response from Ollama
     */

  }, {
    key: "generateResponse",
    value: function generateResponse(requestBody) {
      var response, errorText, data;
      return regeneratorRuntime.async(function generateResponse$(_context41) {
        while (1) {
          switch (_context41.prev = _context41.next) {
            case 0:
              _context41.next = 2;
              return regeneratorRuntime.awrap(fetch("".concat(this.baseUrl, "/api/generate"), {
                method: "POST",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify(requestBody)
              }));

            case 2:
              response = _context41.sent;

              if (response.ok) {
                _context41.next = 8;
                break;
              }

              _context41.next = 6;
              return regeneratorRuntime.awrap(response.text());

            case 6:
              errorText = _context41.sent;
              throw new Error("HTTP error! Status: ".concat(response.status, ", ").concat(errorText));

            case 8:
              _context41.next = 10;
              return regeneratorRuntime.awrap(response.json());

            case 10:
              data = _context41.sent;
              data.response = this.promptService.processModelResponse(data.response);
              this.stateManager.saveStateToStorage();
              return _context41.abrupt("return", {
                model: requestBody.model,
                response: this.promptService.processModelResponse(data.response)
              });

            case 14:
            case "end":
              return _context41.stop();
          }
        }
      }, null, this);
    }
    /**
     * Get available models from Ollama
     */

  }, {
    key: "getModels",
    value: function getModels() {
      var response, data;
      return regeneratorRuntime.async(function getModels$(_context42) {
        while (1) {
          switch (_context42.prev = _context42.next) {
            case 0:
              _context42.prev = 0;
              _context42.next = 3;
              return regeneratorRuntime.awrap(fetch("".concat(this.baseUrl, "/api/tags"), {
                method: "GET",
                headers: {
                  "Content-Type": "application/json"
                }
              }));

            case 3:
              response = _context42.sent;

              if (response.ok) {
                _context42.next = 6;
                break;
              }

              throw new Error("HTTP error! Status: ".concat(response.status));

            case 6:
              _context42.next = 8;
              return regeneratorRuntime.awrap(response.json());

            case 8:
              data = _context42.sent;

              if (!Array.isArray(data.models)) {
                _context42.next = 11;
                break;
              }

              return _context42.abrupt("return", data.models.map(function (model) {
                return _typeof(model) === "object" ? model.name : model;
              }));

            case 11:
              return _context42.abrupt("return", []);

            case 14:
              _context42.prev = 14;
              _context42.t0 = _context42["catch"](0);
              console.error("Error fetching models:", _context42.t0);
              return _context42.abrupt("return", []);

            case 18:
            case "end":
              return _context42.stop();
          }
        }
      }, null, this, [[0, 14]]);
    }
    /**
     * Reset assistant state to initial values
     */

  }, {
    key: "resetState",
    value: function resetState() {
      var initialState = {
        currentPhase: "next goal choosing",
        currentGoal: "Identify if there are any urgent tasks",
        userActivity: "talking with AI",
        hasUrgentTasks: "unknown",
        urgentTasksList: [],
        currentUrgentTask: null,
        planExists: "unknown"
      };
      this.stateManager.updateState(initialState);
      this.stateManager.saveStateToStorage();

      if (this.ollamaView) {
        this.ollamaView.messagesPairCount = 0;
      }
    }
  }]);

  return ApiService;
}(); // main.ts


var OllamaPlugin =
/*#__PURE__*/
function (_import_obsidian5$Plu) {
  _inherits(OllamaPlugin, _import_obsidian5$Plu);

  function OllamaPlugin() {
    var _this14;

    _classCallCheck(this, OllamaPlugin);

    _this14 = _possibleConstructorReturn(this, _getPrototypeOf(OllamaPlugin).apply(this, arguments));
    _this14.view = null;
    _this14.eventHandlers = {};
    _this14.documents = [];
    _this14.embeddings = []; // Add debouncing to prevent excessive indexing

    _this14.indexUpdateTimeout = null;
    return _this14;
  }

  _createClass(OllamaPlugin, [{
    key: "on",
    value: function on(event, callback) {
      var _this15 = this;

      if (!this.eventHandlers[event]) {
        this.eventHandlers[event] = [];
      }

      this.eventHandlers[event].push(callback);
      return function () {
        _this15.eventHandlers[event] = _this15.eventHandlers[event].filter(function (handler) {
          return handler !== callback;
        });
      };
    }
  }, {
    key: "emit",
    value: function emit(event, data) {
      var handlers = this.eventHandlers[event];

      if (handlers) {
        handlers.forEach(function (handler) {
          return handler(data);
        });
      }
    }
  }, {
    key: "onload",
    value: function onload() {
      var _this16 = this;

      return regeneratorRuntime.async(function onload$(_context45) {
        while (1) {
          switch (_context45.prev = _context45.next) {
            case 0:
              console.log("Ollama Plugin Loaded!");
              _context45.next = 3;
              return regeneratorRuntime.awrap(this.loadSettings());

            case 3:
              this.apiService = new ApiService(this.settings.ollamaServerUrl);
              this.ragService = new RagService(this);
              this.promptService = new PromptService(this);
              this.messageService = new MessageService(this);
              this.registerView(VIEW_TYPE_OLLAMA, function (leaf) {
                _this16.view = new OllamaView(leaf, _this16);

                _this16.messageService.setView(_this16.view);

                return _this16.view;
              });
              this.addCommand({
                id: "change-model",
                name: "Change Ollama Model",
                callback: function callback() {
                  var newModel;
                  return regeneratorRuntime.async(function callback$(_context43) {
                    while (1) {
                      switch (_context43.prev = _context43.next) {
                        case 0:
                          newModel = "llama2:13b";
                          _this16.settings.modelName = newModel;
                          _context43.next = 4;
                          return regeneratorRuntime.awrap(_this16.saveSettings());

                        case 4:
                          _this16.emit("model-changed", newModel);

                        case 5:
                        case "end":
                          return _context43.stop();
                      }
                    }
                  });
                }
              });
              this.apiService.on("connection-error", function (error) {
                _this16.messageService.addMessage("error"
                /* ERROR */
                , "Failed to connect to Ollama: ".concat(error.message));
              });
              this.addRibbonIcon("message-square", "\u0412\u0456\u0434\u043A\u0440\u0438\u0442\u0438 Ollama", function () {
                _this16.activateView();
              });
              this.addCommand({
                id: "open-ollama-view",
                name: "\u0412\u0456\u0434\u043A\u0440\u0438\u0442\u0438 Ollama Chat",
                callback: function callback() {
                  _this16.activateView();
                }
              });
              this.addCommand({
                id: "index-rag-documents",
                name: "\u0406\u043D\u0434\u0435\u043A\u0441\u0443\u0432\u0430\u0442\u0438 \u0434\u043E\u043A\u0443\u043C\u0435\u043D\u0442\u0438 \u0434\u043B\u044F RAG",
                callback: function callback() {
                  return regeneratorRuntime.async(function callback$(_context44) {
                    while (1) {
                      switch (_context44.prev = _context44.next) {
                        case 0:
                          _context44.next = 2;
                          return regeneratorRuntime.awrap(_this16.ragService.indexDocuments());

                        case 2:
                        case "end":
                          return _context44.stop();
                      }
                    }
                  });
                }
              });
              this.settingTab = new OllamaSettingTab(this.app, this);
              this.addSettingTab(this.settingTab);
              this.app.workspace.onLayoutReady(function () {
                var existingLeaf = _this16.app.workspace.getLeavesOfType(VIEW_TYPE_OLLAMA)[0];

                if (!existingLeaf) {
                  _this16.activateView();
                } else {// console.log("Ollama view already exists, not creating a new one");
                }

                if (_this16.settings.ragEnabled) {
                  _this16.ragService.indexDocuments();
                }
              });
              this.registerEvent(this.app.vault.on("modify", function () {
                if (_this16.settings.ragEnabled) {
                  _this16.debounceIndexUpdate();
                }
              }));

            case 17:
            case "end":
              return _context45.stop();
          }
        }
      }, null, this);
    } // Update API service when settings change

  }, {
    key: "updateApiService",
    value: function updateApiService() {
      this.apiService.setBaseUrl(this.settings.ollamaServerUrl);
    }
  }, {
    key: "debounceIndexUpdate",
    value: function debounceIndexUpdate() {
      var _this17 = this;

      if (this.indexUpdateTimeout) {
        clearTimeout(this.indexUpdateTimeout);
      }

      this.indexUpdateTimeout = setTimeout(function () {
        _this17.ragService.indexDocuments();

        _this17.indexUpdateTimeout = null;
      }, 3e4);
    }
  }, {
    key: "activateView",
    value: function activateView() {
      var _a, workspace, leaf;

      return regeneratorRuntime.async(function activateView$(_context46) {
        while (1) {
          switch (_context46.prev = _context46.next) {
            case 0:
              workspace = this.app.workspace;
              leaf = workspace.getLeavesOfType(VIEW_TYPE_OLLAMA)[0];

              if (leaf) {
                _context46.next = 9;
                break;
              }

              console.log("Creating new Ollama view leaf");
              leaf = (_a = workspace.getRightLeaf(false)) != null ? _a : workspace.getLeaf();
              _context46.next = 7;
              return regeneratorRuntime.awrap(leaf.setViewState({
                type: VIEW_TYPE_OLLAMA,
                active: true
              }));

            case 7:
              _context46.next = 10;
              break;

            case 9:
              console.log("Ollama view leaf already exists");

            case 10:
              workspace.revealLeaf(leaf);

              if (this.view) {
                this.messageService.setView(this.view);
              }

              return _context46.abrupt("return", leaf);

            case 13:
            case "end":
              return _context46.stop();
          }
        }
      }, null, this);
    }
  }, {
    key: "loadSettings",
    value: function loadSettings() {
      return regeneratorRuntime.async(function loadSettings$(_context47) {
        while (1) {
          switch (_context47.prev = _context47.next) {
            case 0:
              _context47.t0 = Object;
              _context47.t1 = {};
              _context47.t2 = DEFAULT_SETTINGS;
              _context47.next = 5;
              return regeneratorRuntime.awrap(this.loadData());

            case 5:
              _context47.t3 = _context47.sent;
              this.settings = _context47.t0.assign.call(_context47.t0, _context47.t1, _context47.t2, _context47.t3);

            case 7:
            case "end":
              return _context47.stop();
          }
        }
      }, null, this);
    }
  }, {
    key: "saveSettings",
    value: function saveSettings() {
      return regeneratorRuntime.async(function saveSettings$(_context48) {
        while (1) {
          switch (_context48.prev = _context48.next) {
            case 0:
              _context48.next = 2;
              return regeneratorRuntime.awrap(this.saveData(this.settings));

            case 2:
              this.updateApiService();

            case 3:
            case "end":
              return _context48.stop();
          }
        }
      }, null, this);
    }
  }, {
    key: "getOllamaApiUrl",
    value: function getOllamaApiUrl() {
      return this.settings.ollamaServerUrl || DEFAULT_SETTINGS.ollamaServerUrl;
    } // Function to save message history

  }, {
    key: "saveMessageHistory",
    value: function saveMessageHistory(messages) {
      var basePath, logPath, adapter, fileExists, fileSize, stat, backupPath, existingData, existingMessages, newMessages, merged, allMessages, trimmedMessages;
      return regeneratorRuntime.async(function saveMessageHistory$(_context49) {
        while (1) {
          switch (_context49.prev = _context49.next) {
            case 0:
              if (this.settings.saveMessageHistory) {
                _context49.next = 2;
                break;
              }

              return _context49.abrupt("return");

            case 2:
              _context49.prev = 2;
              basePath = this.app.vault.configDir + "/plugins/obsidian-ollama-duet";
              logPath = basePath + "/chat_history.json";
              adapter = this.app.vault.adapter;
              _context49.next = 8;
              return regeneratorRuntime.awrap(adapter.exists(logPath));

            case 8:
              fileExists = _context49.sent;
              fileSize = 0;

              if (!fileExists) {
                _context49.next = 15;
                break;
              }

              _context49.next = 13;
              return regeneratorRuntime.awrap(adapter.stat(logPath));

            case 13:
              stat = _context49.sent;
              fileSize = (stat == null ? void 0 : stat.size) ? stat.size / 1024 : 0;

            case 15:
              if (!(fileSize > this.settings.logFileSizeLimit)) {
                _context49.next = 29;
                break;
              }

              if (!fileExists) {
                _context49.next = 25;
                break;
              }

              backupPath = logPath + ".backup";
              _context49.next = 20;
              return regeneratorRuntime.awrap(adapter.exists(backupPath));

            case 20:
              if (!_context49.sent) {
                _context49.next = 23;
                break;
              }

              _context49.next = 23;
              return regeneratorRuntime.awrap(adapter.remove(backupPath));

            case 23:
              _context49.next = 25;
              return regeneratorRuntime.awrap(adapter.copy(logPath, backupPath));

            case 25:
              _context49.next = 27;
              return regeneratorRuntime.awrap(adapter.write(logPath, messages));

            case 27:
              _context49.next = 58;
              break;

            case 29:
              if (fileExists) {
                _context49.next = 34;
                break;
              }

              _context49.next = 32;
              return regeneratorRuntime.awrap(adapter.write(logPath, messages));

            case 32:
              _context49.next = 58;
              break;

            case 34:
              _context49.next = 36;
              return regeneratorRuntime.awrap(adapter.read(logPath));

            case 36:
              existingData = _context49.sent;
              _context49.prev = 37;
              existingMessages = JSON.parse(existingData);
              newMessages = JSON.parse(messages);
              merged = JSON.stringify([].concat(_toConsumableArray(existingMessages), _toConsumableArray(newMessages)));

              if (!(merged.length / 1024 > this.settings.logFileSizeLimit)) {
                _context49.next = 49;
                break;
              }

              allMessages = [].concat(_toConsumableArray(existingMessages), _toConsumableArray(newMessages));
              trimmedMessages = allMessages;

              while (JSON.stringify(trimmedMessages).length / 1024 > this.settings.logFileSizeLimit) {
                trimmedMessages = trimmedMessages.slice(1);
              }

              _context49.next = 47;
              return regeneratorRuntime.awrap(adapter.write(logPath, JSON.stringify(trimmedMessages)));

            case 47:
              _context49.next = 51;
              break;

            case 49:
              _context49.next = 51;
              return regeneratorRuntime.awrap(adapter.write(logPath, merged));

            case 51:
              _context49.next = 58;
              break;

            case 53:
              _context49.prev = 53;
              _context49.t0 = _context49["catch"](37);
              console.error("Error parsing message history:", _context49.t0);
              _context49.next = 58;
              return regeneratorRuntime.awrap(adapter.write(logPath, messages));

            case 58:
              _context49.next = 63;
              break;

            case 60:
              _context49.prev = 60;
              _context49.t1 = _context49["catch"](2);
              console.error("Failed to save message history:", _context49.t1);

            case 63:
            case "end":
              return _context49.stop();
          }
        }
      }, null, this, [[2, 60], [37, 53]]);
    }
  }, {
    key: "loadMessageHistory",
    value: function loadMessageHistory() {
      var logPath, adapter, data;
      return regeneratorRuntime.async(function loadMessageHistory$(_context50) {
        while (1) {
          switch (_context50.prev = _context50.next) {
            case 0:
              if (this.settings.saveMessageHistory) {
                _context50.next = 2;
                break;
              }

              return _context50.abrupt("return", []);

            case 2:
              _context50.prev = 2;
              logPath = this.app.vault.configDir + "/plugins/obsidian-ollama-duet/chat_history.json";
              adapter = this.app.vault.adapter;
              _context50.next = 7;
              return regeneratorRuntime.awrap(adapter.exists(logPath));

            case 7:
              if (!_context50.sent) {
                _context50.next = 12;
                break;
              }

              _context50.next = 10;
              return regeneratorRuntime.awrap(adapter.read(logPath));

            case 10:
              data = _context50.sent;
              return _context50.abrupt("return", JSON.parse(data));

            case 12:
              _context50.next = 17;
              break;

            case 14:
              _context50.prev = 14;
              _context50.t0 = _context50["catch"](2);
              console.error("Failed to load message history:", _context50.t0);

            case 17:
              return _context50.abrupt("return", []);

            case 18:
            case "end":
              return _context50.stop();
          }
        }
      }, null, this, [[2, 14]]);
    }
  }, {
    key: "clearMessageHistory",
    value: function clearMessageHistory() {
      var logPath, adapter;
      return regeneratorRuntime.async(function clearMessageHistory$(_context51) {
        while (1) {
          switch (_context51.prev = _context51.next) {
            case 0:
              _context51.prev = 0;
              logPath = this.app.vault.configDir + "/plugins/obsidian-ollama-duet/chat_history.json";
              adapter = this.app.vault.adapter;
              _context51.next = 5;
              return regeneratorRuntime.awrap(adapter.exists(logPath));

            case 5:
              if (!_context51.sent) {
                _context51.next = 9;
                break;
              }

              _context51.next = 8;
              return regeneratorRuntime.awrap(adapter.remove(logPath));

            case 8:
              if (this.view) {
                this.view.clearChatMessages();
              }

            case 9:
              _context51.next = 14;
              break;

            case 11:
              _context51.prev = 11;
              _context51.t0 = _context51["catch"](0);
              console.error("Failed to clear message history:", _context51.t0);

            case 14:
            case "end":
              return _context51.stop();
          }
        }
      }, null, this, [[0, 11]]);
    }
  }]);

  return OllamaPlugin;
}(import_obsidian5.Plugin);