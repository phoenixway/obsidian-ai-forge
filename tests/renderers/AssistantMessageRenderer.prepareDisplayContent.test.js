// tests/renderers/AssistantMessageRenderer.prepareDisplayContent.test.ts
import { AssistantMessageRenderer } from '../../src/renderers/AssistantMessageRenderer';
import * as RendererUtils from '../../src/MessageRendererUtils';
// Мок для OllamaView
const mockParseAllTextualToolCalls = jest.fn();
const mockView = {
    parseAllTextualToolCalls: mockParseAllTextualToolCalls,
    plugin: {
        app: {
            vault: {
                getRoot: () => ({ path: "/" })
            }
        },
        settings: {
            fixBrokenEmojis: false // Приклад
        }
    }
}; // 'as any' для спрощення, в ідеалі - більш точний мок
// Мок для OllamaPlugin
const mockPluginLogger = {
    debug: jest.fn(), info: jest.fn(), warn: jest.fn(), error: jest.fn(),
};
const mockPlugin = {
    settings: { enableToolUse: true },
    logger: mockPluginLogger,
    app: mockView.plugin.app // Беремо app з моку view для консистентності
};
// Мокуємо RendererUtils
jest.mock('../../src/MessageRendererUtils', () => {
    const original = jest.requireActual('../../src/MessageRendererUtils');
    return Object.assign(Object.assign({}, original), { decodeHtmlEntities: jest.fn().mockImplementation((text) => text), detectThinkingTags: jest.fn().mockImplementation((text) => ({
            hasThinkingTags: false, contentWithoutTags: text, format: 'text'
        })), renderMarkdownContent: jest.fn().mockResolvedValue(undefined) });
});
describe('AssistantMessageRenderer.prepareDisplayContent', () => {
    // Базовий об'єкт тепер відповідає AssistantMessage
    const createTestMessage = (content, tool_calls) => ({
        role: "assistant", // Явно "assistant"
        content: content,
        timestamp: new Date(),
        tool_calls: tool_calls
    });
    beforeEach(() => {
        RendererUtils.decodeHtmlEntities.mockClear().mockImplementation((text) => text);
        RendererUtils.detectThinkingTags.mockClear().mockImplementation((text) => ({
            hasThinkingTags: false, contentWithoutTags: text, format: 'text'
        }));
        mockParseAllTextualToolCalls.mockClear();
        Object.values(mockPluginLogger).forEach(mockFn => mockFn.mockClear());
    });
    it('should return original content (after think stripping) if tool use is disabled', () => {
        const originalSettings = Object.assign({}, mockPlugin.settings);
        mockPlugin.settings.enableToolUse = false;
        const content = "<think>thinking</think><tool_call>{\"name\":\"test\"}</tool_call> Some text.";
        const message = createTestMessage(content);
        RendererUtils.detectThinkingTags.mockReturnValue({
            hasThinkingTags: true, contentWithoutTags: "<tool_call>{\"name\":\"test\"}</tool_call> Some text.", format: 'text'
        });
        const result = AssistantMessageRenderer.prepareDisplayContent(content, message, mockPlugin, mockView);
        expect(result).toBe("<tool_call>{\"name\":\"test\"}</tool_call> Some text.");
        mockPlugin.settings.enableToolUse = originalSettings.enableToolUse;
    });
    it('should return content without think tags if no tool indicators', () => {
        const content = "<think>Thinking...</think>Just a normal response.";
        const message = createTestMessage(content);
        RendererUtils.detectThinkingTags.mockReturnValue({
            hasThinkingTags: true, contentWithoutTags: "Just a normal response.", format: 'text'
        });
        mockParseAllTextualToolCalls.mockReturnValue([]);
        const result = AssistantMessageRenderer.prepareDisplayContent(content, message, mockPlugin, mockView);
        expect(result).toBe("Just a normal response.");
    });
    it('should replace single textual tool call and keep accompanying text', () => {
        const originalContent = "<think>Let me use a tool.</think><tool_call>{\"name\":\"listFiles\",\"arguments\":{}}</tool_call> Here are the files.";
        const contentWithoutThink = "<tool_call>{\"name\":\"listFiles\",\"arguments\":{}}</tool_call> Here are the files.";
        const message = createTestMessage(originalContent);
        RendererUtils.detectThinkingTags.mockReturnValue({
            hasThinkingTags: true, contentWithoutTags: contentWithoutThink, format: 'text'
        });
        mockParseAllTextualToolCalls.mockImplementation((text) => {
            if (text === contentWithoutThink) {
                return [{ name: "listFiles", arguments: {} }];
            }
            return [];
        });
        const expected = "( Using tool: listFiles... )\n\nHere are the files.";
        const result = AssistantMessageRenderer.prepareDisplayContent(originalContent, message, mockPlugin, mockView);
        expect(result).toBe(expected);
    });
    it('should display (Using tool...) if only textual tool call is present', () => {
        const originalContent = "<tool_call>{\"name\":\"readFile\",\"arguments\":{\"path\":\"file.txt\"}}</tool_call>";
        const message = createTestMessage(originalContent);
        RendererUtils.detectThinkingTags.mockReturnValue({
            hasThinkingTags: false, contentWithoutTags: originalContent, format: 'text'
        });
        mockParseAllTextualToolCalls.mockReturnValue([{ name: "readFile", arguments: { path: "file.txt" } }]);
        const expected = "( Using tool: readFile... )";
        const result = AssistantMessageRenderer.prepareDisplayContent(originalContent, message, mockPlugin, mockView);
        expect(result).toBe(expected);
    });
    it('should handle multiple textual tool calls correctly', () => {
        const originalContent = "<tool_call>{\"name\":\"tool1\"}</tool_call><tool_call>{\"name\":\"tool2\"}</tool_call>Some final text.";
        const message = createTestMessage(originalContent);
        RendererUtils.detectThinkingTags.mockReturnValue({
            hasThinkingTags: false, contentWithoutTags: originalContent, format: 'text'
        });
        mockParseAllTextualToolCalls.mockReturnValue([
            { name: "tool1", arguments: {} },
            { name: "tool2", arguments: {} }
        ]);
        const expected = "( Using tools: tool1, tool2... )\n\nSome final text.";
        const result = AssistantMessageRenderer.prepareDisplayContent(originalContent, message, mockPlugin, mockView);
        expect(result).toBe(expected);
    });
    it('should display (Attempting to use tool(s)...) if textual tags present but names not extracted', () => {
        const originalContent = "<think>Trying</think><tool_call>INVALID JSON</tool_call>Extra.";
        const contentWithoutThink = "<tool_call>INVALID JSON</tool_call>Extra.";
        const message = createTestMessage(originalContent);
        RendererUtils.detectThinkingTags.mockReturnValue({
            hasThinkingTags: true, contentWithoutTags: contentWithoutThink, format: 'text'
        });
        mockParseAllTextualToolCalls.mockReturnValue([]);
        const expected = "( Attempting to use tool(s)... )\n\nExtra.";
        const result = AssistantMessageRenderer.prepareDisplayContent(originalContent, message, mockPlugin, mockView);
        expect(result).toBe(expected);
        expect(mockPluginLogger.warn).toHaveBeenCalledWith(expect.stringContaining("Tool call indicators were present, but NO tool names were extracted. Displaying generic 'Attempting to use...' message."));
    });
    it('should correctly process native tool_calls with accompanying content', () => {
        const message = createTestMessage("<think>Let me think.</think>Okay, I need to use a tool.", [{ type: "function", id: "call1", function: { name: "getWeather", arguments: "{}" } }]);
        RendererUtils.detectThinkingTags.mockReturnValue({
            hasThinkingTags: true, contentWithoutTags: "Okay, I need to use a tool.", format: 'text'
        });
        mockParseAllTextualToolCalls.mockReturnValue([]);
        const expected = "( Using tool: getWeather... )\n\nOkay, I need to use a tool.";
        // message.content! - використовуємо non-null assertion, оскільки ми знаємо, що він є
        const result = AssistantMessageRenderer.prepareDisplayContent(message.content, message, mockPlugin, mockView);
        expect(result).toBe(expected);
    });
    it('should correctly process native tool_calls with empty string content', () => {
        const message = createTestMessage("", // Порожній рядок
        [{ type: "function", id: "call1", function: { name: "getSettings", arguments: "{}" } }]);
        RendererUtils.detectThinkingTags.mockImplementation((text) => ({
            hasThinkingTags: false, contentWithoutTags: text || "", format: 'text'
        }));
        mockParseAllTextualToolCalls.mockReturnValue([]);
        const expected = "( Using tool: getSettings... )";
        const result = AssistantMessageRenderer.prepareDisplayContent(message.content || "", message, mockPlugin, mockView);
        expect(result).toBe(expected);
    });
    // Тест для content: null (якщо ви дозволили content: string | null у типах)
    it('should correctly process native tool_calls with null content', () => {
        const message = createTestMessage("", // null
        [{ type: "function", id: "call1", function: { name: "getSettings", arguments: "{}" } }]);
        RendererUtils.detectThinkingTags.mockImplementation((text) => ({
            hasThinkingTags: false, contentWithoutTags: text || "", format: 'text' // text || "" дасть ""
        }));
        mockParseAllTextualToolCalls.mockReturnValue([]);
        const expected = "( Using tool: getSettings... )";
        const result = AssistantMessageRenderer.prepareDisplayContent(message.content || "", message, mockPlugin, mockView);
        expect(result).toBe(expected);
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLnByZXBhcmVEaXNwbGF5Q29udGVudC50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLnByZXBhcmVEaXNwbGF5Q29udGVudC50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLHlFQUF5RTtBQUV6RSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSw4Q0FBOEMsQ0FBQztBQUl4RixPQUFPLEtBQUssYUFBYSxNQUFNLGdDQUFnQyxDQUFDO0FBRWhFLHFCQUFxQjtBQUNyQixNQUFNLDRCQUE0QixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUMvQyxNQUFNLFFBQVEsR0FBRztJQUNmLHdCQUF3QixFQUFFLDRCQUE0QjtJQUN0RCxNQUFNLEVBQUU7UUFDSixHQUFHLEVBQUU7WUFDRCxLQUFLLEVBQUU7Z0JBQ0gsT0FBTyxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUMsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUM7YUFDakM7U0FDSjtRQUNELFFBQVEsRUFBRTtZQUNSLGVBQWUsRUFBRSxLQUFLLENBQUMsVUFBVTtTQUNsQztLQUNKO0NBQ21CLENBQUMsQ0FBQyxzREFBc0Q7QUFFOUUsdUJBQXVCO0FBQ3ZCLE1BQU0sZ0JBQWdCLEdBQUc7SUFDckIsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Q0FDdkUsQ0FBQztBQUNGLE1BQU0sVUFBVSxHQUFHO0lBQ2pCLFFBQVEsRUFBRSxFQUFFLGFBQWEsRUFBRSxJQUFJLEVBQUU7SUFDakMsTUFBTSxFQUFFLGdCQUFnQjtJQUN4QixHQUFHLEVBQUUsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFH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RCxNQUFNLFFBQVEsR0FBRyxnQ0FBZ0MsQ0FBQztRQUNsRCxNQUFNLE1BQU0sR0FBRyx3QkFBd0IsQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsT0FBTyxJQUFJLEVBQUUsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ3BILE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDaEMsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIHRlc3RzL3JlbmRlcmVycy9Bc3Npc3RhbnRNZXNzYWdlUmVuZGVyZXIucHJlcGFyZURpc3BsYXlDb250ZW50LnRlc3QudHNcblxuaW1wb3J0IHsgQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyIH0gZnJvbSAnLi4vLi4vc3JjL3JlbmRlcmVycy9Bc3Npc3RhbnRNZXNzYWdlUmVuZGVyZXInO1xuaW1wb3J0IHsgQXNzaXN0YW50TWVzc2FnZSwgVG9vbENhbGwsIE1lc3NhZ2VSb2xlIH0gZnJvbSAnLi4vLi4vc3JjL3R5cGVzJzsgLy8g0IbQvNC/0L7RgNGC0YPRlNC80L4gTWVzc2FnZVJvbGVcbmltcG9ydCB7IE9sbGFtYVZpZXcgfSBmcm9tICcuLi8uLi9zcmMvT2xsYW1hVmlldyc7XG5pbXBvcnQgT2xsYW1hUGx1Z2luIGZyb20gJy4uLy4uL3NyYy9tYWluJztcbmltcG9ydCAqIGFzIFJlbmRlcmVyVXRpbHMgZnJvbSAnLi4vLi4vc3JjL01lc3NhZ2VSZW5kZXJlclV0aWxzJztcblxuLy8g0JzQvtC6INC00LvRjyBPbGxhbWFWaWV3XG5jb25zdCBtb2NrUGFyc2VBbGxUZXh0dWFsVG9vbENhbGxzID0gamVzdC5mbigpO1xuY29uc3QgbW9ja1ZpZXcgPSB7XG4gIHBhcnNlQWxsVGV4dHVhbFRvb2xDYWxsczogbW9ja1BhcnNlQWxsVGV4dHVhbFRvb2xDYWxscyxcbiAgcGx1Z2luOiB7IC8vINCU0L7QtNCw0LzQviDQvNC+0LogcGx1Z2luINCy0YHQtdGA0LXQtNC40L3RliB2aWV3INC00LvRjyBSZW5kZXJlclV0aWxzLnJlbmRlck1hcmtkb3duQ29udGVudFxuICAgICAgYXBwOiB7XG4gICAgICAgICAgdmF1bHQ6IHtcbiAgICAgICAgICAgICAgZ2V0Um9vdDogKCkgPT4gKHsgcGF0aDogXCIvXCIgfSlcbiAgICAgICAgICB9XG4gICAgICB9LFxuICAgICAgc2V0dGluZ3M6IHsgLy8g0JTQvtC00LDQvNC+INC90LDQu9Cw0YjRgtGD0LLQsNC90L3RjyDQtNC70Y8gUmVuZGVyZXJVdGlscy5yZW5kZXJNYXJrZG93bkNvbnRlbnRcbiAgICAgICAgZml4QnJva2VuRW1vamlzOiBmYWxzZSAvLyDQn9GA0LjQutC70LDQtFxuICAgICAgfVxuICB9XG59IGFzIGFueSBhcyBPbGxhbWFWaWV3OyAvLyAnYXMgYW55JyDQtNC70Y8g0YHQv9GA0L7RidC10L3QvdGPLCDQsiDRltC00LXQsNC70ZYgLSDQsdGW0LvRjNGIINGC0L7Rh9C90LjQuSDQvNC+0LpcblxuLy8g0JzQvtC6INC00LvRjyBPbGxhbWFQbHVnaW5cbmNvbnN0IG1vY2tQbHVnaW5Mb2dnZXIgPSB7XG4gICAgZGVidWc6IGplc3QuZm4oKSwgaW5mbzogamVzdC5mbigpLCB3YXJuOiBqZXN0LmZuKCksIGVycm9yOiBqZXN0LmZuKCksXG59O1xuY29uc3QgbW9ja1BsdWdpbiA9IHtcbiAgc2V0dGluZ3M6IHsgZW5hYmxlVG9vbFVzZTogdHJ1ZSB9LFxuICBsb2dnZXI6IG1vY2tQbHVnaW5Mb2dnZXIsXG4gIGFwcDogbW9ja1ZpZXcucGx1Z2luLmFwcCAvLyDQkdC10YDQtdC80L4gYXBwINC3INC80L7QutGDIHZpZXcg0LTQu9GPINC60L7QvdGB0LjRgdGC0LXQvdGC0L3QvtGB0YLRllxufSBhcyBhbnkgYXMgT2xsYW1hUGx1Z2luO1xuXG4vLyDQnNC+0LrRg9GU0LzQviBSZW5kZXJlclV0aWxzXG5qZXN0Lm1vY2soJy4uLy4uL3NyYy9NZXNzYWdlUmVuZGVyZXJVdGlscycsICgpID0+IHtcbiAgICBjb25zdCBvcmlnaW5hbCA9IGplc3QucmVxdWlyZUFjdHVhbCgnLi4vLi4vc3JjL01lc3NhZ2VSZW5kZXJlclV0aWxzJyk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgLi4ub3JpZ2luYWwsXG4gICAgICAgIGRlY29kZUh0bWxFbnRpdGllczogamVzdC5mbigpLm1vY2tJbXBsZW1lbnRhdGlvbigodGV4dDogc3RyaW5nKSA9PiB0ZXh0KSxcbiAgICAgICAgZGV0ZWN0VGhpbmtpbmdUYWdzOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCh0ZXh0OiBzdHJpbmcpID0+ICh7XG4gICAgICAgICAgICBoYXNUaGlua2luZ1RhZ3M6IGZhbHNlLCBjb250ZW50V2l0aG91dFRhZ3M6IHRleHQsIGZvcm1hdDogJ3RleHQnXG4gICAgICAgIH0pKSxcbiAgICAgICAgcmVuZGVyTWFya2Rvd25Db250ZW50OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSwgLy8g0JzQvtC60YPRlNC80L4sINGJ0L7QsSDQvdC1INCy0LjQutC+0L3Rg9Cy0LDRgtC4INGA0LXQsNC70YzQvdC40Lkg0YDQtdC90LTQtdGA0LjQvdCzXG4gICAgfTtcbn0pO1xuXG5kZXNjcmliZSgnQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLnByZXBhcmVEaXNwbGF5Q29udGVudCcsICgpID0+IHtcbiAgLy8g0JHQsNC30L7QstC40Lkg0L7QsSfRlNC60YIg0YLQtdC/0LXRgCDQstGW0LTQv9C+0LLRltC00LDRlCBBc3Npc3RhbnRNZXNzYWdlXG4gIGNvbnN0IGNyZWF0ZVRlc3RNZXNzYWdlID0gKGNvbnRlbnQ6IHN0cmluZywgdG9vbF9jYWxscz86IFRvb2xDYWxsW10pOiBBc3Npc3RhbnRNZXNzYWdlID0+ICh7XG4gICAgcm9sZTogXCJhc3Npc3RhbnRcIiwgLy8g0K/QstC90L4gXCJhc3Npc3RhbnRcIlxuICAgIGNvbnRlbnQ6IGNvbnRlbnQsXG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgIHRvb2xfY2FsbHM6IHRvb2xfY2FsbHNcbiAgfSk7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgKFJlbmRlcmVyVXRpbHMuZGVjb2RlSHRtbEVudGl0aWVzIGFzIGplc3QuTW9jaykubW9ja0NsZWFyKCkubW9ja0ltcGxlbWVudGF0aW9uKCh0ZXh0OiBzdHJpbmcpID0+IHRleHQpO1xuICAgIChSZW5kZXJlclV0aWxzLmRldGVjdFRoaW5raW5nVGFncyBhcyBqZXN0Lk1vY2spLm1vY2tDbGVhcigpLm1vY2tJbXBsZW1lbnRhdGlvbigodGV4dDogc3RyaW5nKSA9PiAoe1xuICAgICAgICBoYXNUaGlua2luZ1RhZ3M6IGZhbHNlLCBjb250ZW50V2l0aG91dFRhZ3M6IHRleHQsIGZvcm1hdDogJ3RleHQnXG4gICAgfSkpO1xuICAgIG1vY2tQYXJzZUFsbFRleHR1YWxUb29sQ2FsbHMubW9ja0NsZWFyKCk7XG4gICAgT2JqZWN0LnZhbHVlcyhtb2NrUGx1Z2luTG9nZ2VyKS5mb3JFYWNoKG1vY2tGbiA9PiBtb2NrRm4ubW9ja0NsZWFyKCkpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiBvcmlnaW5hbCBjb250ZW50IChhZnRlciB0aGluayBzdHJpcHBpbmcpIGlmIHRvb2wgdXNlIGlzIGRpc2FibGVkJywgKCkgPT4ge1xuICAgIGNvbnN0IG9yaWdpbmFsU2V0dGluZ3MgPSB7IC4uLm1vY2tQbHVnaW4uc2V0dGluZ3MgfTtcbiAgICBtb2NrUGx1Z2luLnNldHRpbmdzLmVuYWJsZVRvb2xVc2UgPSBmYWxzZTtcbiAgICBjb25zdCBjb250ZW50ID0gXCI8dGhpbms+dGhpbmtpbmc8L3RoaW5rPjx0b29sX2NhbGw+e1xcXCJuYW1lXFxcIjpcXFwidGVzdFxcXCJ9PC90b29sX2NhbGw+IFNvbWUgdGV4dC5cIjtcbiAgICBjb25zdCBtZXNzYWdlID0gY3JlYXRlVGVzdE1lc3NhZ2UoY29udGVudCk7XG4gICAgXG4gICAgKFJlbmRlcmVyVXRpbHMuZGV0ZWN0VGhpbmtpbmdUYWdzIGFzIGplc3QuTW9jaykubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgaGFzVGhpbmtpbmdUYWdzOiB0cnVlLCBjb250ZW50V2l0aG91dFRhZ3M6IFwiPHRvb2xfY2FsbD57XFxcIm5hbWVcXFwiOlxcXCJ0ZXN0XFxcIn08L3Rvb2xfY2FsbD4gU29tZSB0ZXh0LlwiLCBmb3JtYXQ6ICd0ZXh0J1xuICAgIH0pO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLnByZXBhcmVEaXNwbGF5Q29udGVudChjb250ZW50LCBtZXNzYWdlLCBtb2NrUGx1Z2luLCBtb2NrVmlldyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9CZShcIjx0b29sX2NhbGw+e1xcXCJuYW1lXFxcIjpcXFwidGVzdFxcXCJ9PC90b29sX2NhbGw+IFNvbWUgdGV4dC5cIik7XG4gICAgbW9ja1BsdWdpbi5zZXR0aW5ncy5lbmFibGVUb29sVXNlID0gb3JpZ2luYWxTZXR0aW5ncy5lbmFibGVUb29sVXNlO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiBjb250ZW50IHdpdGhvdXQgdGhpbmsgdGFncyBpZiBubyB0b29sIGluZGljYXRvcnMnLCAoKSA9PiB7XG4gICAgY29uc3QgY29udGVudCA9IFwiPHRoaW5rPlRoaW5raW5nLi4uPC90aGluaz5KdXN0IGEgbm9ybWFsIHJlc3BvbnNlLlwiO1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBjcmVhdGVUZXN0TWVzc2FnZShjb250ZW50KTtcbiAgICAoUmVuZGVyZXJVdGlscy5kZXRlY3RUaGlua2luZ1RhZ3MgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICBoYXNUaGlua2luZ1RhZ3M6IHRydWUsIGNvbnRlbnRXaXRob3V0VGFnczogXCJKdXN0IGEgbm9ybWFsIHJlc3BvbnNlLlwiLCBmb3JtYXQ6ICd0ZXh0J1xuICAgIH0pO1xuICAgIG1vY2tQYXJzZUFsbFRleHR1YWxUb29sQ2FsbHMubW9ja1JldHVyblZhbHVlKFtdKTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IEFzc2lzdGFudE1lc3NhZ2VSZW5kZXJlci5wcmVwYXJlRGlzcGxheUNvbnRlbnQoY29udGVudCwgbWVzc2FnZSwgbW9ja1BsdWdpbiwgbW9ja1ZpZXcpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoXCJKdXN0IGEgbm9ybWFsIHJlc3BvbnNlLlwiKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCByZXBsYWNlIHNpbmdsZSB0ZXh0dWFsIHRvb2wgY2FsbCBhbmQga2VlcCBhY2NvbXBhbnlpbmcgdGV4dCcsICgpID0+IHtcbiAgICBjb25zdCBvcmlnaW5hbENvbnRlbnQgPSBcIjx0aGluaz5MZXQgbWUgdXNlIGEgdG9vbC48L3RoaW5rPjx0b29sX2NhbGw+e1xcXCJuYW1lXFxcIjpcXFwibGlzdEZpbGVzXFxcIixcXFwiYXJndW1lbnRzXFxcIjp7fX08L3Rvb2xfY2FsbD4gSGVyZSBhcmUgdGhlIGZpbGVzLlwiO1xuICAgIGNvbnN0IGNvbnRlbnRXaXRob3V0VGhpbmsgPSBcIjx0b29sX2NhbGw+e1xcXCJuYW1lXFxcIjpcXFwibGlzdEZpbGVzXFxcIixcXFwiYXJndW1lbnRzXFxcIjp7fX08L3Rvb2xfY2FsbD4gSGVyZSBhcmUgdGhlIGZpbGVzLlwiO1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBjcmVhdGVUZXN0TWVzc2FnZShvcmlnaW5hbENvbnRlbnQpO1xuXG4gICAgKFJlbmRlcmVyVXRpbHMuZGV0ZWN0VGhpbmtpbmdUYWdzIGFzIGplc3QuTW9jaykubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgaGFzVGhpbmtpbmdUYWdzOiB0cnVlLCBjb250ZW50V2l0aG91dFRhZ3M6IGNvbnRlbnRXaXRob3V0VGhpbmssIGZvcm1hdDogJ3RleHQnXG4gICAgfSk7XG4gICAgbW9ja1BhcnNlQWxsVGV4dHVhbFRvb2xDYWxscy5tb2NrSW1wbGVtZW50YXRpb24oKHRleHQ6IHN0cmluZykgPT4ge1xuICAgICAgICBpZiAodGV4dCA9PT0gY29udGVudFdpdGhvdXRUaGluaykgeyBcbiAgICAgICAgICAgIHJldHVybiBbeyBuYW1lOiBcImxpc3RGaWxlc1wiLCBhcmd1bWVudHM6IHt9IH1dO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbXTtcbiAgICB9KTtcblxuICAgIGNvbnN0IGV4cGVjdGVkID0gXCIoIFVzaW5nIHRvb2w6IGxpc3RGaWxlcy4uLiApXFxuXFxuSGVyZSBhcmUgdGhlIGZpbGVzLlwiO1xuICAgIGNvbnN0IHJlc3VsdCA9IEFzc2lzdGFudE1lc3NhZ2VSZW5kZXJlci5wcmVwYXJlRGlzcGxheUNvbnRlbnQob3JpZ2luYWxDb250ZW50LCBtZXNzYWdlLCBtb2NrUGx1Z2luLCBtb2NrVmlldyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9CZShleHBlY3RlZCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgZGlzcGxheSAoVXNpbmcgdG9vbC4uLikgaWYgb25seSB0ZXh0dWFsIHRvb2wgY2FsbCBpcyBwcmVzZW50JywgKCkgPT4ge1xuICAgIGNvbnN0IG9yaWdpbmFsQ29udGVudCA9IFwiPHRvb2xfY2FsbD57XFxcIm5hbWVcXFwiOlxcXCJyZWFkRmlsZVxcXCIsXFxcImFyZ3VtZW50c1xcXCI6e1xcXCJwYXRoXFxcIjpcXFwiZmlsZS50eHRcXFwifX08L3Rvb2xfY2FsbD5cIjtcbiAgICBjb25zdCBtZXNzYWdlID0gY3JlYXRlVGVzdE1lc3NhZ2Uob3JpZ2luYWxDb250ZW50KTtcblxuICAgIChSZW5kZXJlclV0aWxzLmRldGVjdFRoaW5raW5nVGFncyBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZSh7IFxuICAgICAgICBoYXNUaGlua2luZ1RhZ3M6IGZhbHNlLCBjb250ZW50V2l0aG91dFRhZ3M6IG9yaWdpbmFsQ29udGVudCwgZm9ybWF0OiAndGV4dCdcbiAgICB9KTtcbiAgICBtb2NrUGFyc2VBbGxUZXh0dWFsVG9vbENhbGxzLm1vY2tSZXR1cm5WYWx1ZShbeyBuYW1lOiBcInJlYWRGaWxlXCIsIGFyZ3VtZW50czogeyBwYXRoOiBcImZpbGUudHh0XCIgfSB9XSk7XG4gICAgXG4gICAgY29uc3QgZXhwZWN0ZWQgPSBcIiggVXNpbmcgdG9vbDogcmVhZEZpbGUuLi4gKVwiO1xuICAgIGNvbnN0IHJlc3VsdCA9IEFzc2lzdGFudE1lc3NhZ2VSZW5kZXJlci5wcmVwYXJlRGlzcGxheUNvbnRlbnQob3JpZ2luYWxDb250ZW50LCBtZXNzYWdlLCBtb2NrUGx1Z2luLCBtb2NrVmlldyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9CZShleHBlY3RlZCk7XG4gIH0pO1xuICBcbiAgaXQoJ3Nob3VsZCBoYW5kbGUgbXVsdGlwbGUgdGV4dHVhbCB0b29sIGNhbGxzIGNvcnJlY3RseScsICgpID0+IHtcbiAgICBjb25zdCBvcmlnaW5hbENvbnRlbnQgPSBcIjx0b29sX2NhbGw+e1xcXCJuYW1lXFxcIjpcXFwidG9vbDFcXFwifTwvdG9vbF9jYWxsPjx0b29sX2NhbGw+e1xcXCJuYW1lXFxcIjpcXFwidG9vbDJcXFwifTwvdG9vbF9jYWxsPlNvbWUgZmluYWwgdGV4dC5cIjtcbiAgICBjb25zdCBtZXNzYWdlID0gY3JlYXRlVGVzdE1lc3NhZ2Uob3JpZ2luYWxDb250ZW50KTtcbiAgICAoUmVuZGVyZXJVdGlscy5kZXRlY3RUaGlua2luZ1RhZ3MgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICBoYXNUaGlua2luZ1RhZ3M6IGZhbHNlLCBjb250ZW50V2l0aG91dFRhZ3M6IG9yaWdpbmFsQ29udGVudCwgZm9ybWF0OiAndGV4dCdcbiAgICB9KTtcbiAgICBtb2NrUGFyc2VBbGxUZXh0dWFsVG9vbENhbGxzLm1vY2tSZXR1cm5WYWx1ZShbXG4gICAgICAgIHsgbmFtZTogXCJ0b29sMVwiLCBhcmd1bWVudHM6IHt9IH0sXG4gICAgICAgIHsgbmFtZTogXCJ0b29sMlwiLCBhcmd1bWVudHM6IHt9IH1cbiAgICBdKTtcblxuICAgIGNvbnN0IGV4cGVjdGVkID0gXCIoIFVzaW5nIHRvb2xzOiB0b29sMSwgdG9vbDIuLi4gKVxcblxcblNvbWUgZmluYWwgdGV4dC5cIjtcbiAgICBjb25zdCByZXN1bHQgPSBBc3Npc3RhbnRNZXNzYWdlUmVuZGVyZXIucHJlcGFyZURpc3BsYXlDb250ZW50KG9yaWdpbmFsQ29udGVudCwgbWVzc2FnZSwgbW9ja1BsdWdpbiwgbW9ja1ZpZXcpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZXhwZWN0ZWQpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIGRpc3BsYXkgKEF0dGVtcHRpbmcgdG8gdXNlIHRvb2wocykuLi4pIGlmIHRleHR1YWwgdGFncyBwcmVzZW50IGJ1dCBuYW1lcyBub3QgZXh0cmFjdGVkJywgKCkgPT4ge1xuICAgIGNvbnN0IG9yaWdpbmFsQ29udGVudCA9IFwiPHRoaW5rPlRyeWluZzwvdGhpbms+PHRvb2xfY2FsbD5JTlZBTElEIEpTT048L3Rvb2xfY2FsbD5FeHRyYS5cIjtcbiAgICBjb25zdCBjb250ZW50V2l0aG91dFRoaW5rID0gXCI8dG9vbF9jYWxsPklOVkFMSUQgSlNPTjwvdG9vbF9jYWxsPkV4dHJhLlwiO1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBjcmVhdGVUZXN0TWVzc2FnZShvcmlnaW5hbENvbnRlbnQpO1xuXG4gICAgKFJlbmRlcmVyVXRpbHMuZGV0ZWN0VGhpbmtpbmdUYWdzIGFzIGplc3QuTW9jaykubW9ja1JldHVyblZhbHVlKHtcbiAgICAgICAgaGFzVGhpbmtpbmdUYWdzOiB0cnVlLCBjb250ZW50V2l0aG91dFRhZ3M6IGNvbnRlbnRXaXRob3V0VGhpbmssIGZvcm1hdDogJ3RleHQnXG4gICAgfSk7XG4gICAgbW9ja1BhcnNlQWxsVGV4dHVhbFRvb2xDYWxscy5tb2NrUmV0dXJuVmFsdWUoW10pOyBcbiAgICBcbiAgICBjb25zdCBleHBlY3RlZCA9IFwiKCBBdHRlbXB0aW5nIHRvIHVzZSB0b29sKHMpLi4uIClcXG5cXG5FeHRyYS5cIjtcbiAgICBjb25zdCByZXN1bHQgPSBBc3Npc3RhbnRNZXNzYWdlUmVuZGVyZXIucHJlcGFyZURpc3BsYXlDb250ZW50KG9yaWdpbmFsQ29udGVudCwgbWVzc2FnZSwgbW9ja1BsdWdpbiwgbW9ja1ZpZXcpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZXhwZWN0ZWQpO1xuICAgIGV4cGVjdChtb2NrUGx1Z2luTG9nZ2VyLndhcm4pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZyhcIlRvb2wgY2FsbCBpbmRpY2F0b3JzIHdlcmUgcHJlc2VudCwgYnV0IE5PIHRvb2wgbmFtZXMgd2VyZSBleHRyYWN0ZWQuIERpc3BsYXlpbmcgZ2VuZXJpYyAnQXR0ZW1wdGluZyB0byB1c2UuLi4nIG1lc3NhZ2UuXCIpXG4gICAgKTsgIH0pO1xuICBcbiAgaXQoJ3Nob3VsZCBjb3JyZWN0bHkgcHJvY2VzcyBuYXRpdmUgdG9vbF9jYWxscyB3aXRoIGFjY29tcGFueWluZyBjb250ZW50JywgKCkgPT4ge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBjcmVhdGVUZXN0TWVzc2FnZShcbiAgICAgICAgXCI8dGhpbms+TGV0IG1lIHRoaW5rLjwvdGhpbms+T2theSwgSSBuZWVkIHRvIHVzZSBhIHRvb2wuXCIsXG4gICAgICAgIFt7dHlwZTogXCJmdW5jdGlvblwiLCBpZDogXCJjYWxsMVwiLCBmdW5jdGlvbjoge25hbWU6IFwiZ2V0V2VhdGhlclwiLCBhcmd1bWVudHM6IFwie31cIn19IGFzIFRvb2xDYWxsXSBcbiAgICApO1xuICAgIChSZW5kZXJlclV0aWxzLmRldGVjdFRoaW5raW5nVGFncyBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICAgIGhhc1RoaW5raW5nVGFnczogdHJ1ZSwgY29udGVudFdpdGhvdXRUYWdzOiBcIk9rYXksIEkgbmVlZCB0byB1c2UgYSB0b29sLlwiLCBmb3JtYXQ6ICd0ZXh0J1xuICAgIH0pO1xuICAgIG1vY2tQYXJzZUFsbFRleHR1YWxUb29sQ2FsbHMubW9ja1JldHVyblZhbHVlKFtdKTsgXG5cbiAgICBjb25zdCBleHBlY3RlZCA9IFwiKCBVc2luZyB0b29sOiBnZXRXZWF0aGVyLi4uIClcXG5cXG5Pa2F5LCBJIG5lZWQgdG8gdXNlIGEgdG9vbC5cIjtcbiAgICAvLyBtZXNzYWdlLmNvbnRlbnQhIC0g0LLQuNC60L7RgNC40YHRgtC+0LLRg9GU0LzQviBub24tbnVsbCBhc3NlcnRpb24sINC+0YHQutGW0LvRjNC60Lgg0LzQuCDQt9C90LDRlNC80L4sINGJ0L4g0LLRltC9INGUXG4gICAgY29uc3QgcmVzdWx0ID0gQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLnByZXBhcmVEaXNwbGF5Q29udGVudChtZXNzYWdlLmNvbnRlbnQhLCBtZXNzYWdlLCBtb2NrUGx1Z2luLCBtb2NrVmlldyk7XG4gICAgZXhwZWN0KHJlc3VsdCkudG9CZShleHBlY3RlZCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgY29ycmVjdGx5IHByb2Nlc3MgbmF0aXZlIHRvb2xfY2FsbHMgd2l0aCBlbXB0eSBzdHJpbmcgY29udGVudCcsICgpID0+IHtcbiAgICBjb25zdCBtZXNzYWdlID0gY3JlYXRlVGVzdE1lc3NhZ2UoXG4gICAgICAgIFwiXCIsIC8vINCf0L7RgNC+0LbQvdGW0Lkg0YDRj9C00L7QulxuICAgICAgICBbe3R5cGU6IFwiZnVuY3Rpb25cIiwgaWQ6IFwiY2FsbDFcIiwgZnVuY3Rpb246IHtuYW1lOiBcImdldFNldHRpbmdzXCIsIGFyZ3VtZW50czogXCJ7fVwifX0gYXMgVG9vbENhbGxdIFxuICAgICk7XG4gICAgKFJlbmRlcmVyVXRpbHMuZGV0ZWN0VGhpbmtpbmdUYWdzIGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uKCh0ZXh0OiBzdHJpbmcpID0+ICh7XG4gICAgICAgIGhhc1RoaW5raW5nVGFnczogZmFsc2UsIGNvbnRlbnRXaXRob3V0VGFnczogdGV4dCB8fCBcIlwiLCBmb3JtYXQ6ICd0ZXh0J1xuICAgIH0pKTtcbiAgICBtb2NrUGFyc2VBbGxUZXh0dWFsVG9vbENhbGxzLm1vY2tSZXR1cm5WYWx1ZShbXSk7XG5cbiAgICBjb25zdCBleHBlY3RlZCA9IFwiKCBVc2luZyB0b29sOiBnZXRTZXR0aW5ncy4uLiApXCI7XG4gICAgY29uc3QgcmVzdWx0ID0gQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLnByZXBhcmVEaXNwbGF5Q29udGVudChtZXNzYWdlLmNvbnRlbnQgfHwgXCJcIiwgbWVzc2FnZSwgbW9ja1BsdWdpbiwgbW9ja1ZpZXcpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZXhwZWN0ZWQpO1xuICB9KTtcblxuICAvLyDQotC10YHRgiDQtNC70Y8gY29udGVudDogbnVsbCAo0Y/QutGJ0L4g0LLQuCDQtNC+0LfQstC+0LvQuNC70LggY29udGVudDogc3RyaW5nIHwgbnVsbCDRgyDRgtC40L/QsNGFKVxuICBpdCgnc2hvdWxkIGNvcnJlY3RseSBwcm9jZXNzIG5hdGl2ZSB0b29sX2NhbGxzIHdpdGggbnVsbCBjb250ZW50JywgKCkgPT4ge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBjcmVhdGVUZXN0TWVzc2FnZShcbiAgICAgICAgXCJcIiwgLy8gbnVsbFxuICAgICAgICBbe3R5cGU6IFwiZnVuY3Rpb25cIiwgaWQ6IFwiY2FsbDFcIiwgZnVuY3Rpb246IHtuYW1lOiBcImdldFNldHRpbmdzXCIsIGFyZ3VtZW50czogXCJ7fVwifX0gYXMgVG9vbENhbGxdIFxuICAgICk7XG4gICAgIChSZW5kZXJlclV0aWxzLmRldGVjdFRoaW5raW5nVGFncyBhcyBqZXN0Lk1vY2spLm1vY2tJbXBsZW1lbnRhdGlvbigodGV4dDogc3RyaW5nKSA9PiAoe1xuICAgICAgICBoYXNUaGlua2luZ1RhZ3M6IGZhbHNlLCBjb250ZW50V2l0aG91dFRhZ3M6IHRleHQgfHwgXCJcIiwgZm9ybWF0OiAndGV4dCcgLy8gdGV4dCB8fCBcIlwiINC00LDRgdGC0YwgXCJcIlxuICAgIH0pKTtcbiAgICBtb2NrUGFyc2VBbGxUZXh0dWFsVG9vbENhbGxzLm1vY2tSZXR1cm5WYWx1ZShbXSk7XG5cbiAgICBjb25zdCBleHBlY3RlZCA9IFwiKCBVc2luZyB0b29sOiBnZXRTZXR0aW5ncy4uLiApXCI7XG4gICAgY29uc3QgcmVzdWx0ID0gQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLnByZXBhcmVEaXNwbGF5Q29udGVudChtZXNzYWdlLmNvbnRlbnQgfHwgXCJcIiwgbWVzc2FnZSwgbW9ja1BsdWdpbiwgbW9ja1ZpZXcpO1xuICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoZXhwZWN0ZWQpO1xuICB9KTtcbn0pOyJdfQ==