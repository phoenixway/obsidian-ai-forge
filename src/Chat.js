import { __awaiter } from "tslib";
// Chat.ts
import { normalizePath, Notice, debounce } from "obsidian";
export class Chat {
    constructor(adapter, settings, data, filePath, logger) {
        this.adapter = adapter;
        this.pluginSettings = settings;
        this.filePath = normalizePath(filePath);
        this.metadata = data.metadata;
        this.messages = data.messages.map(m => (Object.assign(Object.assign({}, m), { timestamp: new Date(m.timestamp) })));
        this.logger = logger;
        this.debouncedSave = debounce(this._saveToFile.bind(this), 1500, true);
    }
    addMessage(role, content, timestamp = new Date()) {
        const newMessage = { role, content, timestamp };
        this.messages.push(newMessage);
        this.metadata.lastModified = timestamp.toISOString();
        this.save();
        return newMessage;
    }
    getMessages() {
        return [...this.messages];
    }
    clearMessages() {
        this.messages = [];
        this.metadata.lastModified = new Date().toISOString();
        this.save();
    }
    updateMetadata(updates) {
        let changed = false;
        const currentMeta = this.metadata;
        if (updates.name !== undefined && updates.name !== currentMeta.name) {
            currentMeta.name = updates.name;
            changed = true;
        }
        if (updates.modelName !== undefined && updates.modelName !== currentMeta.modelName) {
            currentMeta.modelName = updates.modelName;
            changed = true;
        }
        if (updates.selectedRolePath !== undefined && updates.selectedRolePath !== currentMeta.selectedRolePath) {
            currentMeta.selectedRolePath = updates.selectedRolePath;
            changed = true;
        }
        if (updates.temperature !== undefined && updates.temperature !== currentMeta.temperature) {
            currentMeta.temperature = updates.temperature;
            changed = true;
        }
        if (updates.contextWindow !== undefined && updates.contextWindow !== currentMeta.contextWindow) {
            currentMeta.contextWindow = updates.contextWindow;
            changed = true;
        }
        if (changed) {
            this.metadata.lastModified = new Date().toISOString();
            this.save();
        }
        return changed;
    }
    save() {
        if (this.pluginSettings.saveMessageHistory) {
            this.debouncedSave();
        }
    }
    saveImmediately() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.pluginSettings.saveMessageHistory) {
                return true;
            }
            return yield this._saveToFile();
        });
    }
    _saveToFile() {
        return __awaiter(this, void 0, void 0, function* () {
            const chatData = {
                metadata: this.metadata,
                messages: this.messages.map(m => (Object.assign(Object.assign({}, m), { timestamp: m.timestamp.toISOString() })))
            };
            const jsonString = JSON.stringify(chatData, null, 2);
            try {
                const dirPath = this.filePath.substring(0, this.filePath.lastIndexOf('/'));
                if (dirPath && !(yield this.adapter.exists(dirPath))) {
                    yield this.adapter.mkdir(dirPath);
                }
                yield this.adapter.write(this.filePath, jsonString);
                return true;
            }
            catch (error) {
                console.error(`[Chat ${this.metadata.id}] Error saving chat to ${this.filePath}:`, error);
                new Notice(`Error saving chat: ${this.metadata.name}. Check console.`);
                return false;
            }
        });
    }
    static loadFromFile(filePath, adapter, settings, logger) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            const normPath = normalizePath(filePath);
            try {
                if (!(yield adapter.exists(normPath))) {
                    return null;
                }
                const json = yield adapter.read(normPath);
                const data = JSON.parse(json);
                if (((_a = data === null || data === void 0 ? void 0 : data.metadata) === null || _a === void 0 ? void 0 : _a.id) && Array.isArray(data.messages)) {
                    return new Chat(adapter, settings, data, normPath, logger);
                }
                else {
                    new Notice(`Error loading chat: Invalid data structure in ${filePath}`);
                    return null;
                }
            }
            catch (e) {
                console.error(`[Chat] Error loading or parsing file for static load: ${normPath}`, e);
                new Notice(`Error loading chat file: ${filePath}. ${e.message}`);
                return null;
            }
        });
    }
    deleteFile() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                if (yield this.adapter.exists(this.filePath)) {
                    yield this.adapter.remove(this.filePath);
                    return true;
                }
                return true;
            }
            catch (e) {
                console.error(`[Chat ${this.metadata.id}] Error deleting file ${this.filePath}:`, e);
                new Notice(`Error deleting chat file: ${this.metadata.name}. Check console.`);
                return false;
            }
        });
    }
    toJSON() {
        return {
            metadata: this.metadata,
            messages: this.messages
        };
    }
    recordActivity() {
        const oldLastModified = this.metadata.lastModified;
        this.metadata.lastModified = new Date().toISOString();
        const changed = oldLastModified !== this.metadata.lastModified;
        if (changed) {
            this.save();
        }
        return changed;
    }
} // End of Chat class
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hhdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkNoYXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLFVBQVU7QUFDVixPQUFPLEVBQUUsYUFBYSxFQUFlLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxVQUFVLENBQUM7QUF3QnhFLE1BQU0sT0FBTyxJQUFJO0lBU2IsWUFDSSxPQUFvQixFQUNwQixRQUFpQyxFQUNqQyxJQUFjLEVBQ2QsUUFBZ0IsRUFDaEIsTUFBYztRQUVkLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxjQUFjLEdBQUcsUUFBUSxDQUFDO1FBQy9CLElBQUksQ0FBQyxRQUFRLEdBQUcsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3hDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUM5QixJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsaUNBQU0sQ0FBQyxLQUFFLFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLElBQUcsQ0FBQyxDQUFDO1FBQ3JGLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBRXJCLElBQUksQ0FBQyxhQUFhLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMzRSxDQUFDO0lBRUQsVUFBVSxDQUFDLElBQWlCLEVBQUUsT0FBZSxFQUFFLFlBQWtCLElBQUksSUFBSSxFQUFFO1FBQ3ZFLE1BQU0sVUFBVSxHQUFZLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsQ0FBQztRQUN6RCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMvQixJQUFJLENB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USxDQUFDLEVBQUUsQ0FBQztvQkFDM0MsTUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7b0JBQ3pDLE9BQU8sSUFBSSxDQUFDO2dCQUNoQixDQUFDO2dCQUNELE9BQU8sSUFBSSxDQUFDO1lBQ2hCLENBQUM7WUFBQyxPQUFPLENBQUMsRUFBRSxDQUFDO2dCQUNULE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxJQUFJLENBQUMsUUFBUSxDQUFDLEVBQUUseUJBQXlCLElBQUksQ0FBQyxRQUFRLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDckYsSUFBSSxNQUFNLENBQUMsNkJBQTZCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxrQkFBa0IsQ0FBQyxDQUFDO2dCQUM5RSxPQUFPLEtBQUssQ0FBQztZQUNqQixDQUFDO1FBQ0wsQ0FBQztLQUFBO0lBRU0sTUFBTTtRQUNULE9BQU87WUFDSCxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7WUFDdkIsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO1NBQzFCLENBQUM7SUFDTixDQUFDO0lBRU0sY0FBYztRQUNqQixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztRQUNuRCxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3RELE1BQU0sT0FBTyxHQUFHLGVBQWUsS0FBSyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztRQUUvRCxJQUFJLE9BQU8sRUFBRSxDQUFDO1lBQ1YsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2hCLENBQUM7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0NBQ0osQ0FBQyxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDaGF0LnRzXG5pbXBvcnQgeyBub3JtYWxpemVQYXRoLCBEYXRhQWRhcHRlciwgTm90aWNlLCBkZWJvdW5jZSB9IGZyb20gXCJvYnNpZGlhblwiO1xuaW1wb3J0IHsgTWVzc2FnZVJvbGUgfSBmcm9tIFwiLi9PbGxhbWFWaWV3XCI7XG5pbXBvcnQgeyBPbGxhbWFQbHVnaW5TZXR0aW5ncyB9IGZyb20gXCIuL3NldHRpbmdzXCI7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tIFwiLi9Mb2dnZXJcIjtcbmltcG9ydCB7IE1lc3NhZ2UgfSBmcm9tIFwiLi90eXBlc1wiO1xuXG5leHBvcnQgdHlwZSBDaGF0Q29uc3RydWN0b3JTZXR0aW5ncyA9IE9sbGFtYVBsdWdpblNldHRpbmdzO1xuXG5leHBvcnQgaW50ZXJmYWNlIENoYXRNZXRhZGF0YSB7XG4gICAgaWQ6IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgbW9kZWxOYW1lPzogc3RyaW5nO1xuICAgIHNlbGVjdGVkUm9sZVBhdGg/OiBzdHJpbmc7XG4gICAgdGVtcGVyYXR1cmU/OiBudW1iZXI7XG4gICAgY3JlYXRlZEF0OiBzdHJpbmc7XG4gICAgbGFzdE1vZGlmaWVkOiBzdHJpbmc7XG4gICAgY29udGV4dFdpbmRvdz86IG51bWJlcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDaGF0RGF0YSB7XG4gICAgbWV0YWRhdGE6IENoYXRNZXRhZGF0YTtcbiAgICBtZXNzYWdlczogTWVzc2FnZVtdO1xufVxuXG5leHBvcnQgY2xhc3MgQ2hhdCB7XG4gICAgcHVibGljIG1ldGFkYXRhOiBDaGF0TWV0YWRhdGE7XG4gICAgcHVibGljIG1lc3NhZ2VzOiBNZXNzYWdlW107XG4gICAgcHVibGljIGZpbGVQYXRoOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBhZGFwdGVyOiBEYXRhQWRhcHRlcjtcbiAgICBwcml2YXRlIHBsdWdpblNldHRpbmdzOiBDaGF0Q29uc3RydWN0b3JTZXR0aW5ncztcbiAgICBwcml2YXRlIGRlYm91bmNlZFNhdmU6ICgpID0+IHZvaWQ7XG4gICAgcHJpdmF0ZSBsb2dnZXI6IExvZ2dlcjtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBhZGFwdGVyOiBEYXRhQWRhcHRlcixcbiAgICAgICAgc2V0dGluZ3M6IENoYXRDb25zdHJ1Y3RvclNldHRpbmdzLFxuICAgICAgICBkYXRhOiBDaGF0RGF0YSxcbiAgICAgICAgZmlsZVBhdGg6IHN0cmluZyxcbiAgICAgICAgbG9nZ2VyOiBMb2dnZXJcbiAgICApIHtcbiAgICAgICAgdGhpcy5hZGFwdGVyID0gYWRhcHRlcjtcbiAgICAgICAgdGhpcy5wbHVnaW5TZXR0aW5ncyA9IHNldHRpbmdzO1xuICAgICAgICB0aGlzLmZpbGVQYXRoID0gbm9ybWFsaXplUGF0aChmaWxlUGF0aCk7XG4gICAgICAgIHRoaXMubWV0YWRhdGEgPSBkYXRhLm1ldGFkYXRhO1xuICAgICAgICB0aGlzLm1lc3NhZ2VzID0gZGF0YS5tZXNzYWdlcy5tYXAobSA9PiAoeyAuLi5tLCB0aW1lc3RhbXA6IG5ldyBEYXRlKG0udGltZXN0YW1wKSB9KSk7XG4gICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuXG4gICAgICAgIHRoaXMuZGVib3VuY2VkU2F2ZSA9IGRlYm91bmNlKHRoaXMuX3NhdmVUb0ZpbGUuYmluZCh0aGlzKSwgMTUwMCwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgYWRkTWVzc2FnZShyb2xlOiBNZXNzYWdlUm9sZSwgY29udGVudDogc3RyaW5nLCB0aW1lc3RhbXA6IERhdGUgPSBuZXcgRGF0ZSgpKTogTWVzc2FnZSB7XG4gICAgICAgIGNvbnN0IG5ld01lc3NhZ2U6IE1lc3NhZ2UgPSB7IHJvbGUsIGNvbnRlbnQsIHRpbWVzdGFtcCB9O1xuICAgICAgICB0aGlzLm1lc3NhZ2VzLnB1c2gobmV3TWVzc2FnZSk7XG4gICAgICAgIHRoaXMubWV0YWRhdGEubGFzdE1vZGlmaWVkID0gdGltZXN0YW1wLnRvSVNPU3RyaW5nKCk7XG4gICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgICAgICByZXR1cm4gbmV3TWVzc2FnZTtcbiAgICB9XG5cbiAgICBnZXRNZXNzYWdlcygpOiBNZXNzYWdlW10ge1xuICAgICAgICByZXR1cm4gWy4uLnRoaXMubWVzc2FnZXNdO1xuICAgIH1cblxuICAgIGNsZWFyTWVzc2FnZXMoKTogdm9pZCB7XG4gICAgICAgIHRoaXMubWVzc2FnZXMgPSBbXTtcbiAgICAgICAgdGhpcy5tZXRhZGF0YS5sYXN0TW9kaWZpZWQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgIH1cblxuICAgIHVwZGF0ZU1ldGFkYXRhKHVwZGF0ZXM6IFBhcnRpYWw8T21pdDxDaGF0TWV0YWRhdGEsICdpZCcgfCAnY3JlYXRlZEF0JyB8ICdsYXN0TW9kaWZpZWQnPj4pOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGNoYW5nZWQgPSBmYWxzZTtcbiAgICAgICAgY29uc3QgY3VycmVudE1ldGEgPSB0aGlzLm1ldGFkYXRhO1xuXG4gICAgICAgIGlmICh1cGRhdGVzLm5hbWUgIT09IHVuZGVmaW5lZCAmJiB1cGRhdGVzLm5hbWUgIT09IGN1cnJlbnRNZXRhLm5hbWUpIHtcbiAgICAgICAgICAgIGN1cnJlbnRNZXRhLm5hbWUgPSB1cGRhdGVzLm5hbWU7XG4gICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodXBkYXRlcy5tb2RlbE5hbWUgIT09IHVuZGVmaW5lZCAmJiB1cGRhdGVzLm1vZGVsTmFtZSAhPT0gY3VycmVudE1ldGEubW9kZWxOYW1lKSB7XG4gICAgICAgICAgICBjdXJyZW50TWV0YS5tb2RlbE5hbWUgPSB1cGRhdGVzLm1vZGVsTmFtZTtcbiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh1cGRhdGVzLnNlbGVjdGVkUm9sZVBhdGggIT09IHVuZGVmaW5lZCAmJiB1cGRhdGVzLnNlbGVjdGVkUm9sZVBhdGggIT09IGN1cnJlbnRNZXRhLnNlbGVjdGVkUm9sZVBhdGgpIHtcbiAgICAgICAgICAgIGN1cnJlbnRNZXRhLnNlbGVjdGVkUm9sZVBhdGggPSB1cGRhdGVzLnNlbGVjdGVkUm9sZVBhdGg7XG4gICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodXBkYXRlcy50ZW1wZXJhdHVyZSAhPT0gdW5kZWZpbmVkICYmIHVwZGF0ZXMudGVtcGVyYXR1cmUgIT09IGN1cnJlbnRNZXRhLnRlbXBlcmF0dXJlKSB7XG4gICAgICAgICAgICBjdXJyZW50TWV0YS50ZW1wZXJhdHVyZSA9IHVwZGF0ZXMudGVtcGVyYXR1cmU7XG4gICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodXBkYXRlcy5jb250ZXh0V2luZG93ICE9PSB1bmRlZmluZWQgJiYgdXBkYXRlcy5jb250ZXh0V2luZG93ICE9PSBjdXJyZW50TWV0YS5jb250ZXh0V2luZG93KSB7XG4gICAgICAgICAgICBjdXJyZW50TWV0YS5jb250ZXh0V2luZG93ID0gdXBkYXRlcy5jb250ZXh0V2luZG93O1xuICAgICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoY2hhbmdlZCkge1xuICAgICAgICAgICAgdGhpcy5tZXRhZGF0YS5sYXN0TW9kaWZpZWQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgICAgICAgICB0aGlzLnNhdmUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjaGFuZ2VkO1xuICAgIH1cblxuICAgIHNhdmUoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLnBsdWdpblNldHRpbmdzLnNhdmVNZXNzYWdlSGlzdG9yeSkge1xuICAgICAgICAgICAgdGhpcy5kZWJvdW5jZWRTYXZlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgYXN5bmMgc2F2ZUltbWVkaWF0ZWx5KCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBpZiAoIXRoaXMucGx1Z2luU2V0dGluZ3Muc2F2ZU1lc3NhZ2VIaXN0b3J5KSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5fc2F2ZVRvRmlsZSgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgX3NhdmVUb0ZpbGUoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGNvbnN0IGNoYXREYXRhOiBDaGF0RGF0YSA9IHtcbiAgICAgICAgICAgIG1ldGFkYXRhOiB0aGlzLm1ldGFkYXRhLFxuICAgICAgICAgICAgbWVzc2FnZXM6IHRoaXMubWVzc2FnZXMubWFwKG0gPT4gKHtcbiAgICAgICAgICAgICAgICAuLi5tLFxuICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbS50aW1lc3RhbXAudG9JU09TdHJpbmcoKSBhcyBhbnlcbiAgICAgICAgICAgIH0pKVxuICAgICAgICB9O1xuICAgICAgICBjb25zdCBqc29uU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoY2hhdERhdGEsIG51bGwsIDIpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBkaXJQYXRoID0gdGhpcy5maWxlUGF0aC5zdWJzdHJpbmcoMCwgdGhpcy5maWxlUGF0aC5sYXN0SW5kZXhPZignLycpKTtcblxuICAgICAgICAgICAgaWYgKGRpclBhdGggJiYgIShhd2FpdCB0aGlzLmFkYXB0ZXIuZXhpc3RzKGRpclBhdGgpKSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYWRhcHRlci5ta2RpcihkaXJQYXRoKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGFwdGVyLndyaXRlKHRoaXMuZmlsZVBhdGgsIGpzb25TdHJpbmcpO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQ2hhdCAke3RoaXMubWV0YWRhdGEuaWR9XSBFcnJvciBzYXZpbmcgY2hhdCB0byAke3RoaXMuZmlsZVBhdGh9OmAsIGVycm9yKTtcbiAgICAgICAgICAgIG5ldyBOb3RpY2UoYEVycm9yIHNhdmluZyBjaGF0OiAke3RoaXMubWV0YWRhdGEubmFtZX0uIENoZWNrIGNvbnNvbGUuYCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgbG9hZEZyb21GaWxlKFxuICAgICAgICBmaWxlUGF0aDogc3RyaW5nLFxuICAgICAgICBhZGFwdGVyOiBEYXRhQWRhcHRlcixcbiAgICAgICAgc2V0dGluZ3M6IENoYXRDb25zdHJ1Y3RvclNldHRpbmdzLFxuICAgICAgICBsb2dnZXI6IExvZ2dlclxuICAgICk6IFByb21pc2U8Q2hhdCB8IG51bGw+IHtcbiAgICAgICAgY29uc3Qgbm9ybVBhdGggPSBub3JtYWxpemVQYXRoKGZpbGVQYXRoKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKCEoYXdhaXQgYWRhcHRlci5leGlzdHMobm9ybVBhdGgpKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY29uc3QganNvbiA9IGF3YWl0IGFkYXB0ZXIucmVhZChub3JtUGF0aCk7XG4gICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShqc29uKSBhcyBDaGF0RGF0YTtcblxuICAgICAgICAgICAgaWYgKGRhdGE/Lm1ldGFkYXRhPy5pZCAmJiBBcnJheS5pc0FycmF5KGRhdGEubWVzc2FnZXMpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBDaGF0KGFkYXB0ZXIsIHNldHRpbmdzLCBkYXRhLCBub3JtUGF0aCwgbG9nZ2VyKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgbmV3IE5vdGljZShgRXJyb3IgbG9hZGluZyBjaGF0OiBJbnZhbGlkIGRhdGEgc3RydWN0dXJlIGluICR7ZmlsZVBhdGh9YCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0NoYXRdIEVycm9yIGxvYWRpbmcgb3IgcGFyc2luZyBmaWxlIGZvciBzdGF0aWMgbG9hZDogJHtub3JtUGF0aH1gLCBlKTtcbiAgICAgICAgICAgIG5ldyBOb3RpY2UoYEVycm9yIGxvYWRpbmcgY2hhdCBmaWxlOiAke2ZpbGVQYXRofS4gJHtlLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGRlbGV0ZUZpbGUoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAoYXdhaXQgdGhpcy5hZGFwdGVyLmV4aXN0cyh0aGlzLmZpbGVQYXRoKSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYWRhcHRlci5yZW1vdmUodGhpcy5maWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihgW0NoYXQgJHt0aGlzLm1ldGFkYXRhLmlkfV0gRXJyb3IgZGVsZXRpbmcgZmlsZSAke3RoaXMuZmlsZVBhdGh9OmAsIGUpO1xuICAgICAgICAgICAgbmV3IE5vdGljZShgRXJyb3IgZGVsZXRpbmcgY2hhdCBmaWxlOiAke3RoaXMubWV0YWRhdGEubmFtZX0uIENoZWNrIGNvbnNvbGUuYCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgdG9KU09OKCk6IENoYXREYXRhIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG1ldGFkYXRhOiB0aGlzLm1ldGFkYXRhLFxuICAgICAgICAgICAgbWVzc2FnZXM6IHRoaXMubWVzc2FnZXNcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBwdWJsaWMgcmVjb3JkQWN0aXZpdHkoKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IG9sZExhc3RNb2RpZmllZCA9IHRoaXMubWV0YWRhdGEubGFzdE1vZGlmaWVkO1xuICAgICAgICB0aGlzLm1ldGFkYXRhLmxhc3RNb2RpZmllZCA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAgICAgY29uc3QgY2hhbmdlZCA9IG9sZExhc3RNb2RpZmllZCAhPT0gdGhpcy5tZXRhZGF0YS5sYXN0TW9kaWZpZWQ7XG5cbiAgICAgICAgaWYgKGNoYW5nZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc2F2ZSgpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjaGFuZ2VkO1xuICAgIH1cbn0gLy8gRW5kIG9mIENoYXQgY2xhc3MiXX0=