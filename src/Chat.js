import { __awaiter } from "tslib";
// Chat.ts
import { normalizePath, Notice, debounce } from "obsidian";
export class Chat {
    constructor(adapter, settings, data, // Приймаємо дані з timestamp: Date
    filePath, logger) {
        this.adapter = adapter;
        this.pluginSettings = settings;
        this.filePath = normalizePath(filePath);
        this.metadata = data.metadata;
        // Переконуємося, що timestamp є Date. Якщо він прийшов як рядок (малоймовірно тут), конвертуємо.
        this.messages = data.messages.map(msgData => {
            const messageWithDate = Object.assign(Object.assign({}, msgData), { timestamp: msgData.timestamp instanceof Date ? msgData.timestamp : new Date(msgData.timestamp) });
            if (messageWithDate.role === 'assistant' && messageWithDate.tool_calls) {
            }
            return messageWithDate;
        });
        this.logger = logger;
        this.debouncedSave = debounce(this._saveToFile.bind(this), 1500, true);
    }
    addMessage(role, content, timestamp = new Date()) {
        // Тут Message має timestamp: Date
        const newMessage = { role, content, timestamp };
        this.messages.push(newMessage);
        this.recordActivity();
        return newMessage;
    }
    getMessages() {
        return [...this.messages];
    }
    clearMessages() {
        this.messages = [];
        this.recordActivity();
    }
    updateMetadata(updates) {
        let changed = false;
        const currentMeta = this.metadata;
        if (updates.name !== undefined && updates.name !== currentMeta.name) {
            currentMeta.name = updates.name;
            changed = true;
        }
        if (updates.modelName !== undefined && updates.modelName !== currentMeta.modelName) {
            currentMeta.modelName = updates.modelName;
            changed = true;
        }
        if (updates.selectedRolePath !== undefined && updates.selectedRolePath !== currentMeta.selectedRolePath) {
            currentMeta.selectedRolePath = updates.selectedRolePath;
            changed = true;
        }
        if (updates.temperature !== undefined && updates.temperature !== currentMeta.temperature) {
            currentMeta.temperature = updates.temperature;
            changed = true;
        }
        if (updates.contextWindow !== undefined && updates.contextWindow !== currentMeta.contextWindow) {
            currentMeta.contextWindow = updates.contextWindow;
            changed = true;
        }
        if (changed) {
            this.recordActivity();
        }
        return changed;
    }
    save() {
        if (this.pluginSettings.saveMessageHistory) {
            this.debouncedSave();
        }
    }
    saveImmediately() {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.pluginSettings.saveMessageHistory) {
                return true;
            }
            return yield this._saveToFile();
        });
    }
    _saveToFile() {
        return __awaiter(this, void 0, void 0, function* () {
            const messagesForStorage = this.messages.map(m => {
                var _a, _b;
                // Створюємо об'єкт для збереження, де timestamp буде рядком
                const messageForSave = {
                    role: m.role,
                    content: m.content,
                    timestamp: m.timestamp.toISOString() // Перетворюємо Date на ISO string
                };
                // Явно копіюємо опціональні поля
                if (m.type)
                    messageForSave.type = m.type;
                if (m.images)
                    messageForSave.images = m.images;
                if (m.tool_call_id)
                    messageForSave.tool_call_id = m.tool_call_id;
                if (m.name)
                    messageForSave.name = m.name;
                if (m.role === 'assistant' && m.tool_calls && ((_b = (_a = m.tool_calls) === null || _a === void 0 ? void 0 : _a.length) !== null && _b !== void 0 ? _b : 0) > 0) {
                    messageForSave.tool_calls = m.tool_calls;
                }
                return messageForSave;
            });
            const chatDataToSave = {
                metadata: this.metadata,
                messages: messagesForStorage
            };
            const assistantMessagesWithToolCallsInFinalData = chatDataToSave.messages.filter((msg) => msg.role === "assistant" && msg.tool_calls && msg.tool_calls.length > 0);
            if (assistantMessagesWithToolCallsInFinalData.length > 0) {
                this.logger.info(`[Chat ${this.metadata.id} _saveToFile] FINAL ChatData for stringify CONTAINS tool_calls for ${assistantMessagesWithToolCallsInFinalData.length} assistant messages. First one's tool_calls:`, JSON.stringify(assistantMessagesWithToolCallsInFinalData[0].tool_calls));
            }
            else {
            }
            const jsonString = JSON.stringify(chatDataToSave, null, 2);
            try {
                const dirPath = this.filePath.substring(0, this.filePath.lastIndexOf('/'));
                if (dirPath && !(yield this.adapter.exists(dirPath))) {
                    yield this.adapter.mkdir(dirPath);
                }
                yield this.adapter.write(this.filePath, jsonString);
                return true;
            }
            catch (error) {
                this.logger.error(`[Chat ${this.metadata.id}] Error saving chat to ${this.filePath}:`, error);
                new Notice(`Error saving chat: ${this.metadata.name}. Check console.`);
                return false;
            }
        });
    }
    static loadFromFile(filePath, adapter, settings, logger) {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            const normPath = normalizePath(filePath);
            try {
                if (!(yield adapter.exists(normPath))) {
                    return null;
                }
                const json = yield adapter.read(normPath);
                // Парсимо дані з файлу, очікуючи, що timestamp буде рядком (ChatDataForStorage)
                const rawDataFromFile = JSON.parse(json);
                if (((_a = rawDataFromFile === null || rawDataFromFile === void 0 ? void 0 : rawDataFromFile.metadata) === null || _a === void 0 ? void 0 : _a.id) && Array.isArray(rawDataFromFile.messages)) {
                    // Перетворюємо дані для конструктора: timestamp з рядка на Date
                    const dataForConstructor = {
                        metadata: rawDataFromFile.metadata,
                        messages: rawDataFromFile.messages.map(msgFromFile => {
                            const messageForMemory = Object.assign(Object.assign({}, msgFromFile), { timestamp: new Date(msgFromFile.timestamp) // Конвертуємо рядок в Date
                             });
                            if (messageForMemory.role === 'assistant' && messageForMemory.tool_calls) {
                            }
                            return messageForMemory;
                        })
                    };
                    return new Chat(adapter, settings, dataForConstructor, normPath, logger);
                }
                else {
                    logger.error(`[Chat LOAD] Invalid data structure in ${normPath}`, rawDataFromFile);
                    new Notice(`Error loading chat: Invalid data structure in ${filePath}`);
                    return null;
                }
            }
            catch (e) {
                logger.error(`[Chat LOAD] Error loading or parsing file: ${normPath}`, e);
                new Notice(`Error loading chat file: ${filePath}. ${e.message}`);
                return null;
            }
        });
    }
    deleteFile() {
        return __awaiter(this, void 0, void 0, function* () {
            try {
                if (yield this.adapter.exists(this.filePath)) {
                    yield this.adapter.remove(this.filePath);
                    return true;
                }
                return true;
            }
            catch (e) {
                this.logger.error(`[Chat ${this.metadata.id}] Error deleting file ${this.filePath}:`, e);
                new Notice(`Error deleting chat file: ${this.metadata.name}. Check console.`);
                return false;
            }
        });
    }
    // Повертає ChatDataInMemory, де timestamp є Date
    toJSON() {
        return {
            metadata: this.metadata,
            // Повертаємо копію повідомлень, як вони є в пам'яті (з Date об'єктами)
            messages: this.messages.map(m => (Object.assign({}, m)))
        };
    }
    recordActivity() {
        const oldLastModified = this.metadata.lastModified;
        this.metadata.lastModified = new Date().toISOString();
        const changed = oldLastModified !== this.metadata.lastModified;
        if (changed) {
            this.save();
        }
        return changed;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2hhdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkNoYXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLFVBQVU7QUFDVixPQUFPLEVBQUUsYUFBYSxFQUFlLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFrQ3hFLE1BQU0sT0FBTyxJQUFJO0lBU2IsWUFDSSxPQUFvQixFQUNwQixRQUFpQyxFQUNqQyxJQUFzQixFQUFFLG1DQUFtQztJQUMzRCxRQUFnQixFQUNoQixNQUFjO1FBRWQsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLGNBQWMsR0FBRyxRQUFRLENBQUM7UUFDL0IsSUFBSSxDQUFDLFFBQVEsR0FBRyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDeEMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDO1FBRTlCLGlHQUFpRztRQUNqRyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQ3hDLE1BQU0sZUFBZSxtQ0FDZCxPQUFPLEtBQ1YsU0FBUyxFQUFFLE9BQU8sQ0FBQyxTQUFTLFlBQVksSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLEdBQ2pHLENBQUM7WUFDRixJQUFJLGVBQWUsQ0FBQyxJQUFJLEtBQUssV0FBVyxJQUFLLGVBQW9DLENBQUMsVUFBVSxFQUFFLENBQUM7WUFFL0YsQ0FBQztZQUNELE9BQU8sZUFBZSxDQUFDO1FBQzNCLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLGFBQWEsR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVB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LEtBQUssQ0FBQyxTQUFTLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSx5QkFBeUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO2dCQUN6RixJQUFJLE1BQU0sQ0FBQyw2QkFBNkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLGtCQUFrQixDQUFDLENBQUM7Z0JBQzlFLE9BQU8sS0FBSyxDQUFDO1lBQ2pCLENBQUM7UUFDTCxDQUFDO0tBQUE7SUFFRCxpREFBaUQ7SUFDMUMsTUFBTTtRQUNULE9BQU87WUFDSCxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7WUFDdkIsdUVBQXVFO1lBQ3ZFLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLG1CQUFLLENBQUMsRUFBRSxDQUFDO1NBQzdDLENBQUM7SUFDTixDQUFDO0lBRU0sY0FBYztRQUNqQixNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztRQUNuRCxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3RELE1BQU0sT0FBTyxHQUFHLGVBQWUsS0FBSyxJQUFJLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztRQUUvRCxJQUFJLE9BQU8sRUFBRSxDQUFDO1lBRVYsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2hCLENBQUM7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNuQixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDaGF0LnRzXG5pbXBvcnQgeyBub3JtYWxpemVQYXRoLCBEYXRhQWRhcHRlciwgTm90aWNlLCBkZWJvdW5jZSB9IGZyb20gXCJvYnNpZGlhblwiO1xuaW1wb3J0IHsgT2xsYW1hUGx1Z2luU2V0dGluZ3MgfSBmcm9tIFwiLi9zZXR0aW5nc1wiO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSBcIi4vTG9nZ2VyXCI7XG5pbXBvcnQgeyBNZXNzYWdlLCBUb29sQ2FsbCwgQXNzaXN0YW50TWVzc2FnZSwgTWVzc2FnZVJvbGUgYXMgTWVzc2FnZVJvbGVGcm9tVHlwZXMgfSBmcm9tIFwiLi90eXBlc1wiO1xuXG5leHBvcnQgdHlwZSBDaGF0Q29uc3RydWN0b3JTZXR0aW5ncyA9IE9sbGFtYVBsdWdpblNldHRpbmdzO1xuXG5leHBvcnQgaW50ZXJmYWNlIENoYXRNZXRhZGF0YSB7XG4gICAgaWQ6IHN0cmluZztcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgbW9kZWxOYW1lPzogc3RyaW5nO1xuICAgIHNlbGVjdGVkUm9sZVBhdGg/OiBzdHJpbmc7XG4gICAgdGVtcGVyYXR1cmU/OiBudW1iZXI7XG4gICAgY3JlYXRlZEF0OiBzdHJpbmc7IC8vIElTTyBEYXRlIHN0cmluZ1xuICAgIGxhc3RNb2RpZmllZDogc3RyaW5nOyAvLyBJU08gRGF0ZSBzdHJpbmdcbiAgICBjb250ZXh0V2luZG93PzogbnVtYmVyO1xufVxuXG4vLyDQotC40L8g0LTQu9GPINC00LDQvdC40YUsINGP0LrRliDRgdC10YDRltCw0LvRltC30YPRjtGC0YzRgdGPL9C00LXRgdC10YDRltCw0LvRltC30YPRjtGC0YzRgdGPINC3L9CyIEpTT05cbi8vINCi0YPRgiB0aW1lc3RhbXAg0LHRg9C00LUg0YDRj9C00LrQvtC8IChJU08gc3RyaW5nKVxuZXhwb3J0IGludGVyZmFjZSBDaGF0RGF0YUZvclN0b3JhZ2Uge1xuICAgIG1ldGFkYXRhOiBDaGF0TWV0YWRhdGE7XG4gICAgLy8g0JLQuNC60L7RgNC40YHRgtC+0LLRg9GU0LzQviBPbWl0INC00LvRjyDQt9Cw0LzRltC90Lgg0YLQuNC/0YMgdGltZXN0YW1wLCDQt9Cx0LXRgNGW0LPQsNGO0YfQuCDRltC90YjRliDQstC70LDRgdGC0LjQstC+0YHRgtGWIE1lc3NhZ2VcbiAgICBtZXNzYWdlczogQXJyYXk8T21pdDxNZXNzYWdlLCAndGltZXN0YW1wJz4gJiB7IHRpbWVzdGFtcDogc3RyaW5nIH0+O1xufVxuXG4vLyDQotC40L8g0LTQu9GPINC00LDQvdC40YUsINGJ0L4g0LLQuNC60L7RgNC40YHRgtC+0LLRg9GO0YLRjNGB0Y8g0LIg0L/QsNC8J9GP0YLRliDQstGB0LXRgNC10LTQuNC90ZYg0LXQutC30LXQvNC/0LvRj9GA0LAgQ2hhdFxuLy8g0KLRg9GCIHRpbWVzdGFtcCDRlCDQvtCxJ9GU0LrRgtC+0LwgRGF0ZVxuZXhwb3J0IGludGVyZmFjZSBDaGF0RGF0YUluTWVtb3J5IHtcbiAgICBtZXRhZGF0YTogQ2hhdE1ldGFkYXRhO1xuICAgIG1lc3NhZ2VzOiBNZXNzYWdlW107IC8vIE1lc3NhZ2Ug0LcgdHlwZXMudHMsINC00LUgdGltZXN0YW1wOiBEYXRlXG59XG5cblxuZXhwb3J0IGNsYXNzIENoYXQge1xuICAgIHB1YmxpYyBtZXRhZGF0YTogQ2hhdE1ldGFkYXRhO1xuICAgIHB1YmxpYyBtZXNzYWdlczogTWVzc2FnZVtdOyAvLyDQnNCw0YHQuNCyINC/0L7QstGW0LTQvtC80LvQtdC90YwsIHRpbWVzdGFtcCDRgtGD0YIg0YLQuNC/0YMgRGF0ZVxuICAgIHB1YmxpYyBmaWxlUGF0aDogc3RyaW5nO1xuICAgIHByaXZhdGUgYWRhcHRlcjogRGF0YUFkYXB0ZXI7XG4gICAgcHJpdmF0ZSBwbHVnaW5TZXR0aW5nczogQ2hhdENvbnN0cnVjdG9yU2V0dGluZ3M7XG4gICAgcHJpdmF0ZSBkZWJvdW5jZWRTYXZlOiAoKSA9PiB2b2lkO1xuICAgIHByaXZhdGUgbG9nZ2VyOiBMb2dnZXI7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgYWRhcHRlcjogRGF0YUFkYXB0ZXIsXG4gICAgICAgIHNldHRpbmdzOiBDaGF0Q29uc3RydWN0b3JTZXR0aW5ncyxcbiAgICAgICAgZGF0YTogQ2hhdERhdGFJbk1lbW9yeSwgLy8g0J/RgNC40LnQvNCw0ZTQvNC+INC00LDQvdGWINC3IHRpbWVzdGFtcDogRGF0ZVxuICAgICAgICBmaWxlUGF0aDogc3RyaW5nLFxuICAgICAgICBsb2dnZXI6IExvZ2dlclxuICAgICkge1xuICAgICAgICB0aGlzLmFkYXB0ZXIgPSBhZGFwdGVyO1xuICAgICAgICB0aGlzLnBsdWdpblNldHRpbmdzID0gc2V0dGluZ3M7XG4gICAgICAgIHRoaXMuZmlsZVBhdGggPSBub3JtYWxpemVQYXRoKGZpbGVQYXRoKTtcbiAgICAgICAgdGhpcy5tZXRhZGF0YSA9IGRhdGEubWV0YWRhdGE7XG4gICAgICAgIFxuICAgICAgICAvLyDQn9C10YDQtdC60L7QvdGD0ZTQvNC+0YHRjywg0YnQviB0aW1lc3RhbXAg0ZQgRGF0ZS4g0K/QutGJ0L4g0LLRltC9INC/0YDQuNC50YjQvtCyINGP0Log0YDRj9C00L7QuiAo0LzQsNC70L7QudC80L7QstGW0YDQvdC+INGC0YPRgiksINC60L7QvdCy0LXRgNGC0YPRlNC80L4uXG4gICAgICAgIHRoaXMubWVzc2FnZXMgPSBkYXRhLm1lc3NhZ2VzLm1hcChtc2dEYXRhID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2VXaXRoRGF0ZTogTWVzc2FnZSA9IHtcbiAgICAgICAgICAgICAgICAuLi5tc2dEYXRhLCBcbiAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG1zZ0RhdGEudGltZXN0YW1wIGluc3RhbmNlb2YgRGF0ZSA/IG1zZ0RhdGEudGltZXN0YW1wIDogbmV3IERhdGUobXNnRGF0YS50aW1lc3RhbXApIFxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGlmIChtZXNzYWdlV2l0aERhdGUucm9sZSA9PT0gJ2Fzc2lzdGFudCcgJiYgKG1lc3NhZ2VXaXRoRGF0ZSBhcyBBc3Npc3RhbnRNZXNzYWdlKS50b29sX2NhbGxzKSB7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbWVzc2FnZVdpdGhEYXRlO1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMubG9nZ2VyID0gbG9nZ2VyO1xuICAgICAgICB0aGlzLmRlYm91bmNlZFNhdmUgPSBkZWJvdW5jZSh0aGlzLl9zYXZlVG9GaWxlLmJpbmQodGhpcyksIDE1MDAsIHRydWUpO1xuICAgIH1cblxuICAgIGFkZE1lc3NhZ2Uocm9sZTogTWVzc2FnZVJvbGVGcm9tVHlwZXMsIGNvbnRlbnQ6IHN0cmluZywgdGltZXN0YW1wOiBEYXRlID0gbmV3IERhdGUoKSk6IE1lc3NhZ2Uge1xuICAgICAgICAvLyDQotGD0YIgTWVzc2FnZSDQvNCw0ZQgdGltZXN0YW1wOiBEYXRlXG4gICAgICAgIGNvbnN0IG5ld01lc3NhZ2U6IE1lc3NhZ2UgPSB7IHJvbGUsIGNvbnRlbnQsIHRpbWVzdGFtcCB9O1xuICAgICAgICB0aGlzLm1lc3NhZ2VzLnB1c2gobmV3TWVzc2FnZSk7XG4gICAgICAgIHRoaXMucmVjb3JkQWN0aXZpdHkoKTtcbiAgICAgICAgcmV0dXJuIG5ld01lc3NhZ2U7XG4gICAgfVxuXG4gICAgZ2V0TWVzc2FnZXMoKTogTWVzc2FnZVtdIHtcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLm1lc3NhZ2VzXTsgXG4gICAgfVxuXG4gICAgY2xlYXJNZXNzYWdlcygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5tZXNzYWdlcyA9IFtdO1xuICAgICAgICB0aGlzLnJlY29yZEFjdGl2aXR5KCk7XG4gICAgfVxuXG4gICAgdXBkYXRlTWV0YWRhdGEodXBkYXRlczogUGFydGlhbDxPbWl0PENoYXRNZXRhZGF0YSwgJ2lkJyB8ICdjcmVhdGVkQXQnIHwgJ2xhc3RNb2RpZmllZCc+Pik6IGJvb2xlYW4ge1xuICAgICAgICBsZXQgY2hhbmdlZCA9IGZhbHNlO1xuICAgICAgICBjb25zdCBjdXJyZW50TWV0YSA9IHRoaXMubWV0YWRhdGE7XG5cbiAgICAgICAgaWYgKHVwZGF0ZXMubmFtZSAhPT0gdW5kZWZpbmVkICYmIHVwZGF0ZXMubmFtZSAhPT0gY3VycmVudE1ldGEubmFtZSkge1xuICAgICAgICAgICAgY3VycmVudE1ldGEubmFtZSA9IHVwZGF0ZXMubmFtZTtcbiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh1cGRhdGVzLm1vZGVsTmFtZSAhPT0gdW5kZWZpbmVkICYmIHVwZGF0ZXMubW9kZWxOYW1lICE9PSBjdXJyZW50TWV0YS5tb2RlbE5hbWUpIHtcbiAgICAgICAgICAgIGN1cnJlbnRNZXRhLm1vZGVsTmFtZSA9IHVwZGF0ZXMubW9kZWxOYW1lO1xuICAgICAgICAgICAgY2hhbmdlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHVwZGF0ZXMuc2VsZWN0ZWRSb2xlUGF0aCAhPT0gdW5kZWZpbmVkICYmIHVwZGF0ZXMuc2VsZWN0ZWRSb2xlUGF0aCAhPT0gY3VycmVudE1ldGEuc2VsZWN0ZWRSb2xlUGF0aCkge1xuICAgICAgICAgICAgY3VycmVudE1ldGEuc2VsZWN0ZWRSb2xlUGF0aCA9IHVwZGF0ZXMuc2VsZWN0ZWRSb2xlUGF0aDtcbiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh1cGRhdGVzLnRlbXBlcmF0dXJlICE9PSB1bmRlZmluZWQgJiYgdXBkYXRlcy50ZW1wZXJhdHVyZSAhPT0gY3VycmVudE1ldGEudGVtcGVyYXR1cmUpIHtcbiAgICAgICAgICAgIGN1cnJlbnRNZXRhLnRlbXBlcmF0dXJlID0gdXBkYXRlcy50ZW1wZXJhdHVyZTtcbiAgICAgICAgICAgIGNoYW5nZWQgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh1cGRhdGVzLmNvbnRleHRXaW5kb3cgIT09IHVuZGVmaW5lZCAmJiB1cGRhdGVzLmNvbnRleHRXaW5kb3cgIT09IGN1cnJlbnRNZXRhLmNvbnRleHRXaW5kb3cpIHtcbiAgICAgICAgICAgIGN1cnJlbnRNZXRhLmNvbnRleHRXaW5kb3cgPSB1cGRhdGVzLmNvbnRleHRXaW5kb3c7XG4gICAgICAgICAgICBjaGFuZ2VkID0gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjaGFuZ2VkKSB7XG4gICAgICAgICAgICB0aGlzLnJlY29yZEFjdGl2aXR5KCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGNoYW5nZWQ7XG4gICAgfVxuXG4gICAgc2F2ZSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMucGx1Z2luU2V0dGluZ3Muc2F2ZU1lc3NhZ2VIaXN0b3J5KSB7XG4gICAgICAgICAgICB0aGlzLmRlYm91bmNlZFNhdmUoKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBhc3luYyBzYXZlSW1tZWRpYXRlbHkoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgICAgIGlmICghdGhpcy5wbHVnaW5TZXR0aW5ncy5zYXZlTWVzc2FnZUhpc3RvcnkpIHtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX3NhdmVUb0ZpbGUoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIF9zYXZlVG9GaWxlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IG1lc3NhZ2VzRm9yU3RvcmFnZSA9IHRoaXMubWVzc2FnZXMubWFwKG0gPT4ge1xuICAgICAgICAgICAgLy8g0KHRgtCy0L7RgNGO0ZTQvNC+INC+0LEn0ZTQutGCINC00LvRjyDQt9Cx0LXRgNC10LbQtdC90L3Rjywg0LTQtSB0aW1lc3RhbXAg0LHRg9C00LUg0YDRj9C00LrQvtC8XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlRm9yU2F2ZTogT21pdDxNZXNzYWdlLCAndGltZXN0YW1wJz4gJiB7IHRpbWVzdGFtcDogc3RyaW5nOyB0b29sX2NhbGxzPzogVG9vbENhbGxbXSB9ID0ge1xuICAgICAgICAgICAgICAgIHJvbGU6IG0ucm9sZSxcbiAgICAgICAgICAgICAgICBjb250ZW50OiBtLmNvbnRlbnQsXG4gICAgICAgICAgICAgICAgdGltZXN0YW1wOiBtLnRpbWVzdGFtcC50b0lTT1N0cmluZygpIC8vINCf0LXRgNC10YLQstC+0YDRjtGU0LzQviBEYXRlINC90LAgSVNPIHN0cmluZ1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgLy8g0K/QstC90L4g0LrQvtC/0ZbRjtGU0LzQviDQvtC/0YbRltC+0L3QsNC70YzQvdGWINC/0L7Qu9GPXG4gICAgICAgICAgICBpZiAobS50eXBlKSAobWVzc2FnZUZvclNhdmUgYXMgYW55KS50eXBlID0gbS50eXBlO1xuICAgICAgICAgICAgaWYgKG0uaW1hZ2VzKSAobWVzc2FnZUZvclNhdmUgYXMgYW55KS5pbWFnZXMgPSBtLmltYWdlcztcbiAgICAgICAgICAgIGlmIChtLnRvb2xfY2FsbF9pZCkgKG1lc3NhZ2VGb3JTYXZlIGFzIGFueSkudG9vbF9jYWxsX2lkID0gbS50b29sX2NhbGxfaWQ7XG4gICAgICAgICAgICBpZiAobS5uYW1lKSAobWVzc2FnZUZvclNhdmUgYXMgYW55KS5uYW1lID0gbS5uYW1lO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAobS5yb2xlID09PSAnYXNzaXN0YW50JyAmJiAobSBhcyBBc3Npc3RhbnRNZXNzYWdlKS50b29sX2NhbGxzICYmICgobSBhcyBBc3Npc3RhbnRNZXNzYWdlKS50b29sX2NhbGxzPy5sZW5ndGggPz8gMCkgPiAwKSB7XG4gICAgICAgICAgICAgICAgbWVzc2FnZUZvclNhdmUudG9vbF9jYWxscyA9IChtIGFzIEFzc2lzdGFudE1lc3NhZ2UpLnRvb2xfY2FsbHM7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbWVzc2FnZUZvclNhdmU7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGNvbnN0IGNoYXREYXRhVG9TYXZlOiBDaGF0RGF0YUZvclN0b3JhZ2UgPSB7XG4gICAgICAgICAgICBtZXRhZGF0YTogdGhpcy5tZXRhZGF0YSxcbiAgICAgICAgICAgIG1lc3NhZ2VzOiBtZXNzYWdlc0ZvclN0b3JhZ2VcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCBhc3Npc3RhbnRNZXNzYWdlc1dpdGhUb29sQ2FsbHNJbkZpbmFsRGF0YSA9IGNoYXREYXRhVG9TYXZlLm1lc3NhZ2VzLmZpbHRlcihcbiAgICAgICAgICAobXNnKSA9PiBtc2cucm9sZSA9PT0gXCJhc3Npc3RhbnRcIiAmJiAobXNnIGFzIGFueSkudG9vbF9jYWxscyAmJiAobXNnIGFzIGFueSkudG9vbF9jYWxscy5sZW5ndGggPiAwXG4gICAgICAgICk7XG4gICAgICAgIGlmIChhc3Npc3RhbnRNZXNzYWdlc1dpdGhUb29sQ2FsbHNJbkZpbmFsRGF0YS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICB0aGlzLmxvZ2dlci5pbmZvKFxuICAgICAgICAgICAgICAgIGBbQ2hhdCAke3RoaXMubWV0YWRhdGEuaWR9IF9zYXZlVG9GaWxlXSBGSU5BTCBDaGF0RGF0YSBmb3Igc3RyaW5naWZ5IENPTlRBSU5TIHRvb2xfY2FsbHMgZm9yICR7YXNzaXN0YW50TWVzc2FnZXNXaXRoVG9vbENhbGxzSW5GaW5hbERhdGEubGVuZ3RofSBhc3Npc3RhbnQgbWVzc2FnZXMuIEZpcnN0IG9uZSdzIHRvb2xfY2FsbHM6YCxcbiAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSgoYXNzaXN0YW50TWVzc2FnZXNXaXRoVG9vbENhbGxzSW5GaW5hbERhdGFbMF0gYXMgYW55KS50b29sX2NhbGxzKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIFxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QganNvblN0cmluZyA9IEpTT04uc3RyaW5naWZ5KGNoYXREYXRhVG9TYXZlLCBudWxsLCAyKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZGlyUGF0aCA9IHRoaXMuZmlsZVBhdGguc3Vic3RyaW5nKDAsIHRoaXMuZmlsZVBhdGgubGFzdEluZGV4T2YoJy8nKSk7XG4gICAgICAgICAgICBpZiAoZGlyUGF0aCAmJiAhKGF3YWl0IHRoaXMuYWRhcHRlci5leGlzdHMoZGlyUGF0aCkpKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGFwdGVyLm1rZGlyKGRpclBhdGgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGFwdGVyLndyaXRlKHRoaXMuZmlsZVBhdGgsIGpzb25TdHJpbmcpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBbQ2hhdCAke3RoaXMubWV0YWRhdGEuaWR9XSBFcnJvciBzYXZpbmcgY2hhdCB0byAke3RoaXMuZmlsZVBhdGh9OmAsIGVycm9yKTtcbiAgICAgICAgICAgIG5ldyBOb3RpY2UoYEVycm9yIHNhdmluZyBjaGF0OiAke3RoaXMubWV0YWRhdGEubmFtZX0uIENoZWNrIGNvbnNvbGUuYCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzdGF0aWMgYXN5bmMgbG9hZEZyb21GaWxlKFxuICAgICAgICBmaWxlUGF0aDogc3RyaW5nLFxuICAgICAgICBhZGFwdGVyOiBEYXRhQWRhcHRlcixcbiAgICAgICAgc2V0dGluZ3M6IENoYXRDb25zdHJ1Y3RvclNldHRpbmdzLFxuICAgICAgICBsb2dnZXI6IExvZ2dlclxuICAgICk6IFByb21pc2U8Q2hhdCB8IG51bGw+IHtcbiAgICAgICAgY29uc3Qgbm9ybVBhdGggPSBub3JtYWxpemVQYXRoKGZpbGVQYXRoKTtcbiAgICAgICAgXG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGlmICghKGF3YWl0IGFkYXB0ZXIuZXhpc3RzKG5vcm1QYXRoKSkpIHtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IGpzb24gPSBhd2FpdCBhZGFwdGVyLnJlYWQobm9ybVBhdGgpO1xuICAgICAgICAgICAgLy8g0J/QsNGA0YHQuNC80L4g0LTQsNC90ZYg0Lcg0YTQsNC50LvRgywg0L7Rh9GW0LrRg9GO0YfQuCwg0YnQviB0aW1lc3RhbXAg0LHRg9C00LUg0YDRj9C00LrQvtC8IChDaGF0RGF0YUZvclN0b3JhZ2UpXG4gICAgICAgICAgICBjb25zdCByYXdEYXRhRnJvbUZpbGUgPSBKU09OLnBhcnNlKGpzb24pIGFzIENoYXREYXRhRm9yU3RvcmFnZTsgXG5cbiAgICAgICAgICAgIGlmIChyYXdEYXRhRnJvbUZpbGU/Lm1ldGFkYXRhPy5pZCAmJiBBcnJheS5pc0FycmF5KHJhd0RhdGFGcm9tRmlsZS5tZXNzYWdlcykpIHtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyDQn9C10YDQtdGC0LLQvtGA0Y7RlNC80L4g0LTQsNC90ZYg0LTQu9GPINC60L7QvdGB0YLRgNGD0LrRgtC+0YDQsDogdGltZXN0YW1wINC3INGA0Y/QtNC60LAg0L3QsCBEYXRlXG4gICAgICAgICAgICAgICAgY29uc3QgZGF0YUZvckNvbnN0cnVjdG9yOiBDaGF0RGF0YUluTWVtb3J5ID0ge1xuICAgICAgICAgICAgICAgICAgICBtZXRhZGF0YTogcmF3RGF0YUZyb21GaWxlLm1ldGFkYXRhLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlczogcmF3RGF0YUZyb21GaWxlLm1lc3NhZ2VzLm1hcChtc2dGcm9tRmlsZSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtZXNzYWdlRm9yTWVtb3J5OiBNZXNzYWdlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLihtc2dGcm9tRmlsZSBhcyBPbWl0PE1lc3NhZ2UsICd0aW1lc3RhbXAnIHwgJ3Rvb2xfY2FsbHMnPiAmIHsgdGltZXN0YW1wOiBzdHJpbmcsIHRvb2xfY2FsbHM/OiBUb29sQ2FsbFtdIH0pLCAvLyDQn9GA0LjQstC10LTQtdC90L3RjyDRgtC40L/RgyDQtNC70Y8gVHlwZVNjcmlwdFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUobXNnRnJvbUZpbGUudGltZXN0YW1wKSAvLyDQmtC+0L3QstC10YDRgtGD0ZTQvNC+INGA0Y/QtNC+0Log0LIgRGF0ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHRvb2xfY2FsbHMg0YLQsCDRltC90YjRliDQv9C+0LvRjyDQutC+0L/RltGO0Y7RgtGM0YHRjyDRh9C10YDQtdC3IC4uLlxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtZXNzYWdlRm9yTWVtb3J5LnJvbGUgPT09ICdhc3Npc3RhbnQnICYmIChtZXNzYWdlRm9yTWVtb3J5IGFzIEFzc2lzdGFudE1lc3NhZ2UpLnRvb2xfY2FsbHMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBtZXNzYWdlRm9yTWVtb3J5O1xuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBDaGF0KGFkYXB0ZXIsIHNldHRpbmdzLCBkYXRhRm9yQ29uc3RydWN0b3IsIG5vcm1QYXRoLCBsb2dnZXIpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoYFtDaGF0IExPQURdIEludmFsaWQgZGF0YSBzdHJ1Y3R1cmUgaW4gJHtub3JtUGF0aH1gLCByYXdEYXRhRnJvbUZpbGUpO1xuICAgICAgICAgICAgICAgIG5ldyBOb3RpY2UoYEVycm9yIGxvYWRpbmcgY2hhdDogSW52YWxpZCBkYXRhIHN0cnVjdHVyZSBpbiAke2ZpbGVQYXRofWApO1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlOiBhbnkpIHtcbiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihgW0NoYXQgTE9BRF0gRXJyb3IgbG9hZGluZyBvciBwYXJzaW5nIGZpbGU6ICR7bm9ybVBhdGh9YCwgZSk7XG4gICAgICAgICAgICBuZXcgTm90aWNlKGBFcnJvciBsb2FkaW5nIGNoYXQgZmlsZTogJHtmaWxlUGF0aH0uICR7ZS5tZXNzYWdlfWApO1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBkZWxldGVGaWxlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgaWYgKGF3YWl0IHRoaXMuYWRhcHRlci5leGlzdHModGhpcy5maWxlUGF0aCkpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFkYXB0ZXIucmVtb3ZlKHRoaXMuZmlsZVBhdGgpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYFtDaGF0ICR7dGhpcy5tZXRhZGF0YS5pZH1dIEVycm9yIGRlbGV0aW5nIGZpbGUgJHt0aGlzLmZpbGVQYXRofTpgLCBlKTtcbiAgICAgICAgICAgIG5ldyBOb3RpY2UoYEVycm9yIGRlbGV0aW5nIGNoYXQgZmlsZTogJHt0aGlzLm1ldGFkYXRhLm5hbWV9LiBDaGVjayBjb25zb2xlLmApO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8g0J/QvtCy0LXRgNGC0LDRlCBDaGF0RGF0YUluTWVtb3J5LCDQtNC1IHRpbWVzdGFtcCDRlCBEYXRlXG4gICAgcHVibGljIHRvSlNPTigpOiBDaGF0RGF0YUluTWVtb3J5IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIG1ldGFkYXRhOiB0aGlzLm1ldGFkYXRhLFxuICAgICAgICAgICAgLy8g0J/QvtCy0LXRgNGC0LDRlNC80L4g0LrQvtC/0ZbRjiDQv9C+0LLRltC00L7QvNC70LXQvdGMLCDRj9C6INCy0L7QvdC4INGUINCyINC/0LDQvCfRj9GC0ZYgKNC3IERhdGUg0L7QsSfRlNC60YLQsNC80LgpXG4gICAgICAgICAgICBtZXNzYWdlczogdGhpcy5tZXNzYWdlcy5tYXAobSA9PiAoey4uLm19KSkgXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgcHVibGljIHJlY29yZEFjdGl2aXR5KCk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBvbGRMYXN0TW9kaWZpZWQgPSB0aGlzLm1ldGFkYXRhLmxhc3RNb2RpZmllZDtcbiAgICAgICAgdGhpcy5tZXRhZGF0YS5sYXN0TW9kaWZpZWQgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7XG4gICAgICAgIGNvbnN0IGNoYW5nZWQgPSBvbGRMYXN0TW9kaWZpZWQgIT09IHRoaXMubWV0YWRhdGEubGFzdE1vZGlmaWVkO1xuICAgICAgICBcbiAgICAgICAgaWYgKGNoYW5nZWQpIHtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgdGhpcy5zYXZlKCk7IFxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjaGFuZ2VkO1xuICAgIH1cbn0iXX0=