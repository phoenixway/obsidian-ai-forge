import { __awaiter } from "tslib";
import { Notice, setIcon } from "obsidian";
import { CSS_CLASSES } from "../constants";
import * as RendererUtils from "../MessageRendererUtils";
import { BaseMessageRenderer } from "./BaseMessageRenderer";
import { parseAllTextualToolCalls } from "@/utils/toolParser";
export class AssistantMessageRenderer extends BaseMessageRenderer {
    constructor(app, plugin, message, view) {
        super(app, plugin, message, view);
        if (message.role !== "assistant") {
            throw new Error("AssistantMessageRenderer can only render messages with role 'assistant'.");
        }
    }
    static prepareDisplayContent(originalContent, assistantMessage, plugin, view) {
        const messageTimestampLog = assistantMessage.timestamp.getTime();
        let toolUsagePrefix = "→ "; // Наприклад, стрілка або іконка інструменту (див. нижче)
        let toolMessageAction = "";
        const logger = plugin.logger; // Для зручності
        const ts = assistantMessage.timestamp.getTime();
        const decodedContent = RendererUtils.decodeHtmlEntities(originalContent);
        const thinkDetection = RendererUtils.detectThinkingTags(decodedContent);
        let contentAfterThinkStripping = thinkDetection.contentWithoutTags;
        const hasNativeToolCalls = !!(assistantMessage.tool_calls && assistantMessage.tool_calls.length > 0);
        const hasTextualToolCallTagsInProcessedContent = contentAfterThinkStripping.includes("<tool_call>");
        let finalDisplayContent = contentAfterThinkStripping;
        if (plugin.settings.enableToolUse && (hasNativeToolCalls || hasTextualToolCallTagsInProcessedContent)) {
            let toolUsageIndicatorActionText = "";
            const toolNamesExtracted = [];
            // Текст, що залишиться ПІСЛЯ видалення <tool_call> тегів з contentToProcess (який вже без <think>)
            let accompanyingText = contentAfterThinkStripping;
            if (hasNativeToolCalls && assistantMessage.tool_calls) {
                assistantMessage.tool_calls.forEach(tc => toolNamesExtracted.push(tc.function.name));
                // Для нативних викликів, `accompanyingText` (який є `contentToProcess`)
                // це текст, що міг бути разом з нативними tool_calls (вже без <think>).
                // Ми не видаляємо з нього нічого додатково на цьому етапі.
            }
            else if (hasTextualToolCallTagsInProcessedContent) {
                // Використовуємо parseAllTextualToolCalls з OllamaView для отримання імен
                // Важливо, що parseAllTextualToolCalls отримує текст, де ВЖЕ НЕМАЄ <think> тегів
                const parsedTextualCalls = parseAllTextualToolCalls(contentAfterThinkStripping, logger);
                parsedTextualCalls.forEach(ptc => toolNamesExtracted.push(ptc.name));
                // Видаляємо <tool_call> теги з contentToProcess для отримання супровідного тексту
                // Цей replace може бути проблематичним, якщо теги пошкоджені
                accompanyingText = contentAfterThinkStripping.replace(/<tool_call>[\s\S]*?<\/tool_call>/g, "").trim();
                // Додаткове "грубе" очищення, якщо попереднє не спрацювало ідеально
                // і якщо імена не були витягнуті (що може вказувати на проблеми з тегами)
                if (toolNamesExtracted.length === 0 && (accompanyingText.includes("<tool_call>") || accompanyingText.includes("</tool_call>"))) {
                    let tempText = accompanyingText;
                    tempText = tempText.replace(/<tool_call>/g, "").replace(/<\/tool_call>/g, "").trim();
                    accompanyingText = tempText;
                }
            }
            // Формуємо текст для індикатора
            if (toolNamesExtracted.length > 0) {
                toolUsageIndicatorActionText = `Using tool${toolNamesExtracted.length > 1 ? 's' : ''}: ${toolNamesExtracted.join(', ')}...`;
            }
            else {
                toolUsageIndicatorActionText = "Attempting to use tool(s)...";
            }
            // Обгортаємо індикатор в span зі спеціальним класом
            const toolUsageIndicatorHTML = `<span class="${CSS_CLASSES.ASSISTANT_TOOL_USAGE_INDICATOR || 'assistant-tool-usage-indicator'}">→ ${toolUsageIndicatorActionText}</span>`;
            // Збираємо фінальний контент для відображення
            if (accompanyingText && accompanyingText.trim().length > 0) {
                finalDisplayContent = `${toolUsageIndicatorHTML}\n\n${accompanyingText.trim()}`;
            }
            else {
                finalDisplayContent = toolUsageIndicatorHTML;
            }
        }
        return finalDisplayContent;
    }
    render() {
        return __awaiter(this, void 0, void 0, function* () {
            const messageTimestampLog = this.message.timestamp.getTime();
            const messageGroup = this.createMessageGroupWrapper([CSS_CLASSES.OLLAMA_GROUP || "ollama-message-group"]);
            RendererUtils.renderAvatar(this.app, this.plugin, messageGroup, false, "assistant");
            const messageWrapper = messageGroup.createDiv({ cls: CSS_CLASSES.MESSAGE_WRAPPER || "message-wrapper" });
            messageWrapper.style.order = "2";
            const { messageEl, contentEl } = this.createMessageBubble(messageWrapper, [
                CSS_CLASSES.OLLAMA_MESSAGE || "ollama-message",
            ]);
            contentEl.addClass(CSS_CLASSES.CONTENT_COLLAPSIBLE || "message-content-collapsible");
            const assistantMessage = this.message;
            const displayContent = AssistantMessageRenderer.prepareDisplayContent(this.message.content || "", assistantMessage, this.plugin, this.view);
            try {
                yield RendererUtils.renderMarkdownContent(this.app, this.view, this.plugin, contentEl, displayContent);
            }
            catch (error) {
                contentEl.setText(`[Error rendering assistant content: ${error instanceof Error ? error.message : String(error)}]`);
            }
            AssistantMessageRenderer.addAssistantActionButtons(messageEl, contentEl, assistantMessage, this.plugin, this.view);
            BaseMessageRenderer.addTimestamp(messageEl, this.message.timestamp, this.view);
            setTimeout(() => {
                if (messageEl.isConnected && contentEl.closest(`.${CSS_CLASSES.MESSAGE_GROUP || "message-group"}`)) {
                    this.view.checkMessageForCollapsing(messageEl);
                }
            }, 70);
            return messageGroup;
        });
    }
    static addAssistantActionButtons(messageElement, contentEl, message, plugin, view) {
        if (messageElement.querySelector(`.${CSS_CLASSES.MESSAGE_ACTIONS}`)) {
            return;
        }
        const buttonsWrapper = messageElement.createDiv({ cls: CSS_CLASSES.MESSAGE_ACTIONS });
        const originalLlMRawContent = message.content || "";
        const copyBtn = buttonsWrapper.createEl("button", {
            cls: [CSS_CLASSES.COPY_BUTTON || "copy-button", CSS_CLASSES.MESSAGE_ACTION_BUTTON || "message-action-button"],
            attr: { "aria-label": "Copy", title: "Copy" },
        });
        setIcon(copyBtn, "copy");
        view.registerDomEvent(copyBtn, "click", e => {
            e.stopPropagation();
            view.handleCopyClick(originalLlMRawContent, copyBtn);
        });
        if (plugin.settings.enableTranslation &&
            ((plugin.settings.translationProvider === "google" && plugin.settings.googleTranslationApiKey) ||
                (plugin.settings.translationProvider === "ollama" && plugin.settings.ollamaTranslationModel)) &&
            originalLlMRawContent &&
            originalLlMRawContent.trim()) {
            const translateBtn = buttonsWrapper.createEl("button", {
                cls: [
                    CSS_CLASSES.TRANSLATE_BUTTON || "translate-button",
                    CSS_CLASSES.MESSAGE_ACTION_BUTTON || "message-action-button",
                ],
                attr: { "aria-label": "Translate", title: "Translate" },
            });
            setIcon(translateBtn, "languages");
            view.registerDomEvent(translateBtn, "click", e => {
                e.stopPropagation();
                if (contentEl.isConnected) {
                    view.handleTranslateClick(originalLlMRawContent, contentEl, translateBtn);
                }
                else {
                    new Notice("Cannot translate: message content element not found.");
                }
            });
        }
        if (plugin.settings.enableSummarization &&
            plugin.settings.summarizationModelName &&
            originalLlMRawContent &&
            originalLlMRawContent.trim()) {
            const summarizeBtn = buttonsWrapper.createEl("button", {
                cls: [
                    CSS_CLASSES.SUMMARIZE_BUTTON || "summarize-button",
                    CSS_CLASSES.MESSAGE_ACTION_BUTTON || "message-action-button",
                ],
                attr: { title: "Summarize message" },
            });
            setIcon(summarizeBtn, "scroll-text");
            view.registerDomEvent(summarizeBtn, "click", e => {
                e.stopPropagation();
                view.handleSummarizeClick(originalLlMRawContent, summarizeBtn);
            });
        }
        const originalContentContainsTextualToolCall = typeof originalLlMRawContent === "string" && originalLlMRawContent.includes("<tool_call>");
        if ((!message.tool_calls || message.tool_calls.length === 0) && !originalContentContainsTextualToolCall) {
            const regenerateBtn = buttonsWrapper.createEl("button", {
                cls: [
                    CSS_CLASSES.REGENERATE_BUTTON || "regenerate-button",
                    CSS_CLASSES.MESSAGE_ACTION_BUTTON || "message-action-button",
                ],
                attr: { "aria-label": "Regenerate response", title: "Regenerate Response" },
            });
            setIcon(regenerateBtn, "refresh-cw");
            view.registerDomEvent(regenerateBtn, "click", e => {
                e.stopPropagation();
                view.handleRegenerateClick(message);
            });
        }
        const deleteBtn = buttonsWrapper.createEl("button", {
            cls: [
                CSS_CLASSES.DELETE_MESSAGE_BUTTON || "delete-message-button",
                CSS_CLASSES.DANGER_OPTION || "danger-option",
                CSS_CLASSES.MESSAGE_ACTION_BUTTON || "message-action-button",
            ],
            attr: { "aria-label": "Delete message", title: "Delete Message" },
        });
        setIcon(deleteBtn, "trash");
        view.registerDomEvent(deleteBtn, "click", e => {
            e.stopPropagation();
            view.handleDeleteMessageClick(message);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQU8sTUFBTSxFQUFFLE9BQU8sRUFBb0IsTUFBTSxVQUFVLENBQUM7QUFJbEUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUMzQyxPQUFPLEtBQUssYUFBYSxNQUFNLHlCQUF5QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTVELE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRTlELE1BQU0sT0FBTyx3QkFBeUIsU0FBUSxtQkFBbUI7SUFDL0QsWUFBWSxHQUFRLEVBQUUsTUFBb0IsRUFBRSxPQUF5QixFQUFFLElBQWdCO1FBQ3JGLEtBQUssQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNsQyxJQUFJLE9BQU8sQ0FBQyxJQUFJLEtBQUssV0FBVyxFQUFFLENBQUM7WUFDakMsTUFBTSxJQUFJLEtBQUssQ0FBQywwRUFBMEUsQ0FBQyxDQUFDO1FBQzlGLENBQUM7SUFDSCxDQUFDO0lBRU0sTUFBTSxDQUFDLHFCQUFxQixDQUNqQyxlQUF1QixFQUN2QixnQkFBa0MsRUFDbEMsTUFBb0IsRUFDcEIsSUFBZ0I7UUFFaEIsTUFBTSxtQkFBbUIsR0FBRyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDakUsSUFBSSxlQUFlLEdBQUcsSUFBSSxDQUFDLENBQUMseURBQXlEO1FBQ3pGLElBQUksaUJBQWlCLEdBQUcsRUFBRSxDQUFDO1FBQzNCLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxnQkFBZ0I7UUFDMUMsTUFBTSxFQUFFLEdBQUcsZ0JBQWdCLENBQUMs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QUMsRUFBRTtnQkFDaEQsQ0FBQyxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUNwQixJQUFJLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDdEMsQ0FBQyxDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsTUFBTSxTQUFTLEdBQUcsY0FBYyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUU7WUFDbEQsR0FBRyxFQUFFO2dCQUNILFdBQVcsQ0FBQyxxQkFBcUIsSUFBSSx1QkFBdUI7Z0JBQzVELFdBQVcsQ0FBQyxhQUFhLElBQUksZUFBZTtnQkFDNUMsV0FBVyxDQUFDLHFCQUFxQixJQUFJLHVCQUF1QjthQUM3RDtZQUNELElBQUksRUFBRSxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxLQUFLLEVBQUUsZ0JBQWdCLEVBQUU7U0FDbEUsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxDQUFDLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUM1QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRTtZQUM1QyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3pDLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBOb3RpY2UsIHNldEljb24sIE1hcmtkb3duUmVuZGVyZXIgfSBmcm9tIFwib2JzaWRpYW5cIjtcbmltcG9ydCB7IEFzc2lzdGFudE1lc3NhZ2UsIE1lc3NhZ2UsIFRvb2xDYWxsIH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5pbXBvcnQgT2xsYW1hUGx1Z2luIGZyb20gXCIuLi9tYWluXCI7XG5pbXBvcnQgeyBPbGxhbWFWaWV3IH0gZnJvbSBcIi4uL09sbGFtYVZpZXdcIjtcbmltcG9ydCB7IENTU19DTEFTU0VTIH0gZnJvbSBcIi4uL2NvbnN0YW50c1wiO1xuaW1wb3J0ICogYXMgUmVuZGVyZXJVdGlscyBmcm9tIFwiLi4vTWVzc2FnZVJlbmRlcmVyVXRpbHNcIjtcbmltcG9ydCB7IEJhc2VNZXNzYWdlUmVuZGVyZXIgfSBmcm9tIFwiLi9CYXNlTWVzc2FnZVJlbmRlcmVyXCI7XG5pbXBvcnQgeyBJTWVzc2FnZVJlbmRlcmVyIH0gZnJvbSBcIi4vSU1lc3NhZ2VSZW5kZXJlclwiO1xuaW1wb3J0IHsgcGFyc2VBbGxUZXh0dWFsVG9vbENhbGxzIH0gZnJvbSBcIkAvdXRpbHMvdG9vbFBhcnNlclwiO1xuXG5leHBvcnQgY2xhc3MgQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyIGV4dGVuZHMgQmFzZU1lc3NhZ2VSZW5kZXJlciBpbXBsZW1lbnRzIElNZXNzYWdlUmVuZGVyZXIge1xuICBjb25zdHJ1Y3RvcihhcHA6IEFwcCwgcGx1Z2luOiBPbGxhbWFQbHVnaW4sIG1lc3NhZ2U6IEFzc2lzdGFudE1lc3NhZ2UsIHZpZXc6IE9sbGFtYVZpZXcpIHtcbiAgICBzdXBlcihhcHAsIHBsdWdpbiwgbWVzc2FnZSwgdmlldyk7XG4gICAgaWYgKG1lc3NhZ2Uucm9sZSAhPT0gXCJhc3Npc3RhbnRcIikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyIGNhbiBvbmx5IHJlbmRlciBtZXNzYWdlcyB3aXRoIHJvbGUgJ2Fzc2lzdGFudCcuXCIpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgcHJlcGFyZURpc3BsYXlDb250ZW50KFxuICAgIG9yaWdpbmFsQ29udGVudDogc3RyaW5nLFxuICAgIGFzc2lzdGFudE1lc3NhZ2U6IEFzc2lzdGFudE1lc3NhZ2UsXG4gICAgcGx1Z2luOiBPbGxhbWFQbHVnaW4sXG4gICAgdmlldzogT2xsYW1hVmlld1xuICApOiBzdHJpbmcge1xuICAgIGNvbnN0IG1lc3NhZ2VUaW1lc3RhbXBMb2cgPSBhc3Npc3RhbnRNZXNzYWdlLnRpbWVzdGFtcC5nZXRUaW1lKCk7XG4gICAgbGV0IHRvb2xVc2FnZVByZWZpeCA9IFwi4oaSIFwiOyAvLyDQndCw0L/RgNC40LrQu9Cw0LQsINGB0YLRgNGW0LvQutCwINCw0LHQviDRltC60L7QvdC60LAg0ZbQvdGB0YLRgNGD0LzQtdC90YLRgyAo0LTQuNCyLiDQvdC40LbRh9C1KVxubGV0IHRvb2xNZXNzYWdlQWN0aW9uID0gXCJcIjtcbmNvbnN0IGxvZ2dlciA9IHBsdWdpbi5sb2dnZXI7IC8vINCU0LvRjyDQt9GA0YPRh9C90L7RgdGC0ZZcbiAgICBjb25zdCB0cyA9IGFzc2lzdGFudE1lc3NhZ2UudGltZXN0YW1wLmdldFRpbWUoKTtcblxuICAgIGNvbnN0IGRlY29kZWRDb250ZW50ID0gUmVuZGVyZXJVdGlscy5kZWNvZGVIdG1sRW50aXRpZXMob3JpZ2luYWxDb250ZW50KTtcblxuICAgIGNvbnN0IHRoaW5rRGV0ZWN0aW9uID0gUmVuZGVyZXJVdGlscy5kZXRlY3RUaGlua2luZ1RhZ3MoZGVjb2RlZENvbnRlbnQpO1xuICAgIGxldCBjb250ZW50QWZ0ZXJUaGlua1N0cmlwcGluZyA9IHRoaW5rRGV0ZWN0aW9uLmNvbnRlbnRXaXRob3V0VGFncztcblxuICAgIGNvbnN0IGhhc05hdGl2ZVRvb2xDYWxscyA9ICEhKGFzc2lzdGFudE1lc3NhZ2UudG9vbF9jYWxscyAmJiBhc3Npc3RhbnRNZXNzYWdlLnRvb2xfY2FsbHMubGVuZ3RoID4gMCk7XG4gICAgY29uc3QgaGFzVGV4dHVhbFRvb2xDYWxsVGFnc0luUHJvY2Vzc2VkQ29udGVudCA9IGNvbnRlbnRBZnRlclRoaW5rU3RyaXBwaW5nLmluY2x1ZGVzKFwiPHRvb2xfY2FsbD5cIik7XG5cbiAgICBsZXQgZmluYWxEaXNwbGF5Q29udGVudCA9IGNvbnRlbnRBZnRlclRoaW5rU3RyaXBwaW5nO1xuICAgIGlmIChwbHVnaW4uc2V0dGluZ3MuZW5hYmxlVG9vbFVzZSAmJiAoaGFzTmF0aXZlVG9vbENhbGxzIHx8IGhhc1RleHR1YWxUb29sQ2FsbFRhZ3NJblByb2Nlc3NlZENvbnRlbnQpKSB7XG4gICAgICAgIFxuICAgICAgICBsZXQgdG9vbFVzYWdlSW5kaWNhdG9yQWN0aW9uVGV4dCA9IFwiXCI7XG4gICAgICAgIGNvbnN0IHRvb2xOYW1lc0V4dHJhY3RlZDogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgLy8g0KLQtdC60YHRgiwg0YnQviDQt9Cw0LvQuNGI0LjRgtGM0YHRjyDQn9CG0KHQm9CvINCy0LjQtNCw0LvQtdC90L3RjyA8dG9vbF9jYWxsPiDRgtC10LPRltCyINC3IGNvbnRlbnRUb1Byb2Nlc3MgKNGP0LrQuNC5INCy0LbQtSDQsdC10LcgPHRoaW5rPilcbiAgICAgICAgbGV0IGFjY29tcGFueWluZ1RleHQgPSBjb250ZW50QWZ0ZXJUaGlua1N0cmlwcGluZzsgXG5cbiAgICAgICAgaWYgKGhhc05hdGl2ZVRvb2xDYWxscyAmJiBhc3Npc3RhbnRNZXNzYWdlLnRvb2xfY2FsbHMpIHtcbiAgICAgICAgICAgIGFzc2lzdGFudE1lc3NhZ2UudG9vbF9jYWxscy5mb3JFYWNoKHRjID0+IHRvb2xOYW1lc0V4dHJhY3RlZC5wdXNoKHRjLmZ1bmN0aW9uLm5hbWUpKTtcbiAgICAgICAgICAgIC8vINCU0LvRjyDQvdCw0YLQuNCy0L3QuNGFINCy0LjQutC70LjQutGW0LIsIGBhY2NvbXBhbnlpbmdUZXh0YCAo0Y/QutC40Lkg0ZQgYGNvbnRlbnRUb1Byb2Nlc3NgKVxuICAgICAgICAgICAgLy8g0YbQtSDRgtC10LrRgdGCLCDRidC+INC80ZbQsyDQsdGD0YLQuCDRgNCw0LfQvtC8INC3INC90LDRgtC40LLQvdC40LzQuCB0b29sX2NhbGxzICjQstC20LUg0LHQtdC3IDx0aGluaz4pLlxuICAgICAgICAgICAgLy8g0JzQuCDQvdC1INCy0LjQtNCw0LvRj9GU0LzQviDQtyDQvdGM0L7Qs9C+INC90ZbRh9C+0LPQviDQtNC+0LTQsNGC0LrQvtCy0L4g0L3QsCDRhtGM0L7QvNGDINC10YLQsNC/0ZYuXG4gICAgICAgIH0gZWxzZSBpZiAoaGFzVGV4dHVhbFRvb2xDYWxsVGFnc0luUHJvY2Vzc2VkQ29udGVudCkgeyBcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8g0JLQuNC60L7RgNC40YHRgtC+0LLRg9GU0LzQviBwYXJzZUFsbFRleHR1YWxUb29sQ2FsbHMg0LcgT2xsYW1hVmlldyDQtNC70Y8g0L7RgtGA0LjQvNCw0L3QvdGPINGW0LzQtdC9XG4gICAgICAgICAgICAvLyDQktCw0LbQu9C40LLQviwg0YnQviBwYXJzZUFsbFRleHR1YWxUb29sQ2FsbHMg0L7RgtGA0LjQvNGD0ZQg0YLQtdC60YHRgiwg0LTQtSDQktCW0JUg0J3QldCc0JDQhCA8dGhpbms+INGC0LXQs9GW0LJcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlZFRleHR1YWxDYWxscyA9IHBhcnNlQWxsVGV4dHVhbFRvb2xDYWxscyhjb250ZW50QWZ0ZXJUaGlua1N0cmlwcGluZywgbG9nZ2VyKTsgXG4gICAgICAgICAgICBwYXJzZWRUZXh0dWFsQ2FsbHMuZm9yRWFjaChwdGMgPT4gdG9vbE5hbWVzRXh0cmFjdGVkLnB1c2gocHRjLm5hbWUpKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8g0JLQuNC00LDQu9GP0ZTQvNC+IDx0b29sX2NhbGw+INGC0LXQs9C4INC3IGNvbnRlbnRUb1Byb2Nlc3Mg0LTQu9GPINC+0YLRgNC40LzQsNC90L3RjyDRgdGD0L/RgNC+0LLRltC00L3QvtCz0L4g0YLQtdC60YHRgtGDXG4gICAgICAgICAgICAvLyDQptC10LkgcmVwbGFjZSDQvNC+0LbQtSDQsdGD0YLQuCDQv9GA0L7QsdC70LXQvNCw0YLQuNGH0L3QuNC8LCDRj9C60YnQviDRgtC10LPQuCDQv9C+0YjQutC+0LTQttC10L3RllxuICAgICAgICAgICAgYWNjb21wYW55aW5nVGV4dCA9IGNvbnRlbnRBZnRlclRoaW5rU3RyaXBwaW5nLnJlcGxhY2UoLzx0b29sX2NhbGw+W1xcc1xcU10qPzxcXC90b29sX2NhbGw+L2csIFwiXCIpLnRyaW0oKTtcblxuICAgICAgICAgICAgLy8g0JTQvtC00LDRgtC60L7QstC1IFwi0LPRgNGD0LHQtVwiINC+0YfQuNGJ0LXQvdC90Y8sINGP0LrRidC+INC/0L7Qv9C10YDQtdC00L3RlCDQvdC1INGB0L/RgNCw0YbRjtCy0LDQu9C+INGW0LTQtdCw0LvRjNC90L5cbiAgICAgICAgICAgIC8vINGWINGP0LrRidC+INGW0LzQtdC90LAg0L3QtSDQsdGD0LvQuCDQstC40YLRj9Cz0L3Rg9GC0ZYgKNGJ0L4g0LzQvtC20LUg0LLQutCw0LfRg9Cy0LDRgtC4INC90LAg0L/RgNC+0LHQu9C10LzQuCDQtyDRgtC10LPQsNC80LgpXG4gICAgICAgICAgICBpZiAodG9vbE5hbWVzRXh0cmFjdGVkLmxlbmd0aCA9PT0gMCAmJiAoYWNjb21wYW55aW5nVGV4dC5pbmNsdWRlcyhcIjx0b29sX2NhbGw+XCIpIHx8IGFjY29tcGFueWluZ1RleHQuaW5jbHVkZXMoXCI8L3Rvb2xfY2FsbD5cIikpKSB7XG4gICAgICAgICAgICAgICAgbGV0IHRlbXBUZXh0ID0gYWNjb21wYW55aW5nVGV4dDtcbiAgICAgICAgICAgICAgICB0ZW1wVGV4dCA9IHRlbXBUZXh0LnJlcGxhY2UoLzx0b29sX2NhbGw+L2csIFwiXCIpLnJlcGxhY2UoLzxcXC90b29sX2NhbGw+L2csIFwiXCIpLnRyaW0oKTtcbiAgICAgICAgICAgICAgICBhY2NvbXBhbnlpbmdUZXh0ID0gdGVtcFRleHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyDQpNC+0YDQvNGD0ZTQvNC+INGC0LXQutGB0YIg0LTQu9GPINGW0L3QtNC40LrQsNGC0L7RgNCwXG4gICAgICAgIGlmICh0b29sTmFtZXNFeHRyYWN0ZWQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdG9vbFVzYWdlSW5kaWNhdG9yQWN0aW9uVGV4dCA9IGBVc2luZyB0b29sJHt0b29sTmFtZXNFeHRyYWN0ZWQubGVuZ3RoID4gMSA/ICdzJyA6ICcnfTogJHt0b29sTmFtZXNFeHRyYWN0ZWQuam9pbignLCAnKX0uLi5gO1xuICAgICAgICB9IGVsc2UgeyBcbiAgICAgICAgICAgIHRvb2xVc2FnZUluZGljYXRvckFjdGlvblRleHQgPSBcIkF0dGVtcHRpbmcgdG8gdXNlIHRvb2wocykuLi5cIjtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8g0J7QsdCz0L7RgNGC0LDRlNC80L4g0ZbQvdC00LjQutCw0YLQvtGAINCyIHNwYW4g0LfRliDRgdC/0LXRhtGW0LDQu9GM0L3QuNC8INC60LvQsNGB0L7QvFxuICAgICAgICBjb25zdCB0b29sVXNhZ2VJbmRpY2F0b3JIVE1MID0gYDxzcGFuIGNsYXNzPVwiJHtDU1NfQ0xBU1NFUy5BU1NJU1RBTlRfVE9PTF9VU0FHRV9JTkRJQ0FUT1IgfHwgJ2Fzc2lzdGFudC10b29sLXVzYWdlLWluZGljYXRvcid9XCI+4oaSICR7dG9vbFVzYWdlSW5kaWNhdG9yQWN0aW9uVGV4dH08L3NwYW4+YDtcblxuICAgICAgICAvLyDQl9Cx0LjRgNCw0ZTQvNC+INGE0ZbQvdCw0LvRjNC90LjQuSDQutC+0L3RgtC10L3RgiDQtNC70Y8g0LLRltC00L7QsdGA0LDQttC10L3QvdGPXG4gICAgICAgIGlmIChhY2NvbXBhbnlpbmdUZXh0ICYmIGFjY29tcGFueWluZ1RleHQudHJpbSgpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGZpbmFsRGlzcGxheUNvbnRlbnQgPSBgJHt0b29sVXNhZ2VJbmRpY2F0b3JIVE1MfVxcblxcbiR7YWNjb21wYW55aW5nVGV4dC50cmltKCl9YDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZpbmFsRGlzcGxheUNvbnRlbnQgPSB0b29sVXNhZ2VJbmRpY2F0b3JIVE1MO1xuICAgICAgICB9XG4gICAgfVxuXG5cbiAgICByZXR1cm4gZmluYWxEaXNwbGF5Q29udGVudDtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZW5kZXIoKTogUHJvbWlzZTxIVE1MRWxlbWVudD4ge1xuICAgIGNvbnN0IG1lc3NhZ2VUaW1lc3RhbXBMb2cgPSB0aGlzLm1lc3NhZ2UudGltZXN0YW1wLmdldFRpbWUoKTtcblxuICAgIGNvbnN0IG1lc3NhZ2VHcm91cCA9IHRoaXMuY3JlYXRlTWVzc2FnZUdyb3VwV3JhcHBlcihbQ1NTX0NMQVNTRVMuT0xMQU1BX0dST1VQIHx8IFwib2xsYW1hLW1lc3NhZ2UtZ3JvdXBcIl0pO1xuICAgIFJlbmRlcmVyVXRpbHMucmVuZGVyQXZhdGFyKHRoaXMuYXBwLCB0aGlzLnBsdWdpbiwgbWVzc2FnZUdyb3VwLCBmYWxzZSwgXCJhc3Npc3RhbnRcIik7XG4gICAgY29uc3QgbWVzc2FnZVdyYXBwZXIgPSBtZXNzYWdlR3JvdXAuY3JlYXRlRGl2KHsgY2xzOiBDU1NfQ0xBU1NFUy5NRVNTQUdFX1dSQVBQRVIgfHwgXCJtZXNzYWdlLXdyYXBwZXJcIiB9KTtcbiAgICBtZXNzYWdlV3JhcHBlci5zdHlsZS5vcmRlciA9IFwiMlwiO1xuICAgIGNvbnN0IHsgbWVzc2FnZUVsLCBjb250ZW50RWwgfSA9IHRoaXMuY3JlYXRlTWVzc2FnZUJ1YmJsZShtZXNzYWdlV3JhcHBlciwgW1xuICAgICAgQ1NTX0NMQVNTRVMuT0xMQU1BX01FU1NBR0UgfHwgXCJvbGxhbWEtbWVzc2FnZVwiLFxuICAgIF0pO1xuICAgIGNvbnRlbnRFbC5hZGRDbGFzcyhDU1NfQ0xBU1NFUy5DT05URU5UX0NPTExBUFNJQkxFIHx8IFwibWVzc2FnZS1jb250ZW50LWNvbGxhcHNpYmxlXCIpO1xuXG4gICAgY29uc3QgYXNzaXN0YW50TWVzc2FnZSA9IHRoaXMubWVzc2FnZSBhcyBBc3Npc3RhbnRNZXNzYWdlO1xuXG4gICAgY29uc3QgZGlzcGxheUNvbnRlbnQgPSBBc3Npc3RhbnRNZXNzYWdlUmVuZGVyZXIucHJlcGFyZURpc3BsYXlDb250ZW50KFxuICAgICAgdGhpcy5tZXNzYWdlLmNvbnRlbnQgfHwgXCJcIixcbiAgICAgIGFzc2lzdGFudE1lc3NhZ2UsXG4gICAgICB0aGlzLnBsdWdpbixcbiAgICAgIHRoaXMudmlld1xuICAgICk7XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgUmVuZGVyZXJVdGlscy5yZW5kZXJNYXJrZG93bkNvbnRlbnQodGhpcy5hcHAsIHRoaXMudmlldywgdGhpcy5wbHVnaW4sIGNvbnRlbnRFbCwgZGlzcGxheUNvbnRlbnQpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb250ZW50RWwuc2V0VGV4dChcbiAgICAgICAgYFtFcnJvciByZW5kZXJpbmcgYXNzaXN0YW50IGNvbnRlbnQ6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiBTdHJpbmcoZXJyb3IpfV1gXG4gICAgICApO1xuICAgIH1cblxuICAgIEFzc2lzdGFudE1lc3NhZ2VSZW5kZXJlci5hZGRBc3Npc3RhbnRBY3Rpb25CdXR0b25zKG1lc3NhZ2VFbCwgY29udGVudEVsLCBhc3Npc3RhbnRNZXNzYWdlLCB0aGlzLnBsdWdpbiwgdGhpcy52aWV3KTtcbiAgICBCYXNlTWVzc2FnZVJlbmRlcmVyLmFkZFRpbWVzdGFtcChtZXNzYWdlRWwsIHRoaXMubWVzc2FnZS50aW1lc3RhbXAsIHRoaXMudmlldyk7XG5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIGlmIChtZXNzYWdlRWwuaXNDb25uZWN0ZWQgJiYgY29udGVudEVsLmNsb3Nlc3QoYC4ke0NTU19DTEFTU0VTLk1FU1NBR0VfR1JPVVAgfHwgXCJtZXNzYWdlLWdyb3VwXCJ9YCkpIHtcbiAgICAgICAgdGhpcy52aWV3LmNoZWNrTWVzc2FnZUZvckNvbGxhcHNpbmcobWVzc2FnZUVsKTtcbiAgICAgIH1cbiAgICB9LCA3MCk7XG5cbiAgICByZXR1cm4gbWVzc2FnZUdyb3VwO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBhZGRBc3Npc3RhbnRBY3Rpb25CdXR0b25zKFxuICAgIG1lc3NhZ2VFbGVtZW50OiBIVE1MRWxlbWVudCxcbiAgICBjb250ZW50RWw6IEhUTUxFbGVtZW50LFxuICAgIG1lc3NhZ2U6IEFzc2lzdGFudE1lc3NhZ2UsXG4gICAgcGx1Z2luOiBPbGxhbWFQbHVnaW4sXG4gICAgdmlldzogT2xsYW1hVmlld1xuICApOiB2b2lkIHtcbiAgICBpZiAobWVzc2FnZUVsZW1lbnQucXVlcnlTZWxlY3RvcihgLiR7Q1NTX0NMQVNTRVMuTUVTU0FHRV9BQ1RJT05TfWApKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYnV0dG9uc1dyYXBwZXIgPSBtZXNzYWdlRWxlbWVudC5jcmVhdGVEaXYoeyBjbHM6IENTU19DTEFTU0VTLk1FU1NBR0VfQUNUSU9OUyB9KTtcbiAgICBjb25zdCBvcmlnaW5hbExsTVJhd0NvbnRlbnQgPSBtZXNzYWdlLmNvbnRlbnQgfHwgXCJcIjtcblxuICAgIGNvbnN0IGNvcHlCdG4gPSBidXR0b25zV3JhcHBlci5jcmVhdGVFbChcImJ1dHRvblwiLCB7XG4gICAgICBjbHM6IFtDU1NfQ0xBU1NFUy5DT1BZX0JVVFRPTiB8fCBcImNvcHktYnV0dG9uXCIsIENTU19DTEFTU0VTLk1FU1NBR0VfQUNUSU9OX0JVVFRPTiB8fCBcIm1lc3NhZ2UtYWN0aW9uLWJ1dHRvblwiXSxcbiAgICAgIGF0dHI6IHsgXCJhcmlhLWxhYmVsXCI6IFwiQ29weVwiLCB0aXRsZTogXCJDb3B5XCIgfSxcbiAgICB9KTtcbiAgICBzZXRJY29uKGNvcHlCdG4sIFwiY29weVwiKTtcbiAgICB2aWV3LnJlZ2lzdGVyRG9tRXZlbnQoY29weUJ0biwgXCJjbGlja1wiLCBlID0+IHtcbiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICB2aWV3LmhhbmRsZUNvcHlDbGljayhvcmlnaW5hbExsTVJhd0NvbnRlbnQsIGNvcHlCdG4pO1xuICAgIH0pO1xuXG4gICAgaWYgKFxuICAgICAgcGx1Z2luLnNldHRpbmdzLmVuYWJsZVRyYW5zbGF0aW9uICYmXG4gICAgICAoKHBsdWdpbi5zZXR0aW5ncy50cmFuc2xhdGlvblByb3ZpZGVyID09PSBcImdvb2dsZVwiICYmIHBsdWdpbi5zZXR0aW5ncy5nb29nbGVUcmFuc2xhdGlvbkFwaUtleSkgfHxcbiAgICAgICAgKHBsdWdpbi5zZXR0aW5ncy50cmFuc2xhdGlvblByb3ZpZGVyID09PSBcIm9sbGFtYVwiICYmIHBsdWdpbi5zZXR0aW5ncy5vbGxhbWFUcmFuc2xhdGlvbk1vZGVsKSkgJiZcbiAgICAgIG9yaWdpbmFsTGxNUmF3Q29udGVudCAmJlxuICAgICAgb3JpZ2luYWxMbE1SYXdDb250ZW50LnRyaW0oKVxuICAgICkge1xuICAgICAgY29uc3QgdHJhbnNsYXRlQnRuID0gYnV0dG9uc1dyYXBwZXIuY3JlYXRlRWwoXCJidXR0b25cIiwge1xuICAgICAgICBjbHM6IFtcbiAgICAgICAgICBDU1NfQ0xBU1NFUy5UUkFOU0xBVEVfQlVUVE9OIHx8IFwidHJhbnNsYXRlLWJ1dHRvblwiLFxuICAgICAgICAgIENTU19DTEFTU0VTLk1FU1NBR0VfQUNUSU9OX0JVVFRPTiB8fCBcIm1lc3NhZ2UtYWN0aW9uLWJ1dHRvblwiLFxuICAgICAgICBdLFxuICAgICAgICBhdHRyOiB7IFwiYXJpYS1sYWJlbFwiOiBcIlRyYW5zbGF0ZVwiLCB0aXRsZTogXCJUcmFuc2xhdGVcIiB9LFxuICAgICAgfSk7XG4gICAgICBzZXRJY29uKHRyYW5zbGF0ZUJ0biwgXCJsYW5ndWFnZXNcIik7XG4gICAgICB2aWV3LnJlZ2lzdGVyRG9tRXZlbnQodHJhbnNsYXRlQnRuLCBcImNsaWNrXCIsIGUgPT4ge1xuICAgICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgICBpZiAoY29udGVudEVsLmlzQ29ubmVjdGVkKSB7XG4gICAgICAgICAgdmlldy5oYW5kbGVUcmFuc2xhdGVDbGljayhvcmlnaW5hbExsTVJhd0NvbnRlbnQsIGNvbnRlbnRFbCwgdHJhbnNsYXRlQnRuKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBuZXcgTm90aWNlKFwiQ2Fubm90IHRyYW5zbGF0ZTogbWVzc2FnZSBjb250ZW50IGVsZW1lbnQgbm90IGZvdW5kLlwiKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgcGx1Z2luLnNldHRpbmdzLmVuYWJsZVN1bW1hcml6YXRpb24gJiZcbiAgICAgIHBsdWdpbi5zZXR0aW5ncy5zdW1tYXJpemF0aW9uTW9kZWxOYW1lICYmXG4gICAgICBvcmlnaW5hbExsTVJhd0NvbnRlbnQgJiZcbiAgICAgIG9yaWdpbmFsTGxNUmF3Q29udGVudC50cmltKClcbiAgICApIHtcbiAgICAgIGNvbnN0IHN1bW1hcml6ZUJ0biA9IGJ1dHRvbnNXcmFwcGVyLmNyZWF0ZUVsKFwiYnV0dG9uXCIsIHtcbiAgICAgICAgY2xzOiBbXG4gICAgICAgICAgQ1NTX0NMQVNTRVMuU1VNTUFSSVpFX0JVVFRPTiB8fCBcInN1bW1hcml6ZS1idXR0b25cIixcbiAgICAgICAgICBDU1NfQ0xBU1NFUy5NRVNTQUdFX0FDVElPTl9CVVRUT04gfHwgXCJtZXNzYWdlLWFjdGlvbi1idXR0b25cIixcbiAgICAgICAgXSxcbiAgICAgICAgYXR0cjogeyB0aXRsZTogXCJTdW1tYXJpemUgbWVzc2FnZVwiIH0sXG4gICAgICB9KTtcbiAgICAgIHNldEljb24oc3VtbWFyaXplQnRuLCBcInNjcm9sbC10ZXh0XCIpO1xuICAgICAgdmlldy5yZWdpc3RlckRvbUV2ZW50KHN1bW1hcml6ZUJ0biwgXCJjbGlja1wiLCBlID0+IHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgICAgdmlldy5oYW5kbGVTdW1tYXJpemVDbGljayhvcmlnaW5hbExsTVJhd0NvbnRlbnQsIHN1bW1hcml6ZUJ0bik7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBjb25zdCBvcmlnaW5hbENvbnRlbnRDb250YWluc1RleHR1YWxUb29sQ2FsbCA9XG4gICAgICB0eXBlb2Ygb3JpZ2luYWxMbE1SYXdDb250ZW50ID09PSBcInN0cmluZ1wiICYmIG9yaWdpbmFsTGxNUmF3Q29udGVudC5pbmNsdWRlcyhcIjx0b29sX2NhbGw+XCIpO1xuXG4gICAgaWYgKCghbWVzc2FnZS50b29sX2NhbGxzIHx8IG1lc3NhZ2UudG9vbF9jYWxscy5sZW5ndGggPT09IDApICYmICFvcmlnaW5hbENvbnRlbnRDb250YWluc1RleHR1YWxUb29sQ2FsbCkge1xuICAgICAgY29uc3QgcmVnZW5lcmF0ZUJ0biA9IGJ1dHRvbnNXcmFwcGVyLmNyZWF0ZUVsKFwiYnV0dG9uXCIsIHtcbiAgICAgICAgY2xzOiBbXG4gICAgICAgICAgQ1NTX0NMQVNTRVMuUkVHRU5FUkFURV9CVVRUT04gfHwgXCJyZWdlbmVyYXRlLWJ1dHRvblwiLFxuICAgICAgICAgIENTU19DTEFTU0VTLk1FU1NBR0VfQUNUSU9OX0JVVFRPTiB8fCBcIm1lc3NhZ2UtYWN0aW9uLWJ1dHRvblwiLFxuICAgICAgICBdLFxuICAgICAgICBhdHRyOiB7IFwiYXJpYS1sYWJlbFwiOiBcIlJlZ2VuZXJhdGUgcmVzcG9uc2VcIiwgdGl0bGU6IFwiUmVnZW5lcmF0ZSBSZXNwb25zZVwiIH0sXG4gICAgICB9KTtcbiAgICAgIHNldEljb24ocmVnZW5lcmF0ZUJ0biwgXCJyZWZyZXNoLWN3XCIpO1xuICAgICAgdmlldy5yZWdpc3RlckRvbUV2ZW50KHJlZ2VuZXJhdGVCdG4sIFwiY2xpY2tcIiwgZSA9PiB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgICAgIHZpZXcuaGFuZGxlUmVnZW5lcmF0ZUNsaWNrKG1lc3NhZ2UpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgZGVsZXRlQnRuID0gYnV0dG9uc1dyYXBwZXIuY3JlYXRlRWwoXCJidXR0b25cIiwge1xuICAgICAgY2xzOiBbXG4gICAgICAgIENTU19DTEFTU0VTLkRFTEVURV9NRVNTQUdFX0JVVFRPTiB8fCBcImRlbGV0ZS1tZXNzYWdlLWJ1dHRvblwiLFxuICAgICAgICBDU1NfQ0xBU1NFUy5EQU5HRVJfT1BUSU9OIHx8IFwiZGFuZ2VyLW9wdGlvblwiLFxuICAgICAgICBDU1NfQ0xBU1NFUy5NRVNTQUdFX0FDVElPTl9CVVRUT04gfHwgXCJtZXNzYWdlLWFjdGlvbi1idXR0b25cIixcbiAgICAgIF0sXG4gICAgICBhdHRyOiB7IFwiYXJpYS1sYWJlbFwiOiBcIkRlbGV0ZSBtZXNzYWdlXCIsIHRpdGxlOiBcIkRlbGV0ZSBNZXNzYWdlXCIgfSxcbiAgICB9KTtcbiAgICBzZXRJY29uKGRlbGV0ZUJ0biwgXCJ0cmFzaFwiKTtcbiAgICB2aWV3LnJlZ2lzdGVyRG9tRXZlbnQoZGVsZXRlQnRuLCBcImNsaWNrXCIsIGUgPT4ge1xuICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICAgIHZpZXcuaGFuZGxlRGVsZXRlTWVzc2FnZUNsaWNrKG1lc3NhZ2UpO1xuICAgIH0pO1xuICB9XG59XG4iXX0=