import { __awaiter } from "tslib";
// src/renderers/AssistantMessageRenderer.ts
import { Notice, setIcon } from "obsidian";
import { CSS_CLASSES } from "../constants";
import * as RendererUtils from "../MessageRendererUtils";
import { BaseMessageRenderer } from "./BaseMessageRenderer";
import { parseAllTextualToolCalls } from "@/utils/toolParser";
export class AssistantMessageRenderer extends BaseMessageRenderer {
    constructor(app, plugin, message, view) {
        super(app, plugin, message, view);
        if (message.role !== "assistant") {
            plugin.logger.error("[AssistantMessageRenderer] Constructor error: Message role is not 'assistant'. Received:", message.role);
            throw new Error("AssistantMessageRenderer can only render messages with role 'assistant'.");
        }
    }
    // В AssistantMessageRenderer.ts
    static prepareDisplayContent(originalContent, assistantMessage, plugin, view // Потрібен для parseAllTextualToolCalls
    ) {
        const ts = assistantMessage.timestamp.getTime();
        plugin.logger.debug(`[PREP][ts:${ts}] === Starting prepareDisplayContent ===`);
        plugin.logger.debug(`[PREP][ts:${ts}] 1. Original content:\n"${originalContent}"`);
        const decodedContent = RendererUtils.decodeHtmlEntities(originalContent);
        plugin.logger.debug(`[PREP][ts:${ts}] 2. Content after decodeHtmlEntities:\n"${decodedContent}"`);
        const thinkDetection = RendererUtils.detectThinkingTags(decodedContent);
        let contentAfterThinkStripping = thinkDetection.contentWithoutTags;
        plugin.logger.debug(`[PREP][ts:${ts}] 3. Content after detectThinkingTags (hasThink: ${thinkDetection.hasThinkingTags}):\n"${contentAfterThinkStripping}"`);
        const hasNativeToolCalls = !!(assistantMessage.tool_calls && assistantMessage.tool_calls.length > 0);
        const hasTextualToolCallTagsInContentAfterThinkStripping = contentAfterThinkStripping.includes("<tool_call>");
        plugin.logger.debug(`[PREP][ts:${ts}] 4. Tool checks: enableToolUse=${plugin.settings.enableToolUse}, hasNativeToolCalls=${hasNativeToolCalls}, hasTextualToolCallTagsInContentAfterThinkStripping=${hasTextualToolCallTagsInContentAfterThinkStripping}`);
        let finalDisplayContent = contentAfterThinkStripping; // Початкове значення
        if (plugin.settings.enableToolUse && (hasNativeToolCalls || hasTextualToolCallTagsInContentAfterThinkStripping)) {
            plugin.logger.info(`[PREP][ts:${ts}] 5. Tool call indicators detected. Formatting for display.`);
            let usingToolMessageText = "( ";
            const toolNamesExtracted = [];
            let accompanyingText = contentAfterThinkStripping; // Текст, з якого будемо видаляти <tool_call>
            if (hasNativeToolCalls && assistantMessage.tool_calls) {
                plugin.logger.debug(`[PREP][ts:${ts}] 5a. Processing NATIVE tool_calls. Count: ${assistantMessage.tool_calls.length}`);
                assistantMessage.tool_calls.forEach(tc => toolNamesExtracted.push(tc.function.name));
                // accompanyingText залишається contentAfterThinkStripping, оскільки нативні виклики не в тексті
            }
            else if (hasTextualToolCallTagsInContentAfterThinkStripping) {
                plugin.logger.debug(`[PREP][ts:${ts}] 5b. Processing TEXTUAL tool_call tags from: "${contentAfterThinkStripping.substring(0, 150)}..."`);
                // Використовуємо parseAllTextualToolCalls з OllamaView для отримання імен
                // Важливо, що parseAllTextualToolCalls отримує текст, де ВЖЕ НЕМАЄ <think> тегів
                const parsedTextualCalls = parseAllTextualToolCalls(contentAfterThinkStripping, plugin.logger);
                parsedTextualCalls.forEach(ptc => toolNamesExtracted.push(ptc.name));
                plugin.logger.debug(`[PREP][ts:${ts}] 5c. Extracted tool names via parseAllTextualToolCalls: [${toolNamesExtracted.join(', ')}]`);
                // Видаляємо <tool_call> теги з contentAfterThinkStripping для отримання супровідного тексту
                // Цей replace може бути проблематичним, якщо теги пошкоджені
                accompanyingText = contentAfterThinkStripping.replace(/<tool_call>[\s\S]*?<\/tool_call>/g, "").trim();
                plugin.logger.debug(`[PREP][ts:${ts}] 5d. Accompanying text after initial <tool_call> replace: "${accompanyingText}"`);
                // Додаткове "грубе" очищення, якщо попереднє не спрацювало ідеально
                if (accompanyingText.includes("<tool_call>") || accompanyingText.includes("</tool_call>")) {
                    plugin.logger.warn(`[PREP][ts:${ts}] Accompanying text still contains tool_call tags. Attempting forceful cleanup.`);
                    let tempText = accompanyingText;
                    // Видаляємо всі відкриваючі та закриваючі теги окремо
                    tempText = tempText.replace(/<tool_call>/g, "").replace(/<\/tool_call>/g, "").trim();
                    // Спробуємо видалити будь-які залишки JSON, якщо вони виглядають як початок об'єкта і не є частиною тексту
                    // Це ризиковано, може видалити легітимний текст.
                    // tempText = tempText.replace(/{\s*("name"|"arguments")\s*:[\s\S]*?}/g, "").trim();
                    accompanyingText = tempText;
                    plugin.logger.debug(`[PREP][ts:${ts}] 5e. Accompanying text after forceful cleanup: "${accompanyingText}"`);
                }
            }
            if (toolNamesExtracted.length > 0) {
                usingToolMessageText += `Using tool${toolNamesExtracted.length > 1 ? 's' : ''}: ${toolNamesExtracted.join(', ')}... `;
            }
            else {
                usingToolMessageText += "Attempting to use tool(s)... ";
                plugin.logger.warn(`[PREP][ts:${ts}] No tool names were extracted, using generic message.`);
            }
            usingToolMessageText += ")";
            if (accompanyingText && accompanyingText.trim().length > 0) {
                finalDisplayContent = `${usingToolMessageText}\n\n${accompanyingText.trim()}`;
            }
            else {
                finalDisplayContent = usingToolMessageText;
            }
        }
        // Якщо інструменти не використовуються або немає індикаторів, 
        // finalDisplayContent вже встановлено як contentAfterThinkStripping
        plugin.logger.info(`[PREP][ts:${ts}] === Final content for display ===:\n"${finalDisplayContent}"`);
        return finalDisplayContent;
    }
    render() {
        return __awaiter(this, void 0, void 0, function* () {
            var _a;
            const messageTimestampLog = this.message.timestamp.getTime();
            this.plugin.logger.debug(`[ARender INSTANCE][ts:${messageTimestampLog}] render() called. Original message content preview: "${(_a = this.message.content) === null || _a === void 0 ? void 0 : _a.substring(0, 150)}..."`);
            const messageGroup = this.createMessageGroupWrapper([CSS_CLASSES.OLLAMA_GROUP || "ollama-message-group"]);
            RendererUtils.renderAvatar(this.app, this.plugin, messageGroup, false, 'assistant');
            const messageWrapper = messageGroup.createDiv({ cls: CSS_CLASSES.MESSAGE_WRAPPER || "message-wrapper" });
            messageWrapper.style.order = "2";
            const { messageEl, contentEl } = this.createMessageBubble(messageWrapper, [CSS_CLASSES.OLLAMA_MESSAGE || "ollama-message"]);
            contentEl.addClass(CSS_CLASSES.CONTENT_COLLAPSIBLE || "message-content-collapsible");
            const assistantMessage = this.message;
            // Використовуємо статичний метод для підготовки контенту, передаючи this.view
            const displayContent = AssistantMessageRenderer.prepareDisplayContent(this.message.content || "", assistantMessage, this.plugin, this.view // <--- Передаємо this.view як четвертий аргумент
            );
            this.plugin.logger.debug(`[ARender INSTANCE][ts:${messageTimestampLog}] Content to render (from prepareDisplayContent): "${displayContent.substring(0, 150)}..."`);
            try {
                yield RendererUtils.renderMarkdownContent(this.app, this.view, this.plugin, contentEl, displayContent);
            }
            catch (error) {
                contentEl.setText(`[Error rendering assistant content: ${error instanceof Error ? error.message : String(error)}]`);
                this.plugin.logger.error(`[ARender INSTANCE][ts:${messageTimestampLog}] Error in render -> renderMarkdownContent:`, error);
            }
            AssistantMessageRenderer.addAssistantActionButtons(messageEl, contentEl, assistantMessage, this.plugin, this.view);
            BaseMessageRenderer.addTimestamp(messageEl, this.message.timestamp, this.view);
            setTimeout(() => {
                if (messageEl.isConnected && contentEl.closest(`.${CSS_CLASSES.MESSAGE_GROUP || "message-group"}`)) {
                    this.view.checkMessageForCollapsing(messageEl);
                }
            }, 70);
            return messageGroup;
        });
    }
    static addAssistantActionButtons(messageElement, contentEl, message, plugin, view) {
        if (messageElement.querySelector(`.${CSS_CLASSES.MESSAGE_ACTIONS}`)) {
            return;
        }
        const buttonsWrapper = messageElement.createDiv({ cls: CSS_CLASSES.MESSAGE_ACTIONS });
        const originalLlMRawContent = message.content || "";
        const copyBtn = buttonsWrapper.createEl("button", { cls: [CSS_CLASSES.COPY_BUTTON || "copy-button", CSS_CLASSES.MESSAGE_ACTION_BUTTON || "message-action-button"], attr: { "aria-label": "Copy", title: "Copy" } });
        setIcon(copyBtn, "copy");
        view.registerDomEvent(copyBtn, "click", e => { e.stopPropagation(); view.handleCopyClick(originalLlMRawContent, copyBtn); });
        if (plugin.settings.enableTranslation &&
            (plugin.settings.translationProvider === 'google' && plugin.settings.googleTranslationApiKey ||
                plugin.settings.translationProvider === 'ollama' && plugin.settings.ollamaTranslationModel) &&
            originalLlMRawContent && originalLlMRawContent.trim()) {
            const translateBtn = buttonsWrapper.createEl("button", { cls: [CSS_CLASSES.TRANSLATE_BUTTON || "translate-button", CSS_CLASSES.MESSAGE_ACTION_BUTTON || "message-action-button"], attr: { "aria-label": "Translate", title: "Translate" } });
            setIcon(translateBtn, "languages");
            view.registerDomEvent(translateBtn, "click", e => { e.stopPropagation(); if (contentEl.isConnected) {
                view.handleTranslateClick(originalLlMRawContent, contentEl, translateBtn);
            }
            else {
                new Notice("Cannot translate: message content element not found.");
            } });
        }
        if (plugin.settings.enableSummarization && plugin.settings.summarizationModelName && originalLlMRawContent && originalLlMRawContent.trim()) {
            const summarizeBtn = buttonsWrapper.createEl("button", { cls: [CSS_CLASSES.SUMMARIZE_BUTTON || "summarize-button", CSS_CLASSES.MESSAGE_ACTION_BUTTON || "message-action-button"], attr: { title: "Summarize message" } });
            setIcon(summarizeBtn, "scroll-text");
            view.registerDomEvent(summarizeBtn, "click", e => { e.stopPropagation(); view.handleSummarizeClick(originalLlMRawContent, summarizeBtn); });
        }
        const originalContentContainsTextualToolCall = typeof originalLlMRawContent === 'string' && originalLlMRawContent.includes("<tool_call>");
        if ((!message.tool_calls || message.tool_calls.length === 0) && !originalContentContainsTextualToolCall) {
            const regenerateBtn = buttonsWrapper.createEl("button", { cls: [CSS_CLASSES.REGENERATE_BUTTON || "regenerate-button", CSS_CLASSES.MESSAGE_ACTION_BUTTON || "message-action-button"], attr: { "aria-label": "Regenerate response", title: "Regenerate Response" } });
            setIcon(regenerateBtn, "refresh-cw");
            view.registerDomEvent(regenerateBtn, "click", (e) => { e.stopPropagation(); view.handleRegenerateClick(message); });
        }
        const deleteBtn = buttonsWrapper.createEl("button", { cls: [CSS_CLASSES.DELETE_MESSAGE_BUTTON || "delete-message-button", CSS_CLASSES.DANGER_OPTION || "danger-option", CSS_CLASSES.MESSAGE_ACTION_BUTTON || "message-action-button"], attr: { "aria-label": "Delete message", title: "Delete Message" } });
        setIcon(deleteBtn, "trash");
        view.registerDomEvent(deleteBtn, "click", e => { e.stopPropagation(); view.handleDeleteMessageClick(message); });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSw0Q0FBNEM7QUFDNUMsT0FBTyxFQUFPLE1BQU0sRUFBRSxPQUFPLEVBQW9CLE1BQU0sVUFBVSxDQUFDO0FBSWxFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDM0MsT0FBTyxLQUFLLGFBQWEsTUFBTSx5QkFBeUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUU1RCxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUU5RCxNQUFNLE9BQU8sd0JBQXlCLFNBQVEsbUJBQW1CO0lBRTdELFlBQVksR0FBUSxFQUFFLE1BQW9CLEVBQUUsT0FBeUIsRUFBRSxJQUFnQjtRQUNuRixLQUFLLENBQUMsR0FBRyxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDbEMsSUFBSSxPQUFPLENBQUMsSUFBSSxLQUFLLFdBQVcsRUFBRSxDQUFDO1lBQy9CLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLDBGQUEwRixFQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM5SCxNQUFNLElBQUksS0FBSyxDQUFDLDBFQUEwRSxDQUFDLENBQUM7UUFDaEcsQ0FBQztJQUNMLENBQUM7SUFFRCxnQ0FBZ0M7SUFDN0IsTUFBTSxDQUFDLHFCQUFxQixDQUMvQixlQUF1QixFQUN2QixnQkFBa0MsRUFDbEMsTUFBb0IsRUFDcEIsSUFBZ0IsQ0FBQyx3Q0FBd0M7O1FBRXpELE1BQU0sRUFBRSxHQUFHLGdCQUFnQixDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNoRCxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsMENBQTBDLENBQUMsQ0FBQztRQUMvRSxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsNEJBQTRCLGVBQWUsR0FBRyxDQUFDLENBQUM7UUFFbkYsTUFBTSxjQUFjLEdBQUcsYUFBYSxDQUFDLGtCQUFrQixDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3pFLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSw0Q0FBNEMsY0FBYyxHQUFHLENBQUMsQ0FBQztRQUVsRyxNQUFNLGNBQWMsR0FBRyxhQUFhLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDeEUsSUFBSSwwQkFBMEIsR0FBRyxjQUFjLENBQUMsa0JBQWtCLENBQUM7UUFDbkUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLG9EQUFvRCxjQUFjLENBQUMsZUFBZSxRQUFRLDBCQUEwQixHQUFHLENBQUMsQ0FBQztRQUU1SixNQUFNLGtCQUFrQixHQUFHLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDLFVBQVUsSUFBSSxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3JHLE1BQU0sa0RBQWtELEdBQUcsMEJBQTBCLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBQzlHLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRSxtQ0FBbUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxhQUFhLHdCQUF3QixrQkFBa0Isd0RBQXdELGtEQUFrRCxFQUFFLENBQUMsQ0FBQztRQUUzUCxJQUFJLG1CQUFtQixHQUFHLDBCQUEwQixDQUFDLENBQUMscUJBQXFCO1FBRTNFLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyxhQUFhLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxrREFBa0QsQ0FBQyxFQUFFLENBQUM7WUFDOUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLDZEQUE2RCxDQUFDLENBQUM7WUFFakcsSUFBSSxvQkFBb0IsR0FBRyxJQUFJLENBQUM7WUFDaEMsTUFBTSxrQkFBa0IsR0FBYSxFQUFFLENBQUM7WUFDeEMsSUFBSSxnQkFBZ0IsR0FBRywwQkFBMEIsQ0FBQyxDQUFDLDZDQUE2QztZQUVoRyxJQUFJLGtCQUFrQixJQUFJLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxDQUFDO2dCQUNwRCxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsOENBQThDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDO2dCQUN2SCxnQkFBZ0IsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDckYsZ0dBQWdHO1lBQ3BHLENBQUM7aUJBQU0sSUFBSSxrREFBa0QsRUFBRSxDQUFDO2dCQUM1RCxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsa0RBQWtELDBCQUEwQixDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2dCQUV4SSwwRUFBMEU7Z0JBQzFFLGlGQUFpRjtnQkFDakYsTUFBTSxrQkFBa0IsR0FBRyx3QkFBd0IsQ0FBQywwQkFBMEIsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQy9GLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDckUsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLDZEQUE2RCxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUVsSSw0RkFBNEY7Z0JBQzVGLDZEQUE2RDtnQkFDN0QsZ0JBQWdCLEdBQUcsMEJBQTBCLENBQUMsT0FBTyxDQUFDLG1DQUFtQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUN0RyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsK0RBQStELGdCQUFnQixHQUFHLENBQUMsQ0FBQztnQkFFdkgsb0VBQW9FO2dCQUNwRSxJQUFJLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsSUFBSSxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQztvQkFDeEYsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLGlGQUFpRixDQUFDLENBQUM7b0JBQ3JILElBQUksUUFBUSxHQUFHLGdCQUFnQixDQUFDO29CQUNoQyxzREFBc0Q7b0JBQ3RELFFBQVEsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLGNBQWMsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7b0JBQ3JGLDJHQUEyRztvQkFDM0csaURBQWlEO29CQUNqRCxvRkFBb0Y7b0JBQ3BGLGdCQUFnQixHQUFHLFFBQVEsQ0FBQztvQkFDNUIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLG9EQUFvRCxnQkFBZ0IsR0FBRyxDQUFDLENBQUM7Z0JBQ2hILENBQUM7WUFDTCxDQUFDO1lBRUQsSUFBSSxrQkFBa0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ2hDLG9CQUFvQixJQUFJLGFBQWEsa0JBQWtCLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssa0JBQWtCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7WUFDMUgsQ0FBQztpQkFBTSxDQUFDO2dCQUNKLG9CQUFvQixJQUFJLCtCQUErQixDQUFDO2dCQUN4RCxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsd0RBQXdELENBQUMsQ0FBQztZQUNoRyxDQUFDO1lBQ0Qsb0JBQW9CLElBQUksR0FBRyxDQUFDO1lBRTVCLElBQUksZ0JBQWdCLElBQUksZ0JBQWdCLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUN6RCxtQkFBbUIsR0FBRyxHQUFHLG9CQUFvQixPQUFPLGdCQUFnQixDQUFDLElBQUksRUFBRSxFQUFFLENBQUM7WUFDbEYsQ0FBQztpQkFBTSxDQUFDO2dCQUNKLG1CQUFtQixHQUFHLG9CQUFvQixDQUFDO1lBQy9DLENBQUM7UUFDTCxDQUFDO1FBQ0QsK0RBQStEO1FBQy9ELG9FQUFvRTtRQUVwRSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsMENBQTBDLG1CQUFtQixHQUFHLENBQUMsQ0FBQztRQUNwRyxPQUFPLG1CQUFtQixDQUFDO0lBQy9CLENBQUM7SUFFZ0IsTUFBTTs7O1lBQ2YsTUFBTSxtQkFBbUIsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUM3RCxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMseUJBQXlCLG1CQUFtQix5REFBeUQsTUFBQSxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sMENBQUUsU0FBUyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFN0ssTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLHlCQUF5QixDQUFDLENBQUMsV0FBVyxDQUFDLFlBQVksSUFBSSxzQkFBc0IsQ0FBQyxDQUFDLENBQUM7WUFDMUcsYUFBYSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxNQUFNLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxXQUFXLENBQUMsQ0FBQztZQUNwRixNQUFNLGNBQWMsR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxFQUFFLFdBQVcsQ0FBQyxlQUFlLElBQUksaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO1lBQ3pHLGNBQWMsQ0FBQyxLQUFLLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQztZQUNqQyxNQUFNLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FDckQsY0FBYyxFQUNkLENBQUMsV0FBVyxDQUFDLGNBQWMsSUFBSSxnQkFBZ0IsQ0FBQyxDQUNuRCxDQUFDO1lBQ0YsU0FBUyxDQUFDLFFBQVEsQ0FBQyxXQUFXLENBQUMsbUJBQW1CLElBQUksNkJBQTZCLENBQUMsQ0FBQztZQUVyRixNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxPQUEyQixDQUFDO1lBRTFELDhFQUE4RTtZQUM5RSxNQUFNLGNBQWMsR0FBRyx3QkFBd0IsQ0FBQyxxQkFBcUIsQ0FDakUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLElBQUksRUFBRSxFQUMxQixnQkFBZ0IsRUFDaEIsSUFBSSxDQUFDLE1BQU0sRUFDWCxJQUFJLENBQUMsSUFBSSxDQUFDLGlEQUFpRDthQUM5RCxDQUFDO1lBRUYsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLHlCQUF5QixtQkFBbUIsc0RBQXNELGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUVsSyxJQUFJLENBQUM7Z0JBQ0QsTUFBTSxhQUFhLENBQUMscUJBQXFCLENBQ3JDLElBQUksQ0FBQyxHQUFHLEVBQ1IsSUFBSSxDQUFDLElBQUksRUFDVCxJQUFJLENBQUMsTUFBTSxFQUNYLFNBQVMsRUFDVCxjQUFjLENBQ2pCLENBQUM7WUFDTixDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDWixTQUFTLENBQUMsT0FBTyxDQUFDLHVDQUF1QyxLQUFLLFlBQVksS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNwSCxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMseUJBQXlCLG1CQUFtQiw2Q0FBNkMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoSSxDQUFDO1lBRUQsd0JBQXdCLENBQUMseUJBQXlCLENBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNuSCxtQkFBbUIsQ0FBQyxZQUFZLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUUvRSxVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUNaLElBQUksU0FBUyxDQUFDLFdBQVcsSUFBSSxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksV0FBVyxDQUFDLGFBQWEsSUFBSSxlQUFlLEVBQUUsQ0FBQyxFQUFFLENBQUM7b0JBQ2pHLElBQUksQ0FBQyxJQUFJLENBQUMseUJBQXlCLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQ25ELENBQUM7WUFDTCxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFFUCxPQUFPLFlBQVksQ0FBQztRQUN4QixDQUFDO0tBQUE7SUFFTSxNQUFNLENBQUMseUJBQXlCLENBQ25DLGNBQTJCLEVBQzNCLFNBQXNCLEVBQ3RCLE9BQXlCLEVBQ3pCLE1BQW9CLEVBQ3BCLElBQWdCO1FBRWhCLElBQUksY0FBYyxDQUFDLGFBQWEsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxFQUFFLENBQUM7WUFDbEUsT0FBTztRQUNYLENBQUM7UUFFRCxNQUFNLGNBQWMsR0FBRyxjQUFjLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxFQUFFLFdBQVcsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO1FBQ3RGLE1BQU0scUJBQXFCLEdBQUcsT0FBTyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFFcEQsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsRUFBRSxHQUFHLEVBQUUsQ0FBQyxXQUFXLENBQUMsV0FBVyxJQUFJLGFBQWEsRUFBRSxXQUFXLENBQUMscUJBQXFCLElBQUksdUJBQXVCLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7UUFDcE4sT0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN6QixJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMscUJBQXFCLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUU3SCxJQUFLLE1BQU0sQ0FBQyxRQUFRLENBQUMsaUJBQWlCO1lBQ2pDLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsS0FBSyxRQUFRLElBQUksTUFBTSxDQUFDLFFBQVEsQ0FBQyx1QkFBdUI7Z0JBQzNGLE1BQU0sQ0FBQyxRQUFRLENBQUMsbUJBQW1CLEtBQUssUUFBUSxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsc0JBQXNCLENBQUM7WUFDNUYscUJBQXFCLElBQUkscUJBQXFCLENBQUMsSUFBSSxFQUFFLEVBQ3JELENBQUM7WUFDRixNQUFNLFlBQVksR0FBRyxjQUFjLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsSUFBSSxrQkFBa0IsRUFBRSxXQUFXLENBQUMscUJBQXFCLElBQUksdUJBQXVCLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxZQUFZLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxXQUFXLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDN08sT0FBTyxDQUFDLFlBQVksRUFBRSxXQUFXLENBQUMsQ0FBQztZQUNuQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLElBQUksU0FBUyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxxQkFBcUIsRUFBRSxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFBQyxDQUFDO2lCQUFNLENBQUM7Z0JBQUMsSUFBSSxNQUFNLENBQUMsc0RBQXNELENBQUMsQ0FBQztZQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2USxDQUFDO1FBRUQsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLG1CQUFtQixJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsc0JBQXNCLElBQUkscUJBQXFCLElBQUkscUJBQXFCLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQztZQUN6SSxNQUFNLFlBQVksR0FBRyxjQUFjLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsSUFBSSxrQkFBa0IsRUFBRSxXQUFXLENBQUMscUJBQXFCLElBQUksdUJBQXVCLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxLQUFLLEVBQUUsbUJBQW1CLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDMU4sT0FBTyxDQUFDLFlBQVksRUFBRSxhQUFhLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsWUFBWSxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxxQkFBcUIsRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hKLENBQUM7UUFFRCxNQUFNLHNDQUFzQyxHQUFHLE9BQU8scUJBQXFCLEtBQUssUUFBUSxJQUFJLHFCQUFxQixDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUUxSSxJQUFJLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBVSxJQUFJLE9BQU8sQ0FBQyxVQUFVLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsc0NBQXNDLEVBQUUsQ0FBQztZQUN2RyxNQUFNLGFBQWEsR0FBRyxjQUFjLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxpQkFBaUIsSUFBSSxtQkFBbUIsRUFBRSxXQUFXLENBQUMscUJBQXFCLElBQUksdUJBQXVCLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxZQUFZLEVBQUUscUJBQXFCLEVBQUUsS0FBSyxFQUFFLHFCQUFxQixFQUFDLEVBQUMsQ0FBQyxDQUFDO1lBQ2xRLE9BQU8sQ0FBQyxhQUFhLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDckMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGFBQWEsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZILENBQUM7UUFFRCxNQUFNLFNBQVMsR0FBRyxjQUFjLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQyxxQkFBcUIsSUFBSSx1QkFBdUIsRUFBRSxXQUFXLENBQUMsYUFBYSxJQUFJLGVBQWUsRUFBRSxXQUFXLENBQUMscUJBQXFCLElBQUksdUJBQXVCLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxZQUFZLEVBQUUsZ0JBQWdCLEVBQUUsS0FBSyxFQUFFLGdCQUFnQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzVTLE9BQU8sQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDNUIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsZUFBZSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNySCxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBzcmMvcmVuZGVyZXJzL0Fzc2lzdGFudE1lc3NhZ2VSZW5kZXJlci50c1xuaW1wb3J0IHsgQXBwLCBOb3RpY2UsIHNldEljb24sIE1hcmtkb3duUmVuZGVyZXIgfSBmcm9tIFwib2JzaWRpYW5cIjtcbmltcG9ydCB7IEFzc2lzdGFudE1lc3NhZ2UsIE1lc3NhZ2UsIFRvb2xDYWxsIH0gZnJvbSBcIi4uL3R5cGVzXCI7XG5pbXBvcnQgT2xsYW1hUGx1Z2luIGZyb20gXCIuLi9tYWluXCI7XG5pbXBvcnQgeyBPbGxhbWFWaWV3IH0gZnJvbSBcIi4uL09sbGFtYVZpZXdcIjtcbmltcG9ydCB7IENTU19DTEFTU0VTIH0gZnJvbSBcIi4uL2NvbnN0YW50c1wiO1xuaW1wb3J0ICogYXMgUmVuZGVyZXJVdGlscyBmcm9tIFwiLi4vTWVzc2FnZVJlbmRlcmVyVXRpbHNcIjtcbmltcG9ydCB7IEJhc2VNZXNzYWdlUmVuZGVyZXIgfSBmcm9tIFwiLi9CYXNlTWVzc2FnZVJlbmRlcmVyXCI7XG5pbXBvcnQgeyBJTWVzc2FnZVJlbmRlcmVyIH0gZnJvbSBcIi4vSU1lc3NhZ2VSZW5kZXJlclwiO1xuaW1wb3J0IHsgcGFyc2VBbGxUZXh0dWFsVG9vbENhbGxzIH0gZnJvbSBcIkAvdXRpbHMvdG9vbFBhcnNlclwiO1xuXG5leHBvcnQgY2xhc3MgQXNzaXN0YW50TWVzc2FnZVJlbmRlcmVyIGV4dGVuZHMgQmFzZU1lc3NhZ2VSZW5kZXJlciBpbXBsZW1lbnRzIElNZXNzYWdlUmVuZGVyZXIge1xuXG4gICAgY29uc3RydWN0b3IoYXBwOiBBcHAsIHBsdWdpbjogT2xsYW1hUGx1Z2luLCBtZXNzYWdlOiBBc3Npc3RhbnRNZXNzYWdlLCB2aWV3OiBPbGxhbWFWaWV3KSB7XG4gICAgICAgIHN1cGVyKGFwcCwgcGx1Z2luLCBtZXNzYWdlLCB2aWV3KTtcbiAgICAgICAgaWYgKG1lc3NhZ2Uucm9sZSAhPT0gXCJhc3Npc3RhbnRcIikge1xuICAgICAgICAgICAgcGx1Z2luLmxvZ2dlci5lcnJvcihcIltBc3Npc3RhbnRNZXNzYWdlUmVuZGVyZXJdIENvbnN0cnVjdG9yIGVycm9yOiBNZXNzYWdlIHJvbGUgaXMgbm90ICdhc3Npc3RhbnQnLiBSZWNlaXZlZDpcIiwgbWVzc2FnZS5yb2xlKTtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkFzc2lzdGFudE1lc3NhZ2VSZW5kZXJlciBjYW4gb25seSByZW5kZXIgbWVzc2FnZXMgd2l0aCByb2xlICdhc3Npc3RhbnQnLlwiKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vINCSIEFzc2lzdGFudE1lc3NhZ2VSZW5kZXJlci50c1xucHVibGljIHN0YXRpYyBwcmVwYXJlRGlzcGxheUNvbnRlbnQoXG4gICAgb3JpZ2luYWxDb250ZW50OiBzdHJpbmcsXG4gICAgYXNzaXN0YW50TWVzc2FnZTogQXNzaXN0YW50TWVzc2FnZSxcbiAgICBwbHVnaW46IE9sbGFtYVBsdWdpbixcbiAgICB2aWV3OiBPbGxhbWFWaWV3IC8vINCf0L7RgtGA0ZbQsdC10L0g0LTQu9GPIHBhcnNlQWxsVGV4dHVhbFRvb2xDYWxsc1xuKTogc3RyaW5nIHtcbiAgICBjb25zdCB0cyA9IGFzc2lzdGFudE1lc3NhZ2UudGltZXN0YW1wLmdldFRpbWUoKTtcbiAgICBwbHVnaW4ubG9nZ2VyLmRlYnVnKGBbUFJFUF1bdHM6JHt0c31dID09PSBTdGFydGluZyBwcmVwYXJlRGlzcGxheUNvbnRlbnQgPT09YCk7XG4gICAgcGx1Z2luLmxvZ2dlci5kZWJ1ZyhgW1BSRVBdW3RzOiR7dHN9XSAxLiBPcmlnaW5hbCBjb250ZW50OlxcblwiJHtvcmlnaW5hbENvbnRlbnR9XCJgKTtcblxuICAgIGNvbnN0IGRlY29kZWRDb250ZW50ID0gUmVuZGVyZXJVdGlscy5kZWNvZGVIdG1sRW50aXRpZXMob3JpZ2luYWxDb250ZW50KTtcbiAgICBwbHVnaW4ubG9nZ2VyLmRlYnVnKGBbUFJFUF1bdHM6JHt0c31dIDIuIENvbnRlbnQgYWZ0ZXIgZGVjb2RlSHRtbEVudGl0aWVzOlxcblwiJHtkZWNvZGVkQ29udGVudH1cImApO1xuXG4gICAgY29uc3QgdGhpbmtEZXRlY3Rpb24gPSBSZW5kZXJlclV0aWxzLmRldGVjdFRoaW5raW5nVGFncyhkZWNvZGVkQ29udGVudCk7XG4gICAgbGV0IGNvbnRlbnRBZnRlclRoaW5rU3RyaXBwaW5nID0gdGhpbmtEZXRlY3Rpb24uY29udGVudFdpdGhvdXRUYWdzO1xuICAgIHBsdWdpbi5sb2dnZXIuZGVidWcoYFtQUkVQXVt0czoke3RzfV0gMy4gQ29udGVudCBhZnRlciBkZXRlY3RUaGlua2luZ1RhZ3MgKGhhc1RoaW5rOiAke3RoaW5rRGV0ZWN0aW9uLmhhc1RoaW5raW5nVGFnc30pOlxcblwiJHtjb250ZW50QWZ0ZXJUaGlua1N0cmlwcGluZ31cImApO1xuXG4gICAgY29uc3QgaGFzTmF0aXZlVG9vbENhbGxzID0gISEoYXNzaXN0YW50TWVzc2FnZS50b29sX2NhbGxzICYmIGFzc2lzdGFudE1lc3NhZ2UudG9vbF9jYWxscy5sZW5ndGggPiAwKTtcbiAgICBjb25zdCBoYXNUZXh0dWFsVG9vbENhbGxUYWdzSW5Db250ZW50QWZ0ZXJUaGlua1N0cmlwcGluZyA9IGNvbnRlbnRBZnRlclRoaW5rU3RyaXBwaW5nLmluY2x1ZGVzKFwiPHRvb2xfY2FsbD5cIik7XG4gICAgcGx1Z2luLmxvZ2dlci5kZWJ1ZyhgW1BSRVBdW3RzOiR7dHN9XSA0LiBUb29sIGNoZWNrczogZW5hYmxlVG9vbFVzZT0ke3BsdWdpbi5zZXR0aW5ncy5lbmFibGVUb29sVXNlfSwgaGFzTmF0aXZlVG9vbENhbGxzPSR7aGFzTmF0aXZlVG9vbENhbGxzfSwgaGFzVGV4dHVhbFRvb2xDYWxsVGFnc0luQ29udGVudEFmdGVyVGhpbmtTdHJpcHBpbmc9JHtoYXNUZXh0dWFsVG9vbENhbGxUYWdzSW5Db250ZW50QWZ0ZXJUaGlua1N0cmlwcGluZ31gKTtcblxuICAgIGxldCBmaW5hbERpc3BsYXlDb250ZW50ID0gY29udGVudEFmdGVyVGhpbmtTdHJpcHBpbmc7IC8vINCf0L7Rh9Cw0YLQutC+0LLQtSDQt9C90LDRh9C10L3QvdGPXG5cbiAgICBpZiAocGx1Z2luLnNldHRpbmdzLmVuYWJsZVRvb2xVc2UgJiYgKGhhc05hdGl2ZVRvb2xDYWxscyB8fCBoYXNUZXh0dWFsVG9vbENhbGxUYWdzSW5Db250ZW50QWZ0ZXJUaGlua1N0cmlwcGluZykpIHtcbiAgICAgICAgcGx1Z2luLmxvZ2dlci5pbmZvKGBbUFJFUF1bdHM6JHt0c31dIDUuIFRvb2wgY2FsbCBpbmRpY2F0b3JzIGRldGVjdGVkLiBGb3JtYXR0aW5nIGZvciBkaXNwbGF5LmApO1xuICAgICAgICBcbiAgICAgICAgbGV0IHVzaW5nVG9vbE1lc3NhZ2VUZXh0ID0gXCIoIFwiO1xuICAgICAgICBjb25zdCB0b29sTmFtZXNFeHRyYWN0ZWQ6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGxldCBhY2NvbXBhbnlpbmdUZXh0ID0gY29udGVudEFmdGVyVGhpbmtTdHJpcHBpbmc7IC8vINCi0LXQutGB0YIsINC3INGP0LrQvtCz0L4g0LHRg9C00LXQvNC+INCy0LjQtNCw0LvRj9GC0LggPHRvb2xfY2FsbD5cblxuICAgICAgICBpZiAoaGFzTmF0aXZlVG9vbENhbGxzICYmIGFzc2lzdGFudE1lc3NhZ2UudG9vbF9jYWxscykge1xuICAgICAgICAgICAgcGx1Z2luLmxvZ2dlci5kZWJ1ZyhgW1BSRVBdW3RzOiR7dHN9XSA1YS4gUHJvY2Vzc2luZyBOQVRJVkUgdG9vbF9jYWxscy4gQ291bnQ6ICR7YXNzaXN0YW50TWVzc2FnZS50b29sX2NhbGxzLmxlbmd0aH1gKTtcbiAgICAgICAgICAgIGFzc2lzdGFudE1lc3NhZ2UudG9vbF9jYWxscy5mb3JFYWNoKHRjID0+IHRvb2xOYW1lc0V4dHJhY3RlZC5wdXNoKHRjLmZ1bmN0aW9uLm5hbWUpKTtcbiAgICAgICAgICAgIC8vIGFjY29tcGFueWluZ1RleHQg0LfQsNC70LjRiNCw0ZTRgtGM0YHRjyBjb250ZW50QWZ0ZXJUaGlua1N0cmlwcGluZywg0L7RgdC60ZbQu9GM0LrQuCDQvdCw0YLQuNCy0L3RliDQstC40LrQu9C40LrQuCDQvdC1INCyINGC0LXQutGB0YLRllxuICAgICAgICB9IGVsc2UgaWYgKGhhc1RleHR1YWxUb29sQ2FsbFRhZ3NJbkNvbnRlbnRBZnRlclRoaW5rU3RyaXBwaW5nKSB7IFxuICAgICAgICAgICAgcGx1Z2luLmxvZ2dlci5kZWJ1ZyhgW1BSRVBdW3RzOiR7dHN9XSA1Yi4gUHJvY2Vzc2luZyBURVhUVUFMIHRvb2xfY2FsbCB0YWdzIGZyb206IFwiJHtjb250ZW50QWZ0ZXJUaGlua1N0cmlwcGluZy5zdWJzdHJpbmcoMCwxNTApfS4uLlwiYCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vINCS0LjQutC+0YDQuNGB0YLQvtCy0YPRlNC80L4gcGFyc2VBbGxUZXh0dWFsVG9vbENhbGxzINC3IE9sbGFtYVZpZXcg0LTQu9GPINC+0YLRgNC40LzQsNC90L3RjyDRltC80LXQvVxuICAgICAgICAgICAgLy8g0JLQsNC20LvQuNCy0L4sINGJ0L4gcGFyc2VBbGxUZXh0dWFsVG9vbENhbGxzINC+0YLRgNC40LzRg9GUINGC0LXQutGB0YIsINC00LUg0JLQltCVINCd0JXQnNCQ0IQgPHRoaW5rPiDRgtC10LPRltCyXG4gICAgICAgICAgICBjb25zdCBwYXJzZWRUZXh0dWFsQ2FsbHMgPSBwYXJzZUFsbFRleHR1YWxUb29sQ2FsbHMoY29udGVudEFmdGVyVGhpbmtTdHJpcHBpbmcsIHBsdWdpbi5sb2dnZXIpOyBcbiAgICAgICAgICAgIHBhcnNlZFRleHR1YWxDYWxscy5mb3JFYWNoKHB0YyA9PiB0b29sTmFtZXNFeHRyYWN0ZWQucHVzaChwdGMubmFtZSkpO1xuICAgICAgICAgICAgcGx1Z2luLmxvZ2dlci5kZWJ1ZyhgW1BSRVBdW3RzOiR7dHN9XSA1Yy4gRXh0cmFjdGVkIHRvb2wgbmFtZXMgdmlhIHBhcnNlQWxsVGV4dHVhbFRvb2xDYWxsczogWyR7dG9vbE5hbWVzRXh0cmFjdGVkLmpvaW4oJywgJyl9XWApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyDQktC40LTQsNC70Y/RlNC80L4gPHRvb2xfY2FsbD4g0YLQtdCz0Lgg0LcgY29udGVudEFmdGVyVGhpbmtTdHJpcHBpbmcg0LTQu9GPINC+0YLRgNC40LzQsNC90L3RjyDRgdGD0L/RgNC+0LLRltC00L3QvtCz0L4g0YLQtdC60YHRgtGDXG4gICAgICAgICAgICAvLyDQptC10LkgcmVwbGFjZSDQvNC+0LbQtSDQsdGD0YLQuCDQv9GA0L7QsdC70LXQvNCw0YLQuNGH0L3QuNC8LCDRj9C60YnQviDRgtC10LPQuCDQv9C+0YjQutC+0LTQttC10L3RllxuICAgICAgICAgICAgYWNjb21wYW55aW5nVGV4dCA9IGNvbnRlbnRBZnRlclRoaW5rU3RyaXBwaW5nLnJlcGxhY2UoLzx0b29sX2NhbGw+W1xcc1xcU10qPzxcXC90b29sX2NhbGw+L2csIFwiXCIpLnRyaW0oKTtcbiAgICAgICAgICAgIHBsdWdpbi5sb2dnZXIuZGVidWcoYFtQUkVQXVt0czoke3RzfV0gNWQuIEFjY29tcGFueWluZyB0ZXh0IGFmdGVyIGluaXRpYWwgPHRvb2xfY2FsbD4gcmVwbGFjZTogXCIke2FjY29tcGFueWluZ1RleHR9XCJgKTtcblxuICAgICAgICAgICAgLy8g0JTQvtC00LDRgtC60L7QstC1IFwi0LPRgNGD0LHQtVwiINC+0YfQuNGJ0LXQvdC90Y8sINGP0LrRidC+INC/0L7Qv9C10YDQtdC00L3RlCDQvdC1INGB0L/RgNCw0YbRjtCy0LDQu9C+INGW0LTQtdCw0LvRjNC90L5cbiAgICAgICAgICAgIGlmIChhY2NvbXBhbnlpbmdUZXh0LmluY2x1ZGVzKFwiPHRvb2xfY2FsbD5cIikgfHwgYWNjb21wYW55aW5nVGV4dC5pbmNsdWRlcyhcIjwvdG9vbF9jYWxsPlwiKSkge1xuICAgICAgICAgICAgICAgIHBsdWdpbi5sb2dnZXIud2FybihgW1BSRVBdW3RzOiR7dHN9XSBBY2NvbXBhbnlpbmcgdGV4dCBzdGlsbCBjb250YWlucyB0b29sX2NhbGwgdGFncy4gQXR0ZW1wdGluZyBmb3JjZWZ1bCBjbGVhbnVwLmApO1xuICAgICAgICAgICAgICAgIGxldCB0ZW1wVGV4dCA9IGFjY29tcGFueWluZ1RleHQ7XG4gICAgICAgICAgICAgICAgLy8g0JLQuNC00LDQu9GP0ZTQvNC+INCy0YHRliDQstGW0LTQutGA0LjQstCw0Y7Rh9GWINGC0LAg0LfQsNC60YDQuNCy0LDRjtGH0ZYg0YLQtdCz0Lgg0L7QutGA0LXQvNC+XG4gICAgICAgICAgICAgICAgdGVtcFRleHQgPSB0ZW1wVGV4dC5yZXBsYWNlKC88dG9vbF9jYWxsPi9nLCBcIlwiKS5yZXBsYWNlKC88XFwvdG9vbF9jYWxsPi9nLCBcIlwiKS50cmltKCk7XG4gICAgICAgICAgICAgICAgLy8g0KHQv9GA0L7QsdGD0ZTQvNC+INCy0LjQtNCw0LvQuNGC0Lgg0LHRg9C00Ywt0Y/QutGWINC30LDQu9C40YjQutC4IEpTT04sINGP0LrRidC+INCy0L7QvdC4INCy0LjQs9C70Y/QtNCw0Y7RgtGMINGP0Log0L/QvtGH0LDRgtC+0Log0L7QsSfRlNC60YLQsCDRliDQvdC1INGUINGH0LDRgdGC0LjQvdC+0Y4g0YLQtdC60YHRgtGDXG4gICAgICAgICAgICAgICAgLy8g0KbQtSDRgNC40LfQuNC60L7QstCw0L3Qviwg0LzQvtC20LUg0LLQuNC00LDQu9C40YLQuCDQu9C10LPRltGC0LjQvNC90LjQuSDRgtC10LrRgdGCLlxuICAgICAgICAgICAgICAgIC8vIHRlbXBUZXh0ID0gdGVtcFRleHQucmVwbGFjZSgve1xccyooXCJuYW1lXCJ8XCJhcmd1bWVudHNcIilcXHMqOltcXHNcXFNdKj99L2csIFwiXCIpLnRyaW0oKTtcbiAgICAgICAgICAgICAgICBhY2NvbXBhbnlpbmdUZXh0ID0gdGVtcFRleHQ7XG4gICAgICAgICAgICAgICAgcGx1Z2luLmxvZ2dlci5kZWJ1ZyhgW1BSRVBdW3RzOiR7dHN9XSA1ZS4gQWNjb21wYW55aW5nIHRleHQgYWZ0ZXIgZm9yY2VmdWwgY2xlYW51cDogXCIke2FjY29tcGFueWluZ1RleHR9XCJgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0b29sTmFtZXNFeHRyYWN0ZWQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgdXNpbmdUb29sTWVzc2FnZVRleHQgKz0gYFVzaW5nIHRvb2wke3Rvb2xOYW1lc0V4dHJhY3RlZC5sZW5ndGggPiAxID8gJ3MnIDogJyd9OiAke3Rvb2xOYW1lc0V4dHJhY3RlZC5qb2luKCcsICcpfS4uLiBgO1xuICAgICAgICB9IGVsc2UgeyBcbiAgICAgICAgICAgIHVzaW5nVG9vbE1lc3NhZ2VUZXh0ICs9IFwiQXR0ZW1wdGluZyB0byB1c2UgdG9vbChzKS4uLiBcIjtcbiAgICAgICAgICAgIHBsdWdpbi5sb2dnZXIud2FybihgW1BSRVBdW3RzOiR7dHN9XSBObyB0b29sIG5hbWVzIHdlcmUgZXh0cmFjdGVkLCB1c2luZyBnZW5lcmljIG1lc3NhZ2UuYCk7XG4gICAgICAgIH1cbiAgICAgICAgdXNpbmdUb29sTWVzc2FnZVRleHQgKz0gXCIpXCI7XG4gICAgICAgIFxuICAgICAgICBpZiAoYWNjb21wYW55aW5nVGV4dCAmJiBhY2NvbXBhbnlpbmdUZXh0LnRyaW0oKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBmaW5hbERpc3BsYXlDb250ZW50ID0gYCR7dXNpbmdUb29sTWVzc2FnZVRleHR9XFxuXFxuJHthY2NvbXBhbnlpbmdUZXh0LnRyaW0oKX1gO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgZmluYWxEaXNwbGF5Q29udGVudCA9IHVzaW5nVG9vbE1lc3NhZ2VUZXh0O1xuICAgICAgICB9XG4gICAgfVxuICAgIC8vINCv0LrRidC+INGW0L3RgdGC0YDRg9C80LXQvdGC0Lgg0L3QtSDQstC40LrQvtGA0LjRgdGC0L7QstGD0Y7RgtGM0YHRjyDQsNCx0L4g0L3QtdC80LDRlCDRltC90LTQuNC60LDRgtC+0YDRltCyLCBcbiAgICAvLyBmaW5hbERpc3BsYXlDb250ZW50INCy0LbQtSDQstGB0YLQsNC90L7QstC70LXQvdC+INGP0LogY29udGVudEFmdGVyVGhpbmtTdHJpcHBpbmdcbiAgICBcbiAgICBwbHVnaW4ubG9nZ2VyLmluZm8oYFtQUkVQXVt0czoke3RzfV0gPT09IEZpbmFsIGNvbnRlbnQgZm9yIGRpc3BsYXkgPT09OlxcblwiJHtmaW5hbERpc3BsYXlDb250ZW50fVwiYCk7XG4gICAgcmV0dXJuIGZpbmFsRGlzcGxheUNvbnRlbnQ7XG59XG5cbiAgICBwdWJsaWMgYXN5bmMgcmVuZGVyKCk6IFByb21pc2U8SFRNTEVsZW1lbnQ+IHtcbiAgICAgICAgY29uc3QgbWVzc2FnZVRpbWVzdGFtcExvZyA9IHRoaXMubWVzc2FnZS50aW1lc3RhbXAuZ2V0VGltZSgpO1xuICAgICAgICB0aGlzLnBsdWdpbi5sb2dnZXIuZGVidWcoYFtBUmVuZGVyIElOU1RBTkNFXVt0czoke21lc3NhZ2VUaW1lc3RhbXBMb2d9XSByZW5kZXIoKSBjYWxsZWQuIE9yaWdpbmFsIG1lc3NhZ2UgY29udGVudCBwcmV2aWV3OiBcIiR7dGhpcy5tZXNzYWdlLmNvbnRlbnQ/LnN1YnN0cmluZygwLCAxNTApfS4uLlwiYCk7XG5cbiAgICAgICAgY29uc3QgbWVzc2FnZUdyb3VwID0gdGhpcy5jcmVhdGVNZXNzYWdlR3JvdXBXcmFwcGVyKFtDU1NfQ0xBU1NFUy5PTExBTUFfR1JPVVAgfHwgXCJvbGxhbWEtbWVzc2FnZS1ncm91cFwiXSk7XG4gICAgICAgIFJlbmRlcmVyVXRpbHMucmVuZGVyQXZhdGFyKHRoaXMuYXBwLCB0aGlzLnBsdWdpbiwgbWVzc2FnZUdyb3VwLCBmYWxzZSwgJ2Fzc2lzdGFudCcpO1xuICAgICAgICBjb25zdCBtZXNzYWdlV3JhcHBlciA9IG1lc3NhZ2VHcm91cC5jcmVhdGVEaXYoeyBjbHM6IENTU19DTEFTU0VTLk1FU1NBR0VfV1JBUFBFUiB8fCBcIm1lc3NhZ2Utd3JhcHBlclwiIH0pO1xuICAgICAgICBtZXNzYWdlV3JhcHBlci5zdHlsZS5vcmRlciA9IFwiMlwiO1xuICAgICAgICBjb25zdCB7IG1lc3NhZ2VFbCwgY29udGVudEVsIH0gPSB0aGlzLmNyZWF0ZU1lc3NhZ2VCdWJibGUoXG4gICAgICAgICAgICBtZXNzYWdlV3JhcHBlcixcbiAgICAgICAgICAgIFtDU1NfQ0xBU1NFUy5PTExBTUFfTUVTU0FHRSB8fCBcIm9sbGFtYS1tZXNzYWdlXCJdXG4gICAgICAgICk7XG4gICAgICAgIGNvbnRlbnRFbC5hZGRDbGFzcyhDU1NfQ0xBU1NFUy5DT05URU5UX0NPTExBUFNJQkxFIHx8IFwibWVzc2FnZS1jb250ZW50LWNvbGxhcHNpYmxlXCIpO1xuXG4gICAgICAgIGNvbnN0IGFzc2lzdGFudE1lc3NhZ2UgPSB0aGlzLm1lc3NhZ2UgYXMgQXNzaXN0YW50TWVzc2FnZTtcbiAgICAgICAgXG4gICAgICAgIC8vINCS0LjQutC+0YDQuNGB0YLQvtCy0YPRlNC80L4g0YHRgtCw0YLQuNGH0L3QuNC5INC80LXRgtC+0LQg0LTQu9GPINC/0ZbQtNCz0L7RgtC+0LLQutC4INC60L7QvdGC0LXQvdGC0YMsINC/0LXRgNC10LTQsNGO0YfQuCB0aGlzLnZpZXdcbiAgICAgICAgY29uc3QgZGlzcGxheUNvbnRlbnQgPSBBc3Npc3RhbnRNZXNzYWdlUmVuZGVyZXIucHJlcGFyZURpc3BsYXlDb250ZW50KFxuICAgICAgICAgICAgdGhpcy5tZXNzYWdlLmNvbnRlbnQgfHwgXCJcIixcbiAgICAgICAgICAgIGFzc2lzdGFudE1lc3NhZ2UsXG4gICAgICAgICAgICB0aGlzLnBsdWdpbixcbiAgICAgICAgICAgIHRoaXMudmlldyAvLyA8LS0tINCf0LXRgNC10LTQsNGU0LzQviB0aGlzLnZpZXcg0Y/QuiDRh9C10YLQstC10YDRgtC40Lkg0LDRgNCz0YPQvNC10L3RglxuICAgICAgICApO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5wbHVnaW4ubG9nZ2VyLmRlYnVnKGBbQVJlbmRlciBJTlNUQU5DRV1bdHM6JHttZXNzYWdlVGltZXN0YW1wTG9nfV0gQ29udGVudCB0byByZW5kZXIgKGZyb20gcHJlcGFyZURpc3BsYXlDb250ZW50KTogXCIke2Rpc3BsYXlDb250ZW50LnN1YnN0cmluZygwLDE1MCl9Li4uXCJgKTtcbiAgICAgICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBhd2FpdCBSZW5kZXJlclV0aWxzLnJlbmRlck1hcmtkb3duQ29udGVudChcbiAgICAgICAgICAgICAgICB0aGlzLmFwcCxcbiAgICAgICAgICAgICAgICB0aGlzLnZpZXcsXG4gICAgICAgICAgICAgICAgdGhpcy5wbHVnaW4sXG4gICAgICAgICAgICAgICAgY29udGVudEVsLFxuICAgICAgICAgICAgICAgIGRpc3BsYXlDb250ZW50XG4gICAgICAgICAgICApO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgIGNvbnRlbnRFbC5zZXRUZXh0KGBbRXJyb3IgcmVuZGVyaW5nIGFzc2lzdGFudCBjb250ZW50OiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1dYCk7XG4gICAgICAgICAgICAgdGhpcy5wbHVnaW4ubG9nZ2VyLmVycm9yKGBbQVJlbmRlciBJTlNUQU5DRV1bdHM6JHttZXNzYWdlVGltZXN0YW1wTG9nfV0gRXJyb3IgaW4gcmVuZGVyIC0+IHJlbmRlck1hcmtkb3duQ29udGVudDpgLCBlcnJvcik7XG4gICAgICAgIH1cblxuICAgICAgICBBc3Npc3RhbnRNZXNzYWdlUmVuZGVyZXIuYWRkQXNzaXN0YW50QWN0aW9uQnV0dG9ucyhtZXNzYWdlRWwsIGNvbnRlbnRFbCwgYXNzaXN0YW50TWVzc2FnZSwgdGhpcy5wbHVnaW4sIHRoaXMudmlldyk7XG4gICAgICAgIEJhc2VNZXNzYWdlUmVuZGVyZXIuYWRkVGltZXN0YW1wKG1lc3NhZ2VFbCwgdGhpcy5tZXNzYWdlLnRpbWVzdGFtcCwgdGhpcy52aWV3KTtcbiAgICAgICAgXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyBcbiAgICAgICAgICAgIGlmIChtZXNzYWdlRWwuaXNDb25uZWN0ZWQgJiYgY29udGVudEVsLmNsb3Nlc3QoYC4ke0NTU19DTEFTU0VTLk1FU1NBR0VfR1JPVVAgfHwgXCJtZXNzYWdlLWdyb3VwXCJ9YCkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnZpZXcuY2hlY2tNZXNzYWdlRm9yQ29sbGFwc2luZyhtZXNzYWdlRWwpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCA3MCk7XG5cbiAgICAgICAgcmV0dXJuIG1lc3NhZ2VHcm91cDtcbiAgICB9XG5cbiAgICBwdWJsaWMgc3RhdGljIGFkZEFzc2lzdGFudEFjdGlvbkJ1dHRvbnMoXG4gICAgICAgIG1lc3NhZ2VFbGVtZW50OiBIVE1MRWxlbWVudCxcbiAgICAgICAgY29udGVudEVsOiBIVE1MRWxlbWVudCxcbiAgICAgICAgbWVzc2FnZTogQXNzaXN0YW50TWVzc2FnZSxcbiAgICAgICAgcGx1Z2luOiBPbGxhbWFQbHVnaW4sXG4gICAgICAgIHZpZXc6IE9sbGFtYVZpZXdcbiAgICApOiB2b2lkIHtcbiAgICAgICAgaWYgKG1lc3NhZ2VFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoYC4ke0NTU19DTEFTU0VTLk1FU1NBR0VfQUNUSU9OU31gKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zdCBidXR0b25zV3JhcHBlciA9IG1lc3NhZ2VFbGVtZW50LmNyZWF0ZURpdih7IGNsczogQ1NTX0NMQVNTRVMuTUVTU0FHRV9BQ1RJT05TIH0pO1xuICAgICAgICBjb25zdCBvcmlnaW5hbExsTVJhd0NvbnRlbnQgPSBtZXNzYWdlLmNvbnRlbnQgfHwgXCJcIjtcblxuICAgICAgICBjb25zdCBjb3B5QnRuID0gYnV0dG9uc1dyYXBwZXIuY3JlYXRlRWwoXCJidXR0b25cIiwgeyBjbHM6IFtDU1NfQ0xBU1NFUy5DT1BZX0JVVFRPTiB8fCBcImNvcHktYnV0dG9uXCIsIENTU19DTEFTU0VTLk1FU1NBR0VfQUNUSU9OX0JVVFRPTiB8fCBcIm1lc3NhZ2UtYWN0aW9uLWJ1dHRvblwiXSwgYXR0cjogeyBcImFyaWEtbGFiZWxcIjogXCJDb3B5XCIsIHRpdGxlOiBcIkNvcHlcIiB9IH0pO1xuICAgICAgICBzZXRJY29uKGNvcHlCdG4sIFwiY29weVwiKTtcbiAgICAgICAgdmlldy5yZWdpc3RlckRvbUV2ZW50KGNvcHlCdG4sIFwiY2xpY2tcIiwgZSA9PiB7IGUuc3RvcFByb3BhZ2F0aW9uKCk7IHZpZXcuaGFuZGxlQ29weUNsaWNrKG9yaWdpbmFsTGxNUmF3Q29udGVudCwgY29weUJ0bik7IH0pO1xuXG4gICAgICAgIGlmICggcGx1Z2luLnNldHRpbmdzLmVuYWJsZVRyYW5zbGF0aW9uICYmXG4gICAgICAgICAgICAgKHBsdWdpbi5zZXR0aW5ncy50cmFuc2xhdGlvblByb3ZpZGVyID09PSAnZ29vZ2xlJyAmJiBwbHVnaW4uc2V0dGluZ3MuZ29vZ2xlVHJhbnNsYXRpb25BcGlLZXkgfHxcbiAgICAgICAgICAgICAgcGx1Z2luLnNldHRpbmdzLnRyYW5zbGF0aW9uUHJvdmlkZXIgPT09ICdvbGxhbWEnICYmIHBsdWdpbi5zZXR0aW5ncy5vbGxhbWFUcmFuc2xhdGlvbk1vZGVsKSAmJlxuICAgICAgICAgICAgIG9yaWdpbmFsTGxNUmF3Q29udGVudCAmJiBvcmlnaW5hbExsTVJhd0NvbnRlbnQudHJpbSgpXG4gICAgICAgICAgICkge1xuICAgICAgICAgICAgY29uc3QgdHJhbnNsYXRlQnRuID0gYnV0dG9uc1dyYXBwZXIuY3JlYXRlRWwoXCJidXR0b25cIiwgeyBjbHM6IFtDU1NfQ0xBU1NFUy5UUkFOU0xBVEVfQlVUVE9OIHx8IFwidHJhbnNsYXRlLWJ1dHRvblwiLCBDU1NfQ0xBU1NFUy5NRVNTQUdFX0FDVElPTl9CVVRUT04gfHwgXCJtZXNzYWdlLWFjdGlvbi1idXR0b25cIl0sIGF0dHI6IHsgXCJhcmlhLWxhYmVsXCI6IFwiVHJhbnNsYXRlXCIsIHRpdGxlOiBcIlRyYW5zbGF0ZVwiIH0gfSk7XG4gICAgICAgICAgICBzZXRJY29uKHRyYW5zbGF0ZUJ0biwgXCJsYW5ndWFnZXNcIik7XG4gICAgICAgICAgICB2aWV3LnJlZ2lzdGVyRG9tRXZlbnQodHJhbnNsYXRlQnRuLCBcImNsaWNrXCIsIGUgPT4geyBlLnN0b3BQcm9wYWdhdGlvbigpOyBpZiAoY29udGVudEVsLmlzQ29ubmVjdGVkKSB7IHZpZXcuaGFuZGxlVHJhbnNsYXRlQ2xpY2sob3JpZ2luYWxMbE1SYXdDb250ZW50LCBjb250ZW50RWwsIHRyYW5zbGF0ZUJ0bik7IH0gZWxzZSB7IG5ldyBOb3RpY2UoXCJDYW5ub3QgdHJhbnNsYXRlOiBtZXNzYWdlIGNvbnRlbnQgZWxlbWVudCBub3QgZm91bmQuXCIpOyB9IH0pO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHBsdWdpbi5zZXR0aW5ncy5lbmFibGVTdW1tYXJpemF0aW9uICYmIHBsdWdpbi5zZXR0aW5ncy5zdW1tYXJpemF0aW9uTW9kZWxOYW1lICYmIG9yaWdpbmFsTGxNUmF3Q29udGVudCAmJiBvcmlnaW5hbExsTVJhd0NvbnRlbnQudHJpbSgpKSB7XG4gICAgICAgICAgICBjb25zdCBzdW1tYXJpemVCdG4gPSBidXR0b25zV3JhcHBlci5jcmVhdGVFbChcImJ1dHRvblwiLCB7IGNsczogW0NTU19DTEFTU0VTLlNVTU1BUklaRV9CVVRUT04gfHwgXCJzdW1tYXJpemUtYnV0dG9uXCIsIENTU19DTEFTU0VTLk1FU1NBR0VfQUNUSU9OX0JVVFRPTiB8fCBcIm1lc3NhZ2UtYWN0aW9uLWJ1dHRvblwiXSwgYXR0cjogeyB0aXRsZTogXCJTdW1tYXJpemUgbWVzc2FnZVwiIH0gfSk7XG4gICAgICAgICAgICBzZXRJY29uKHN1bW1hcml6ZUJ0biwgXCJzY3JvbGwtdGV4dFwiKTtcbiAgICAgICAgICAgIHZpZXcucmVnaXN0ZXJEb21FdmVudChzdW1tYXJpemVCdG4sIFwiY2xpY2tcIiwgZSA9PiB7IGUuc3RvcFByb3BhZ2F0aW9uKCk7IHZpZXcuaGFuZGxlU3VtbWFyaXplQ2xpY2sob3JpZ2luYWxMbE1SYXdDb250ZW50LCBzdW1tYXJpemVCdG4pOyB9KTtcbiAgICAgICAgfVxuICAgICAgIFxuICAgICAgICBjb25zdCBvcmlnaW5hbENvbnRlbnRDb250YWluc1RleHR1YWxUb29sQ2FsbCA9IHR5cGVvZiBvcmlnaW5hbExsTVJhd0NvbnRlbnQgPT09ICdzdHJpbmcnICYmIG9yaWdpbmFsTGxNUmF3Q29udGVudC5pbmNsdWRlcyhcIjx0b29sX2NhbGw+XCIpO1xuXG4gICAgICAgIGlmICgoIW1lc3NhZ2UudG9vbF9jYWxscyB8fCBtZXNzYWdlLnRvb2xfY2FsbHMubGVuZ3RoID09PSAwKSAmJiAhb3JpZ2luYWxDb250ZW50Q29udGFpbnNUZXh0dWFsVG9vbENhbGwpIHtcbiAgICAgICAgICAgY29uc3QgcmVnZW5lcmF0ZUJ0biA9IGJ1dHRvbnNXcmFwcGVyLmNyZWF0ZUVsKFwiYnV0dG9uXCIsIHsgY2xzOiBbQ1NTX0NMQVNTRVMuUkVHRU5FUkFURV9CVVRUT04gfHwgXCJyZWdlbmVyYXRlLWJ1dHRvblwiLCBDU1NfQ0xBU1NFUy5NRVNTQUdFX0FDVElPTl9CVVRUT04gfHwgXCJtZXNzYWdlLWFjdGlvbi1idXR0b25cIl0sIGF0dHI6IHsgXCJhcmlhLWxhYmVsXCI6IFwiUmVnZW5lcmF0ZSByZXNwb25zZVwiLCB0aXRsZTogXCJSZWdlbmVyYXRlIFJlc3BvbnNlXCJ9fSk7XG4gICAgICAgICAgIHNldEljb24ocmVnZW5lcmF0ZUJ0biwgXCJyZWZyZXNoLWN3XCIpO1xuICAgICAgICAgICB2aWV3LnJlZ2lzdGVyRG9tRXZlbnQocmVnZW5lcmF0ZUJ0biwgXCJjbGlja1wiLCAoZSkgPT4geyBlLnN0b3BQcm9wYWdhdGlvbigpOyB2aWV3LmhhbmRsZVJlZ2VuZXJhdGVDbGljayhtZXNzYWdlKTsgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkZWxldGVCdG4gPSBidXR0b25zV3JhcHBlci5jcmVhdGVFbChcImJ1dHRvblwiLCB7IGNsczogW0NTU19DTEFTU0VTLkRFTEVURV9NRVNTQUdFX0JVVFRPTiB8fCBcImRlbGV0ZS1tZXNzYWdlLWJ1dHRvblwiLCBDU1NfQ0xBU1NFUy5EQU5HRVJfT1BUSU9OIHx8IFwiZGFuZ2VyLW9wdGlvblwiLCBDU1NfQ0xBU1NFUy5NRVNTQUdFX0FDVElPTl9CVVRUT04gfHwgXCJtZXNzYWdlLWFjdGlvbi1idXR0b25cIl0sIGF0dHI6IHsgXCJhcmlhLWxhYmVsXCI6IFwiRGVsZXRlIG1lc3NhZ2VcIiwgdGl0bGU6IFwiRGVsZXRlIE1lc3NhZ2VcIiB9IH0pO1xuICAgICAgICBzZXRJY29uKGRlbGV0ZUJ0biwgXCJ0cmFzaFwiKTtcbiAgICAgICAgdmlldy5yZWdpc3RlckRvbUV2ZW50KGRlbGV0ZUJ0biwgXCJjbGlja1wiLCBlID0+IHsgZS5zdG9wUHJvcGFnYXRpb24oKTsgdmlldy5oYW5kbGVEZWxldGVNZXNzYWdlQ2xpY2sobWVzc2FnZSk7IH0pO1xuICAgIH1cbn0iXX0=