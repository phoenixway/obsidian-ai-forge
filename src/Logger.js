import { __awaiter } from "tslib";
// src/Logger.ts
import { normalizePath } from 'obsidian';
// Рівні логування
export var LogLevel;
(function (LogLevel) {
    LogLevel[LogLevel["DEBUG"] = 1] = "DEBUG";
    LogLevel[LogLevel["INFO"] = 2] = "INFO";
    LogLevel[LogLevel["WARN"] = 3] = "WARN";
    LogLevel[LogLevel["ERROR"] = 4] = "ERROR";
    LogLevel[LogLevel["TRACE"] = 6] = "TRACE";
    LogLevel[LogLevel["NONE"] = 5] = "NONE"; // Для повного вимкнення
})(LogLevel || (LogLevel = {}));
export class Logger {
    constructor(plugin, initialSettings) {
        this.consoleLogLevel = LogLevel.INFO;
        this.fileLogLevel = LogLevel.WARN;
        this.fileLoggingEnabled = false;
        this.logCallerInfo = false;
        this.logFileMaxSizeMB = 5;
        this.logQueue = [];
        this.isWritingToFile = false;
        this.writeDebounceTimeout = null;
        this.plugin = plugin;
        this.adapter = plugin.app.vault.adapter;
        // --- ВИПРАВЛЕНО: Використовуємо normalizePath тут ---
        this.logFilePath = normalizePath(initialSettings.logFilePath || `${this.plugin.manifest.dir}/ai-forge.log`);
        this.logFileMaxSizeMB = initialSettings.logFileMaxSizeMB || 5;
        this.updateSettings(initialSettings);
        // console.log(`[Logger] Initialized. Console Level: ${this.getLogLevelName(this.consoleLogLevel)}, File Logging: ${this.fileLoggingEnabled}, File Level: ${this.getLogLevelName(this.fileLogLevel)}, Log Caller: ${this.logCallerInfo}, Path: ${this.logFilePath}`);
        if (this.fileLoggingEnabled) {
            this.rotateLogFileIfNeeded().then(() => {
            });
        }
        else {
        }
    }
    // --- ДОДАНО: Публічний метод для отримання шляху ---
    getLogFilePath() {
        return this.logFilePath;
    }
    // --- КІНЕЦЬ ДОДАНОГО МЕТОДУ ---
    getLogLevelName(level) { /* ... */ return LogLevel[level] || 'UNKNOWN'; }
    getLogLevelFromString(levelString, defaultLevel = LogLevel.INFO) { /* ... */ return LogLevel[levelString === null || levelString === void 0 ? void 0 : levelString.toUpperCase()] || defaultLevel; }
    updateSettings(settings) {
        if (settings.consoleLogLevel !== undefined) {
            this.consoleLogLevel = this.getLogLevelFromString(settings.consoleLogLevel, LogLevel.INFO);
            // console.log(`[Logger] Console log level set to: ${this.getLogLevelName(this.consoleLogLevel)}`);
        }
        if (settings.fileLogLevel !== undefined) {
            this.fileLogLevel = this.getLogLevelFromString(settings.fileLogLevel, LogLevel.WARN);
            // console.log(`[Logger] File log level set to: ${this.getLogLevelName(this.fileLogLevel)}`);
        }
        if (settings.fileLoggingEnabled !== undefined) {
            const wasEnabled = this.fileLoggingEnabled;
            this.fileLoggingEnabled = settings.fileLoggingEnabled;
            //  console.log(`[Logger] File logging enabled: ${this.fileLoggingEnabled}`);
            if (!wasEnabled && this.fileLoggingEnabled) {
                this.rotateLogFileIfNeeded();
            }
        }
        if (settings.logCallerInfo !== undefined) {
            this.logCallerInfo = settings.logCallerInfo;
            //  console.log(`[Logger] Log Caller Info enabled: ${this.logCallerInfo}`);
        }
        // Оновлення шляху та розміру, якщо вони передані
        if (settings.logFilePath !== undefined) {
            this.logFilePath = normalizePath(settings.logFilePath || `${this.plugin.manifest.dir}/ai-forge.log`);
            //  console.log(`[Logger] Log file path updated to: ${this.logFilePaInitialized. Console Levelh}`);
        }
        if (settings.logFileMaxSizeMB !== undefined) {
            this.logFileMaxSizeMB = settings.logFileMaxSizeMB || 5;
            //  console.log(`[Logger] Log file max size updated to: ${this.logFileMaxSizeMB} MB`);
        }
    }
    getCallerInfo() { /* ... (код як раніше) ... */ return 'unknown'; }
    debug(...args) { this.log(LogLevel.DEBUG, console.debug, ...args); }
    info(...args) { this.log(LogLevel.INFO, console.info, ...args); }
    warn(...args) { this.log(LogLevel.WARN, console.warn, ...args); }
    error(...args) { this.log(LogLevel.ERROR, console.error, ...args); }
    trace(...args) { this.log(LogLevel.TRACE, console.error, ...args); }
    log(level, consoleMethod, ...args) {
        const caller = this.getCallerInfo();
        if (level >= this.consoleLogLevel) {
            const prefix = this.logCallerInfo && caller !== 'unknown'
                ? `[${this.getLogLevelName(level)}] [${caller}]`
                : `[${this.getLogLevelName(level)}]`;
            consoleMethod(prefix, ...args);
        }
        if (this.fileLoggingEnabled && level >= this.fileLogLevel) {
            this.queueOrWriteToFile(level, caller, args);
        }
    }
    queueOrWriteToFile(level, caller, args) { }
    triggerWriteToFile() { }
    rotateLogFileIfNeeded() {
        return __awaiter(this, void 0, void 0, function* () { });
    }
} // Кінець класу Logger
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9nZ2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTG9nZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxnQkFBZ0I7QUFDaEIsT0FBTyxFQUFlLGFBQWEsRUFBVSxNQUFNLFVBQVUsQ0FBQztBQUU5RCxrQkFBa0I7QUFDbEIsTUFBTSxDQUFOLElBQVksUUFPWDtBQVBELFdBQVksUUFBUTtJQUNoQix5Q0FBUyxDQUFBO0lBQ1QsdUNBQVEsQ0FBQTtJQUNSLHVDQUFRLENBQUE7SUFDUix5Q0FBUyxDQUFBO0lBQ1QseUNBQVMsQ0FBQTtJQUNULHVDQUFRLENBQUEsQ0FBQyx3QkFBd0I7QUFDckMsQ0FBQyxFQVBXLFFBQVEsS0FBUixRQUFRLFFBT25CO0FBWUQsTUFBTSxPQUFPLE1BQU07SUFhZixZQUFZLE1BQWMsRUFBRSxlQUErQjtRQVZuRCxvQkFBZSxHQUFhLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFDMUMsaUJBQVksR0FBYSxRQUFRLENBQUMsSUFBSSxDQUFDO1FBQ3ZDLHVCQUFrQixHQUFZLEtBQUssQ0FBQztRQUNwQyxrQkFBYSxHQUFZLEtBQUssQ0FBQztRQUMvQixxQkFBZ0IsR0FBVyxDQUFDLENBQUM7UUFFN0IsYUFBUSxHQUFhLEVBQUUsQ0FBQztRQUN4QixvQkFBZSxHQUFZLEtBQUssQ0FBQztRQUNqQyx5QkFBb0IsR0FBMEIsSUFBSSxDQUFDO1FBR3ZELElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO1FBQ3hDLHVEQUF1RDtRQUN2RCxJQUFJLENBQUMsV0FBVyxHQUFHLGFBQWEsQ0FBQyxlQUFlLENBQUMsV0FBVyxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxlQUFlLENBQUMsQ0FBQztRQUM1RyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsZUFBZSxDQUFDLGdC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QUM7WUFDeEQsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDakQsQ0FBQztJQUNMLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxLQUFlLEVBQUUsTUFBYyxFQUFFLElBQVcsSUFBa0MsQ0FBQztJQUNsRyxrQkFBa0IsS0FBbUMsQ0FBQztJQUNoRCxxQkFBcUI7OERBQW1DLENBQUM7S0FBQTtDQUUxRSxDQUFDLHNCQUFzQiIsInNvdXJjZXNDb250ZW50IjpbIi8vIHNyYy9Mb2dnZXIudHNcbmltcG9ydCB7IERhdGFBZGFwdGVyLCBub3JtYWxpemVQYXRoLCBQbHVnaW4gfSBmcm9tICdvYnNpZGlhbic7XG5cbi8vINCg0ZbQstC90ZYg0LvQvtCz0YPQstCw0L3QvdGPXG5leHBvcnQgZW51bSBMb2dMZXZlbCB7XG4gICAgREVCVUcgPSAxLFxuICAgIElORk8gPSAyLFxuICAgIFdBUk4gPSAzLFxuICAgIEVSUk9SID0gNCxcbiAgICBUUkFDRSA9IDYsIC8vINCU0LvRjyDRgtGA0LDRgdGD0LLQsNC90L3Rj1xuICAgIE5PTkUgPSA1IC8vINCU0LvRjyDQv9C+0LLQvdC+0LPQviDQstC40LzQutC90LXQvdC90Y9cbn1cblxuLy8g0KLQuNC/INC00LvRjyDQv9C+0YfQsNGC0LrQvtCy0LjRhSDQvdCw0LvQsNGI0YLRg9Cy0LDQvdGMINC70L7Qs9C10YDQsFxuZXhwb3J0IGludGVyZmFjZSBMb2dnZXJTZXR0aW5ncyB7XG4gICAgY29uc29sZUxvZ0xldmVsOiBrZXlvZiB0eXBlb2YgTG9nTGV2ZWw7XG4gICAgZmlsZUxvZ2dpbmdFbmFibGVkOiBib29sZWFuO1xuICAgIGZpbGVMb2dMZXZlbDoga2V5b2YgdHlwZW9mIExvZ0xldmVsO1xuICAgIGxvZ0NhbGxlckluZm86IGJvb2xlYW47IC8vIDwtLS0g0J3QvtCy0LUg0L3QsNC70LDRiNGC0YPQstCw0L3QvdGPXG4gICAgbG9nRmlsZVBhdGg/OiBzdHJpbmc7XG4gICAgbG9nRmlsZU1heFNpemVNQj86IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIExvZ2dlciB7XG4gICAgcHJpdmF0ZSBhZGFwdGVyOiBEYXRhQWRhcHRlcjtcbiAgICBwcml2YXRlIGxvZ0ZpbGVQYXRoOiBzdHJpbmc7XG4gICAgcHJpdmF0ZSBjb25zb2xlTG9nTGV2ZWw6IExvZ0xldmVsID0gTG9nTGV2ZWwuSU5GTztcbiAgICBwcml2YXRlIGZpbGVMb2dMZXZlbDogTG9nTGV2ZWwgPSBMb2dMZXZlbC5XQVJOO1xuICAgIHByaXZhdGUgZmlsZUxvZ2dpbmdFbmFibGVkOiBib29sZWFuID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBsb2dDYWxsZXJJbmZvOiBib29sZWFuID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBsb2dGaWxlTWF4U2l6ZU1COiBudW1iZXIgPSA1O1xuICAgIHByaXZhdGUgcGx1Z2luOiBQbHVnaW47XG4gICAgcHJpdmF0ZSBsb2dRdWV1ZTogc3RyaW5nW10gPSBbXTtcbiAgICBwcml2YXRlIGlzV3JpdGluZ1RvRmlsZTogYm9vbGVhbiA9IGZhbHNlO1xuICAgIHByaXZhdGUgd3JpdGVEZWJvdW5jZVRpbWVvdXQ6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGw7XG5cbiAgICBjb25zdHJ1Y3RvcihwbHVnaW46IFBsdWdpbiwgaW5pdGlhbFNldHRpbmdzOiBMb2dnZXJTZXR0aW5ncykge1xuICAgICAgICB0aGlzLnBsdWdpbiA9IHBsdWdpbjtcbiAgICAgICAgdGhpcy5hZGFwdGVyID0gcGx1Z2luLmFwcC52YXVsdC5hZGFwdGVyO1xuICAgICAgICAvLyAtLS0g0JLQmNCf0KDQkNCS0JvQldCd0J46INCS0LjQutC+0YDQuNGB0YLQvtCy0YPRlNC80L4gbm9ybWFsaXplUGF0aCDRgtGD0YIgLS0tXG4gICAgICAgIHRoaXMubG9nRmlsZVBhdGggPSBub3JtYWxpemVQYXRoKGluaXRpYWxTZXR0aW5ncy5sb2dGaWxlUGF0aCB8fCBgJHt0aGlzLnBsdWdpbi5tYW5pZmVzdC5kaXJ9L2FpLWZvcmdlLmxvZ2ApO1xuICAgICAgICB0aGlzLmxvZ0ZpbGVNYXhTaXplTUIgPSBpbml0aWFsU2V0dGluZ3MubG9nRmlsZU1heFNpemVNQiB8fCA1O1xuXG4gICAgICAgIHRoaXMudXBkYXRlU2V0dGluZ3MoaW5pdGlhbFNldHRpbmdzKTtcblxuICAgICAgICAvLyBjb25zb2xlLmxvZyhgW0xvZ2dlcl0gSW5pdGlhbGl6ZWQuIENvbnNvbGUgTGV2ZWw6ICR7dGhpcy5nZXRMb2dMZXZlbE5hbWUodGhpcy5jb25zb2xlTG9nTGV2ZWwpfSwgRmlsZSBMb2dnaW5nOiAke3RoaXMuZmlsZUxvZ2dpbmdFbmFibGVkfSwgRmlsZSBMZXZlbDogJHt0aGlzLmdldExvZ0xldmVsTmFtZSh0aGlzLmZpbGVMb2dMZXZlbCl9LCBMb2cgQ2FsbGVyOiAke3RoaXMubG9nQ2FsbGVySW5mb30sIFBhdGg6ICR7dGhpcy5sb2dGaWxlUGF0aH1gKTtcblxuICAgICAgICBpZiAodGhpcy5maWxlTG9nZ2luZ0VuYWJsZWQpIHtcbiAgICAgICAgICAgIHRoaXMucm90YXRlTG9nRmlsZUlmTmVlZGVkKCkudGhlbigoKSA9PiB7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICBcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIC0tLSDQlNCe0JTQkNCd0J46INCf0YPQsdC70ZbRh9C90LjQuSDQvNC10YLQvtC0INC00LvRjyDQvtGC0YDQuNC80LDQvdC90Y8g0YjQu9GP0YXRgyAtLS1cbiAgICBwdWJsaWMgZ2V0TG9nRmlsZVBhdGgoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubG9nRmlsZVBhdGg7XG4gICAgfVxuICAgIC8vIC0tLSDQmtCG0J3QldCm0Kwg0JTQntCU0JDQndCe0JPQniDQnNCV0KLQntCU0KMgLS0tXG5cbiAgICBwcml2YXRlIGdldExvZ0xldmVsTmFtZShsZXZlbDogTG9nTGV2ZWwpOiBzdHJpbmcgeyAvKiAuLi4gKi8gcmV0dXJuIExvZ0xldmVsW2xldmVsXSB8fCAnVU5LTk9XTic7IH1cbiAgICBwcml2YXRlIGdldExvZ0xldmVsRnJvbVN0cmluZyhsZXZlbFN0cmluZzogc3RyaW5nIHwgdW5kZWZpbmVkLCBkZWZhdWx0TGV2ZWw6IExvZ0xldmVsID0gTG9nTGV2ZWwuSU5GTyk6IExvZ0xldmVsIHsgLyogLi4uICovIHJldHVybiBMb2dMZXZlbFtsZXZlbFN0cmluZz8udG9VcHBlckNhc2UoKSBhcyBrZXlvZiB0eXBlb2YgTG9nTGV2ZWxdIHx8IGRlZmF1bHRMZXZlbDsgfVxuXG4gICAgdXBkYXRlU2V0dGluZ3Moc2V0dGluZ3M6IFBhcnRpYWw8TG9nZ2VyU2V0dGluZ3M+KSB7XG4gICAgICAgIGlmIChzZXR0aW5ncy5jb25zb2xlTG9nTGV2ZWwgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgdGhpcy5jb25zb2xlTG9nTGV2ZWwgPSB0aGlzLmdldExvZ0xldmVsRnJvbVN0cmluZyhzZXR0aW5ncy5jb25zb2xlTG9nTGV2ZWwsIExvZ0xldmVsLklORk8pO1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coYFtMb2dnZXJdIENvbnNvbGUgbG9nIGxldmVsIHNldCB0bzogJHt0aGlzLmdldExvZ0xldmVsTmFtZSh0aGlzLmNvbnNvbGVMb2dMZXZlbCl9YCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHNldHRpbmdzLmZpbGVMb2dMZXZlbCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0aGlzLmZpbGVMb2dMZXZlbCA9IHRoaXMuZ2V0TG9nTGV2ZWxGcm9tU3RyaW5nKHNldHRpbmdzLmZpbGVMb2dMZXZlbCwgTG9nTGV2ZWwuV0FSTik7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhgW0xvZ2dlcl0gRmlsZSBsb2cgbGV2ZWwgc2V0IHRvOiAke3RoaXMuZ2V0TG9nTGV2ZWxOYW1lKHRoaXMuZmlsZUxvZ0xldmVsKX1gKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoc2V0dGluZ3MuZmlsZUxvZ2dpbmdFbmFibGVkICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIGNvbnN0IHdhc0VuYWJsZWQgPSB0aGlzLmZpbGVMb2dnaW5nRW5hYmxlZDtcbiAgICAgICAgICAgIHRoaXMuZmlsZUxvZ2dpbmdFbmFibGVkID0gc2V0dGluZ3MuZmlsZUxvZ2dpbmdFbmFibGVkO1xuICAgICAgICAgICAgLy8gIGNvbnNvbGUubG9nKGBbTG9nZ2VyXSBGaWxlIGxvZ2dpbmcgZW5hYmxlZDogJHt0aGlzLmZpbGVMb2dnaW5nRW5hYmxlZH1gKTtcbiAgICAgICAgICAgICBpZiAoIXdhc0VuYWJsZWQgJiYgdGhpcy5maWxlTG9nZ2luZ0VuYWJsZWQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLnJvdGF0ZUxvZ0ZpbGVJZk5lZWRlZCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgICBpZiAoc2V0dGluZ3MubG9nQ2FsbGVySW5mbyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgdGhpcy5sb2dDYWxsZXJJbmZvID0gc2V0dGluZ3MubG9nQ2FsbGVySW5mbztcbiAgICAgICAgICAgIC8vICBjb25zb2xlLmxvZyhgW0xvZ2dlcl0gTG9nIENhbGxlciBJbmZvIGVuYWJsZWQ6ICR7dGhpcy5sb2dDYWxsZXJJbmZvfWApO1xuICAgICAgICAgfVxuICAgICAgICAgLy8g0J7QvdC+0LLQu9C10L3QvdGPINGI0LvRj9GF0YMg0YLQsCDRgNC+0LfQvNGW0YDRgywg0Y/QutGJ0L4g0LLQvtC90Lgg0L/QtdGA0LXQtNCw0L3RllxuICAgICAgICAgaWYgKHNldHRpbmdzLmxvZ0ZpbGVQYXRoICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICB0aGlzLmxvZ0ZpbGVQYXRoID0gbm9ybWFsaXplUGF0aChzZXR0aW5ncy5sb2dGaWxlUGF0aCB8fCBgJHt0aGlzLnBsdWdpbi5tYW5pZmVzdC5kaXJ9L2FpLWZvcmdlLmxvZ2ApO1xuICAgICAgICAgICAgLy8gIGNvbnNvbGUubG9nKGBbTG9nZ2VyXSBMb2cgZmlsZSBwYXRoIHVwZGF0ZWQgdG86ICR7dGhpcy5sb2dGaWxlUGFJbml0aWFsaXplZC4gQ29uc29sZSBMZXZlbGh9YCk7XG4gICAgICAgICB9XG4gICAgICAgICBpZiAoc2V0dGluZ3MubG9nRmlsZU1heFNpemVNQiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgdGhpcy5sb2dGaWxlTWF4U2l6ZU1CID0gc2V0dGluZ3MubG9nRmlsZU1heFNpemVNQiB8fCA1O1xuICAgICAgICAgICAgLy8gIGNvbnNvbGUubG9nKGBbTG9nZ2VyXSBMb2cgZmlsZSBtYXggc2l6ZSB1cGRhdGVkIHRvOiAke3RoaXMubG9nRmlsZU1heFNpemVNQn0gTUJgKTtcbiAgICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGdldENhbGxlckluZm8oKTogc3RyaW5nIHsgLyogLi4uICjQutC+0LQg0Y/QuiDRgNCw0L3RltGI0LUpIC4uLiAqLyByZXR1cm4gJ3Vua25vd24nOyB9XG5cbiAgICBkZWJ1ZyguLi5hcmdzOiBhbnlbXSkgeyB0aGlzLmxvZyhMb2dMZXZlbC5ERUJVRywgY29uc29sZS5kZWJ1ZywgLi4uYXJncyk7IH1cbiAgICBpbmZvKC4uLmFyZ3M6IGFueVtdKSB7IHRoaXMubG9nKExvZ0xldmVsLklORk8sIGNvbnNvbGUuaW5mbywgLi4uYXJncyk7IH1cbiAgICB3YXJuKC4uLmFyZ3M6IGFueVtdKSB7IHRoaXMubG9nKExvZ0xldmVsLldBUk4sIGNvbnNvbGUud2FybiwgLi4uYXJncyk7IH1cbiAgICBlcnJvciguLi5hcmdzOiBhbnlbXSkgeyB0aGlzLmxvZyhMb2dMZXZlbC5FUlJPUiwgY29uc29sZS5lcnJvciwgLi4uYXJncyk7IH1cbiAgICB0cmFjZSguLi5hcmdzOiBhbnlbXSkgeyB0aGlzLmxvZyhMb2dMZXZlbC5UUkFDRSwgY29uc29sZS5lcnJvciwgLi4uYXJncyk7IH1cblxuICAgIHByaXZhdGUgbG9nKGxldmVsOiBMb2dMZXZlbCwgY29uc29sZU1ldGhvZDogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkLCAuLi5hcmdzOiBhbnlbXSkge1xuICAgICAgICBjb25zdCBjYWxsZXIgPSB0aGlzLmdldENhbGxlckluZm8oKTtcbiAgICAgICAgaWYgKGxldmVsID49IHRoaXMuY29uc29sZUxvZ0xldmVsKSB7XG4gICAgICAgICAgICBjb25zdCBwcmVmaXggPSB0aGlzLmxvZ0NhbGxlckluZm8gJiYgY2FsbGVyICE9PSAndW5rbm93bidcbiAgICAgICAgICAgICAgICAgICAgICAgICA/IGBbJHt0aGlzLmdldExvZ0xldmVsTmFtZShsZXZlbCl9XSBbJHtjYWxsZXJ9XWBcbiAgICAgICAgICAgICAgICAgICAgICAgICA6IGBbJHt0aGlzLmdldExvZ0xldmVsTmFtZShsZXZlbCl9XWA7XG4gICAgICAgICAgICBjb25zb2xlTWV0aG9kKHByZWZpeCwgLi4uYXJncyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRoaXMuZmlsZUxvZ2dpbmdFbmFibGVkICYmIGxldmVsID49IHRoaXMuZmlsZUxvZ0xldmVsKSB7XG4gICAgICAgICAgICB0aGlzLnF1ZXVlT3JXcml0ZVRvRmlsZShsZXZlbCwgY2FsbGVyLCBhcmdzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgcXVldWVPcldyaXRlVG9GaWxlKGxldmVsOiBMb2dMZXZlbCwgY2FsbGVyOiBzdHJpbmcsIGFyZ3M6IGFueVtdKSB7IC8qIC4uLiAo0LrQvtC0INGP0Log0YDQsNC90ZbRiNC1KSAuLi4gKi8gfVxuICAgIHByaXZhdGUgdHJpZ2dlcldyaXRlVG9GaWxlKCkgeyAvKiAuLi4gKNC60L7QtCDRj9C6INGA0LDQvdGW0YjQtSkgLi4uICovIH1cbiAgICBwcml2YXRlIGFzeW5jIHJvdGF0ZUxvZ0ZpbGVJZk5lZWRlZCgpIHsgLyogLi4uICjQutC+0LQg0Y/QuiDRgNCw0L3RltGI0LUpIC4uLiAqLyB9XG5cbn0gLy8g0JrRltC90LXRhtGMINC60LvQsNGB0YMgTG9nZ2VyIl19