// src/styles/_messages.scss

// --- Змінні SASS ---
$avatar-final-size: calc(var(--chat-avatar-size, 32px) * 1.2);
$avatar-font-size-factor: 0.5;
$avatar-icon-size-factor: 0.65;

// --- Міксіни ---
@mixin flex-layout($direction: row, $justify: initial, $align: initial, $gap: 0) {
  display: flex;
  @if $direction != row {
    flex-direction: $direction;
  }
  @if $justify != initial {
    justify-content: $justify;
  }
  @if $align != initial {
    align-items: $align;
  }
  @if $gap != 0 {
    gap: $gap;
  }
}

@mixin transition($properties: all, $duration: 0.2s, $timing-function: ease) {
  transition-property: $properties;
  transition-duration: $duration;
  transition-timing-function: $timing-function;
}

// --- Плейсхолдери ---
%base-avatar-container {
  width: $avatar-final-size;
  height: $avatar-final-size;
  min-width: $avatar-final-size;
  min-height: $avatar-final-size;
  border-radius: 50%;
  overflow: hidden;
  background-color: var(--background-modifier-hover);
  color: var(--text-muted);
  flex-shrink: 0;
  @include flex-layout($justify: center, $align: center);
  box-sizing: border-box;
  margin-top: calc(var(--chat-spacing-unit, 5px) * 0.5); 
}

%base-message-bubble {
  padding: calc(var(--chat-spacing-unit, 5px) * 2) calc(var(--chat-spacing-unit, 5px) * 3);
  border-radius: 18px;
  white-space: normal;
  overflow-wrap: break-word;
  word-break: break-word;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
  font-size: var(--font-ui-small);
  line-height: 1.5;
  @include transition((transform, box-shadow), 0.2s, ease-out);
  margin-bottom: 0;
  box-sizing: border-box;
}

%base-action-button {
  background: transparent !important; 
  border: none;
  box-shadow: none;
  padding: 1px;
  color: var(--text-muted); 
  border-radius: var(--radius-s);
  cursor: pointer;
  @include transition;
  @include flex-layout($align: center, $justify: center); 
  box-sizing: border-box;
  margin-left: 0;
  position: relative; 
  line-height: 1; 

  .svg-icon {
    width: 14px; 
    height: 14px; 
  }

  &:hover {
    background: var(--background-modifier-hover) !important; 
    color: var(--text-normal); 
    transform: scale(1.05);
  }
}

// --- Початок стилів ---
.ollama-chat-container {
  max-width: var(--chat-column-max-width, 1000px);
  width: 100%;
  margin-left: auto;
  margin-right: auto;
  box-sizing: border-box;
}

.message-group { 
  width: 100%;
  position: relative;
  box-sizing: border-box;
  @include flex-layout($align: flex-start, $gap: calc(var(--chat-spacing-unit, 5px) * 2));
  margin-bottom: calc(var(--chat-spacing-unit, 5px) * 2);

  &.user-message-group { 
    justify-content: flex-end;
    .avatar-container { 
        order: 2; 
    }
  }

  &.ollama-message-group { 
    justify-content: flex-start;
    .avatar-container { order: 1; }
  }
  &.tool-message-group { 
    justify-content: flex-start; 
    .avatar-container { order: 1; }
  }
  &.system-message-group { 
    justify-content: center; 
    width: 100%;
    .message-wrapper { align-items: center; width: 100%; max-width: 90%; }
    .avatar-container { display: none; } 
  }
  &.error-message-group { 
    justify-content: flex-start; 
    .message-wrapper { order: 2; } 
    .avatar-container { order: 1; }
  }
}

.avatar-container { 
  @extend %base-avatar-container; 
  &.user-avatar { background-color: var(--interactive-accent-translucent); color: var(--interactive-accent); }
  &.ai-avatar { background-color: var(--background-modifier-success); color: var(--text-on-accent); }
  &.avatar-tool-specific { background-color: var(--background-modifier-info); color: var(--text-normal);
    .svg-icon svg { fill: var(--text-normal); } 
  }
  &.avatar-image { width: 100%; height: 100%; object-fit: cover; }
  &.avatar-icon .svg-icon { svg { width: calc(#{$avatar-final-size} * #{$avatar-icon-size-factor}); height: calc(#{$avatar-final-size} * #{$avatar-icon-size-factor}); display: block; } }
  &.avatar-initials { font-size: calc(#{$avatar-final-size} * #{$avatar-font-size-factor}); font-weight: 600; line-height: 1; text-align: center; width: 100%; height: 100%; @include flex-layout($align: center, $justify: center); }
}

.message-wrapper { 
  @include flex-layout($direction: column);
  box-sizing: border-box;
  max-width: var(--chat-message-max-width, 700px); 
  width: 100%; 
}

// --- ОБГОРТКА для контенту (картки + бульбашка), ПЕРЕД мета-інформацією ---
.message-content-area {
  display: flex;
  flex-direction: column;
  width: 100%; // Займає всю ширину .message-wrapper

  // Вирівнювання .message-main-content всередині .message-content-area
  .user-message-group .message-wrapper & {
    align-items: flex-end; 
  }
  .ollama-message-group .message-wrapper & {
    align-items: flex-start; 
  }
}

// Обгортка для карток та бульбашки, для їх взаємного вирівнювання
.message-main-content {
  display: flex;
  flex-direction: column;
  width: 100%; // Або fit-content, якщо потрібно, щоб вона була по ширині найширшого елемента (картки/бульбашки)

  // Вирівнювання дочірніх елементів (карток та бульбашки)
  .user-message-group .message-wrapper & {
    align-items: flex-end;
  }
  .ollama-message-group .message-wrapper & {
    align-items: flex-start;
  }
}
// --- Кінець нових обгорток ---

.message-attachment-cards-container {
  display: flex;
  flex-wrap: wrap;
  gap: calc(var(--chat-spacing-unit, 5px) * 1.25);
  width: 100%; // Картки займають всю доступну ширину .message-main-content
  // justify-content тут не потрібен, якщо вирівнювання йде через align-items батька
  
  &.hidden-attachment-cards {
    display: none;
  }
}

.attachment-card {
  background-color: var(--background-secondary);
  border: 1px solid var(--background-modifier-border);
  border-radius: var(--radius-m, 8px);
  padding: calc(var(--chat-spacing-unit, 5px) * 1.25) calc(var(--chat-spacing-unit, 5px) * 1.75);
  min-width: 90px;
  max-width: 170px; 
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: calc(var(--chat-spacing-unit, 5px) * 0.5);
  transition: box-shadow 0.2s ease-out;
  cursor: default;

  &:hover {
    box-shadow: var(--shadow-s);
  }
}

.attachment-card-name {
  font-weight: 500;
  color: var(--text-normal);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: calc(var(--font-ui-small) * 0.9); 
}

.attachment-card-meta {
  font-size: calc(var(--font-ui-smaller) * 0.85); 
  color: var(--text-muted);
}

.attachment-card-type {
  font-size: var(--font-ui-tiny, 0.6em);
  color: var(--text-faint);
  background-color: var(--background-modifier-hover);
  padding: calc(var(--chat-spacing-unit, 5px) * 0.2) calc(var(--chat-spacing-unit, 5px) * 0.6);
  border-radius: var(--radius-s);
  align-self: flex-start;
  text-transform: uppercase;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.attachment-card.image-card {
  padding: calc(var(--chat-spacing-unit, 5px) * 0.75);
}

.attachment-card-image-preview {
  width: 100%;
  height: 50px; 
  object-fit: cover;
  border-radius: var(--radius-s);
  margin-bottom: calc(var(--chat-spacing-unit, 5px) * 0.25);
}

.message { 
  @extend %base-message-bubble; 
  width: fit-content; 
  max-width: 100%;    
  margin-top: calc(var(--chat-spacing-unit, 5px) * 1); 
  
  &.message-arriving { 
    animation: message-appear 0.3s ease-out forwards;
  }

  &.empty-user-text-bubble { 
    display: none; 
  }
}

.message.user-message { 
  background-color: var(--interactive-accent);
  color: var(--text-on-accent);
  box-shadow: 0 1px 4px rgba(var(--interactive-accent-rgb), 0.2);
}
.message.ollama-message { 
  background-color: var(--background-primary-alt);
  color: var(--text-normal);
  &:hover { box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1); }
  pre {
    background-color: var(--background-secondary) !important;
    padding: calc(var(--chat-spacing-unit, 5px) * 2);
    border-radius: var(--radius-m, 6px); margin-top: calc(var(--chat-spacing-unit, 5px) * 1);
    margin-bottom: calc(var(--chat-spacing-unit, 5px) * 1); overflow-x: auto; box-sizing: border-box;
  }
}
.message.system-message { 
  background-color: var(--background-modifier-accent-hover); 
  color: var(--text-faint);
  font-style: italic;
  padding: calc(var(--chat-spacing-unit, 5px) * 1) calc(var(--chat-spacing-unit, 5px) * 2.5);
  box-shadow: none;
  text-align: center;
  // Для системних повідомлень, .message-wrapper має align-items: center
  // Тому сама бульбашка не потребує align-self, якщо .message-wrapper = system-message-group
  width: auto; 
}
.message.error-message { 
  background-color: var(--background-modifier-error); 
  color: var(--text-on-accent); 
  border: 1px solid var(--color-red-hover);
  box-shadow: 0 1px 2px var(--color-red-faint);
  .error-icon { margin-right: 8px; }
}
.message.tool-message { 
  background-color: var(--background-modifier-info-hover); 
  border: 1px solid var(--color-blue-faint);
  .tool-result-header { font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; .tool-result-icon { margin-right: 5px;} }
  .tool-result-content { background-color: var(--background-secondary); padding: 8px; border-radius: var(--radius-s); white-space: pre-wrap; }
}

.message-content-container { 
  width: 100%; box-sizing: border-box;
}
.message-content { 
  p { margin-top: 0; margin-bottom: calc(var(--p-spacing, 1em) / 2); &:last-child { margin-bottom: 0; } }
}

// Обгортка для timestamp та кнопок дій - ПІСЛЯ .message-content-area
.message-meta-actions-wrapper {
  display: flex;
  align-items: center; 
  margin-top: calc(var(--chat-spacing-unit, 5px) * 1); 
  padding: 0; 
  min-height: 20px; 
  width: 100%; 
  box-sizing: border-box;

  .user-message-group .message-wrapper & { 
    justify-content: flex-end; 
    padding-right: calc(var(--chat-spacing-unit, 5px) * 1); 
  }
  .ollama-message-group .message-wrapper & { 
    justify-content: flex-start; 
    padding-left: calc(var(--chat-spacing-unit, 5px) * 1);
  }
}

.message-timestamp { 
  font-size: 0.7em; 
  color: var(--text-faint); 
  opacity: 0.9; 
  margin: 0; 
  line-height: 1.2; 
  white-space: nowrap; 
}

.message-actions-wrapper { 
  display: flex; 
  align-items: center; 
  gap: calc(var(--chat-spacing-unit, 5px) * 1); 
  opacity: 0; 
  visibility: hidden; 
  @include transition( (opacity, visibility), 0.15s, ease-in-out );
  
  .user-message-group .message-wrapper & {
    margin-left: calc(var(--chat-spacing-unit, 5px) * 1.5); 
  }
  .ollama-message-group .message-wrapper & {
    margin-right: calc(var(--chat-spacing-unit, 5px) * 1.5); 
  }

  button.message-action-button { 
    @extend %base-action-button; 
  }
  .delete-message-button.danger-option { 
    color: var(--text-error) !important; 
    &:hover { 
        color: var(--text-on-accent) !important; 
        background-color: var(--background-modifier-error-hover) !important; 
    } 
  }
}

.message-wrapper:hover .message-actions-wrapper { 
  opacity: 1; 
  visibility: visible; 
}

.message-content-collapsible { overflow: hidden; @include transition(max-height, 0.3s, ease-out); box-sizing: border-box; }
.message-content-collapsed { mask-image: linear-gradient(to bottom, black 85%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 85%, transparent 100%); }

.regenerate-button { @extend %base-action-button; }
button.summarize-button { @extend %base-action-button; }

@keyframes message-appear { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
@media screen and (min-width: 1600px) { .ollama-chat-container { padding-left: 15%; padding-right: 15%; max-width: 3000px; } }

.scroll-to-bottom-button { position: absolute; bottom: 15px; right: 20px; z-index: 50; width: 36px; height: 36px; border-radius: 50%; background-color: var(--background-secondary); color: var(--text-muted); border: 1px solid var(--background-modifier-border); box-shadow: var(--shadow-s); cursor: pointer; @include flex-layout($align: center, $justify: center); padding: 0; opacity: 0; visibility: hidden; transform: translateY(10px); @include transition((opacity, transform, background-color), 0.2s, ease-out); .svg-icon { width: 20px; height: 20px; } &:hover { background-color: var(--background-modifier-hover); color: var(--text-normal); transform: translateY(8px) scale(1.05); } &:active { transform: translateY(9px) scale(1); } &.visible { opacity: 0.85; visibility: visible; transform: translateY(0); &:hover { opacity: 1; } } }
.new-message-indicator.visible { display: flex; align-items: center; justify-content: center; padding: 5px 10px; background-color: var(--interactive-accent); color: var(--text-on-accent); border-radius: var(--radius-l); position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); box-shadow: var(--shadow-m); cursor: pointer; opacity: 0.9; @include transition; &:hover { opacity: 1; box-shadow: var(--shadow-l); } .indicator-icon { margin-right: 5px; } }

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
.button-loading .svg-icon { animation: spin 1s linear infinite; }

.chat-date-separator { width: fit-content; max-width: 80%; margin-left: auto; margin-right: auto; margin-top: calc(var(--chat-spacing-unit, 5px) * 6); margin-bottom: calc(var(--chat-spacing-unit, 5px) * 4); padding: calc(var(--chat-spacing-unit, 5px) * 0.75) calc(var(--chat-spacing-unit, 5px) * 2.5); font-size: var(--font-ui-smaller, 0.8em); color: var(--text-muted); background-color: var(--background-secondary); border-radius: var(--radius-l, 16px); text-align: center; user-select: none; font-weight: 500; box-sizing: border-box; }
.assistant-tool-usage-indicator { font-style: italic; color: var(--text-faint); font-size: var(--font-ui-smaller, 0.8em); display: block; margin-bottom: calc(var(--chat-spacing-unit, 5px) * 0.5); }

.system-message-text { font-size: var(--font-ui-small); line-height: 1.4; }
.error-message-text { color: inherit; 
  ul { list-style-type: disc; padding-left: 20px; margin-top: 5px; }
  .error-summary-header { font-weight: bold; margin-bottom: 5px;}
}
.thinking-dots { display: flex; align-items: center; justify-content: center; height: 20px; 
  .thinking-dot { width: 6px; height: 6px; margin: 0 2px; background-color: var(--text-faint); border-radius: 50%; display: inline-block; animation: thinking-blink 1.4s infinite both;
    &:nth-child(1) { animation-delay: -0.32s; }
    &:nth-child(2) { animation-delay: -0.16s; }
  }
}
@keyframes thinking-blink { 0%, 80%, 100% { opacity: 0.3; transform: scale(0.8); } 40% { opacity: 1; transform: scale(1); } }

.submenu-content-hidden { display: none !important; }
.code-block-copy-button { position: absolute; top: 5px; right: 5px; opacity: 0; transition: opacity 0.2s; padding: 3px 6px; background-color: var(--background-modifier-hover); border-radius: var(--radius-s); cursor: pointer; &:hover { opacity: 1; background-color: var(--background-modifier-active); } pre:hover & { opacity: 0.7; } }
.code-block-language { position: absolute; top: 5px; left: 10px; font-size: var(--font-ui-smaller); color: var(--text-faint); user-select: none; }

.translation-container { border-top: 1px dashed var(--background-modifier-border); margin-top: calc(var(--chat-spacing-unit, 5px) * 2); padding-top: calc(var(--chat-spacing-unit, 5px) * 1.5); .translation-indicator { font-size: var(--font-ui-smaller); color: var(--text-faint); font-style: italic; margin-top: calc(var(--chat-spacing-unit, 5px) * 0.5); } }
.translation-content { p:last-child { margin-bottom: 0; } }
.translation-pending { /* Залишаємо як коментар, якщо тут немає специфічних стилів */ }
.recording { color: var(--color-red) !important; }

.thinking-block { margin-top: 8px; border: 1px solid var(--background-modifier-border); border-radius: var(--radius-m); overflow: hidden;
  .thinking-header { background-color: var(--background-secondary); padding: 6px 10px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none;
    .thinking-title { font-weight: 500; font-size: var(--font-ui-small); }
    .thinking-toggle { .svg-icon { transition: transform 0.2s; } &.is-collapsed .svg-icon { transform: rotate(-90deg); } }
  }
  .thinking-content { padding: 10px; background-color: var(--background-primary); font-size: var(--font-ui-smaller); max-height: 200px; overflow-y: auto; transition: max-height 0.3s ease-out, padding 0.3s ease-out; &.is-collapsed { max-height: 0; padding-top: 0; padding-bottom: 0; overflow: hidden; } }
}